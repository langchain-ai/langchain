# v1.1_改动6_ 内容审核中间件_免费api_OpenAIModerationMiddleware


## 某个模型厂商的专有中间件，会放在专有包里面 langchain_openai

**参数说明：**

- **model**  
  类型：`ModerationModel`  
  默认值：`"omni-moderation-latest"`  
  说明：使用的 OpenAI 审核模型。  
  可选项：  
    - `'omni-moderation-latest'`  
    - `'omni-moderation-2024-09-26'`  
    - `'text-moderation-latest'`  
    - `'text-moderation-stable'`

- **check_input**  
  类型：`bool`  
  默认值：`True`  
  说明：是否在调用模型前检查用户输入消息。

- **check_output**  
  类型：`bool`  
  默认值：`True`  
  说明：是否在调用模型后检查模型输出消息。

- **check_tool_results**  
  类型：`bool`  
  默认值：`False`  
  说明：是否在调用模型前检查工具结果消息。

- **exit_behavior**  
  类型：`str`  
  默认值：`"end"`  
  说明：当内容被标记为违规时如何处理。  
  可选项：  
    - `'end'`：立即结束智能体执行并显示违规消息  
    - `'error'`：抛出 `OpenAIModerationError` 异常  
    - `'replace'`：用违规信息替换标记内容并继续

- **violation_message**  
  类型：`str | None`  
  说明：自定义违规信息模板。支持以下模板变量：  
    - `{categories}`：以逗号分隔的已标记类别列表  
    - `{category_scores}`：类别分数的 JSON 字符串  
    - `{original_content}`：原始已标记内容  
  默认值：`"I'm sorry, but I can't comply with that request. It was flagged for {categories}."`

- **client**  
  类型：`OpenAI | None`  
  说明：可选的预配置 OpenAI 客户端（复用），如未提供则会自动创建一个新的客户端。

- **async_client**  
  类型：`AsyncOpenAI | None`  
  说明：可选的预配置异步 OpenAI 客户端，如未提供则会自动创建一个新的异步客户端。

该中间件集成了 OpenAI 的内容审核接口，可在多个阶段对内容进行审核：

**审核阶段：**
- `check_input`：在调用模型前审核用户输入
- `check_output`：在调用模型后审核 AI 输出
- `check_tool_results`：在调用模型前审核工具输出

**违规内容处理方式（exit_behavior）：**
- `'end'`（默认）：检测到违规时，返回违规消息并终止执行
- `'error'`：检测到违规时，抛出异常供应用处理
- `'replace'`：检测到违规时，将内容替换为指定提醒后继续流程


```py
from langchain_openai import ChatOpenAI
from langchain_openai.middleware import OpenAIModerationMiddleware
from langchain.agents import create_agent

# 假设你已经有了一些工具，比如 search_tool, customer_data_tool
# 这些是你希望在 agent 中提供给用户的工具

# 1. 基础内容审核: 对输入/输出进行内容审核，如果检测到违规则阻止
agent = create_agent(
    model=ChatOpenAI(model="gpt-4o"),
    tools=[search_tool, customer_data_tool],
    middleware=[
        OpenAIModerationMiddleware(
            model="omni-moderation-latest",   # 使用的审核模型
            check_input=True,                 # 启用输入内容审核
            check_output=True,                # 启用输出内容审核
        ),
    ],
)
# 这里 agent 在每次输入和输出时，都会先进行内容安全审核，只要有违规就会直接中断

# 2. 严格内容审核: 更严格的模式，并自定义违规提示信息
agent_strict = create_agent(
    model=ChatOpenAI(model="gpt-4o"),
    tools=[search_tool, customer_data_tool],
    middleware=[
        OpenAIModerationMiddleware(
            model="omni-moderation-latest",
            check_input=True,                  # 检查用户输入
            check_output=True,                 # 检查 agent 回复
            check_tool_results=True,           # 检查工具返回的内容
            exit_behavior="error",             # 检测到违规时直接抛出错误(终止流程)
            violation_message=(
                "Content policy violation detected: {categories}. "  # {categories} 会被自动替换为实际违规类型
                "Please rephrase your request."
            ),
        ),
    ],
)
# 此配置会对所有流转内容都做审核，并且一旦有违规会直接 error，给出自定义错误消息

# 3. 替换模式内容审核: 检查输入，违规时用特定内容替换
agent_replace = create_agent(
    model=ChatOpenAI(model="gpt-4o"),
    tools=[search_tool],
    middleware=[
        OpenAIModerationMiddleware(
            check_input=True,                              # 只审核输入内容
            exit_behavior="replace",                       # 违规时替换为 violation_message
            violation_message="[Content removed due to safety policies]",  # 替换内容
        ),
    ],
)
# 上述配置会在检测到用户输入违规时, 用 violation_message 文案替换用户输入，防止模型生成潜在违规信息

# 说明:
# - OpenAIModerationMiddleware 适用于对 agent 用户输入、输出、甚至工具结果进行灵活且强力的内容安全审核。
# - 可根据实际业务风控等级，灵活选择 "error" (终止+报错) 或 "replace" (违规信息替换) 等 exit_behavior。
# - violation_message 支持自定义，并可在消息中插入 {categories} 占位符，动态显示实际违规类型。

```