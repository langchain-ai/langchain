
# wrap_tool_call é«˜çº§æ¨¡å¼æ·±åº¦è§£æ

## æ¨¡å¼ 1: é‡è¯•é€»è¾‘ (Retry Logic)

### å·¥ä½œåŸç†

å½“å·¥å…·æ‰§è¡Œå¤±è´¥æ—¶ï¼Œè‡ªåŠ¨é‡è¯•å¤šæ¬¡ï¼Œç›´åˆ°æˆåŠŸæˆ–è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°ã€‚

### å®Œæ•´æµç¨‹å›¾

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              é‡è¯•é€»è¾‘æ¨¡å¼æµç¨‹                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                â”‚  wrap_tool_call  â”‚
                                â”‚  retry_middlewareâ”‚
                                â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                         â”‚
                                         â–¼
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚  æ¥æ”¶ ToolCallRequest          â”‚
                        â”‚                                â”‚
                        â”‚  request.tool_call = {         â”‚
                        â”‚    "name": "failing_tool",     â”‚
                        â”‚    "args": {"input": "test"},  â”‚
                        â”‚    "id": "call_1"              â”‚
                        â”‚  }                             â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚  for attempt in range(max_retries):  # 0, 1, 2    â”‚
            â”‚      attempt_counts.append(attempt)                â”‚
            â”‚      try:                                          â”‚
            â”‚          return handler(request)  â† å°è¯•æ‰§è¡Œå·¥å…·   â”‚
            â”‚      except Exception as e:                        â”‚
            â”‚          last_error = e                            â”‚
            â”‚          if attempt == max_retries - 1:            â”‚
            â”‚              return error_message                  â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                        â”‚                        â”‚
        â–¼ ç¬¬1æ¬¡å°è¯•             â–¼ ç¬¬2æ¬¡å°è¯•             â–¼ ç¬¬3æ¬¡å°è¯•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ handler(request)â”‚    â”‚ handler(request)â”‚    â”‚ handler(request)â”‚
â”‚       â”‚         â”‚    â”‚       â”‚         â”‚    â”‚       â”‚         â”‚
â”‚       â–¼         â”‚    â”‚       â–¼         â”‚    â”‚       â–¼         â”‚
â”‚  æŠ›å‡ºå¼‚å¸¸       â”‚    â”‚  æŠ›å‡ºå¼‚å¸¸       â”‚    â”‚  æŠ›å‡ºå¼‚å¸¸       â”‚
â”‚  ValueError     â”‚    â”‚  ValueError     â”‚    â”‚  ValueError     â”‚
â”‚       â”‚         â”‚    â”‚       â”‚         â”‚    â”‚       â”‚         â”‚
â”‚       â–¼         â”‚    â”‚       â–¼         â”‚    â”‚       â–¼         â”‚
â”‚  æ•è·å¼‚å¸¸       â”‚    â”‚  æ•è·å¼‚å¸¸       â”‚    â”‚  æœ€åä¸€æ¬¡       â”‚
â”‚  ç»§ç»­å¾ªç¯       â”‚    â”‚  ç»§ç»­å¾ªç¯       â”‚    â”‚  è¿”å›é”™è¯¯æ¶ˆæ¯   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                        â”‚
                                                        â–¼
                                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                            â”‚  return ToolMessage(     â”‚
                                            â”‚    content="Error after  â”‚
                                            â”‚      3 attempts: ...",   â”‚
                                            â”‚    status="error"        â”‚
                                            â”‚  )                       â”‚
                                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æºç å®ç° (test_wrap_tool_call.py ç¬¬ 215-271 è¡Œ)

```python
@wrap_tool_call
def retry_middleware(request: ToolCallRequest, handler: Callable) -> ToolMessage | Command:
    max_retries = 3
    last_error = None

    for attempt in range(max_retries):
        attempt_counts.append(attempt)  # è®°å½•å°è¯•æ¬¡æ•°
        try:
            return handler(request)  # å°è¯•æ‰§è¡Œå·¥å…·
        except Exception as e:
            last_error = e
            if attempt == max_retries - 1:
                # æœ€åä¸€æ¬¡å¤±è´¥ï¼Œè¿”å›é”™è¯¯æ¶ˆæ¯
                return ToolMessage(
                    content=f"Error after {max_retries} attempts: {str(last_error)}",
                    tool_call_id=request.tool_call["id"],
                    name=request.tool_call["name"],
                    status="error",
                )
            # ç»§ç»­é‡è¯•
```

### æ•°æ®æµè½¬

```text
è¯·æ±‚æ•°æ®:
â”€â”€â”€â”€â”€â”€â”€â”€â”€
request.tool_call = {
    "name": "failing_tool",
    "args": {"input": "test"},
    "id": "call_1"
}

æ‰§è¡Œè¿‡ç¨‹:
â”€â”€â”€â”€â”€â”€â”€â”€â”€
Attempt 0: handler(request) â†’ ValueError("Failed: test") â†’ æ•è·ï¼Œç»§ç»­
Attempt 1: handler(request) â†’ ValueError("Failed: test") â†’ æ•è·ï¼Œç»§ç»­
Attempt 2: handler(request) â†’ ValueError("Failed: test") â†’ æœ€åä¸€æ¬¡ï¼Œè¿”å›é”™è¯¯

è¿”å›æ•°æ®:
â”€â”€â”€â”€â”€â”€â”€â”€â”€
ToolMessage(
    content="Error after 3 attempts: Failed: test",
    tool_call_id="call_1",
    name="failing_tool",
    status="error"
)
```

### ä½¿ç”¨åœºæ™¯

- ç½‘ç»œè¯·æ±‚å¯èƒ½è¶…æ—¶
- å¤–éƒ¨ API ä¸ç¨³å®š
- æ•°æ®åº“è¿æ¥å¶å°”å¤±è´¥
- èµ„æºæš‚æ—¶ä¸å¯ç”¨

---

## æ¨¡å¼ 2: çŸ­è·¯ (Short Circuit)

### å·¥ä½œåŸç†

ä¸å®é™…æ‰§è¡Œå·¥å…·ï¼Œç›´æ¥è¿”å›é¢„å®šä¹‰çš„å“åº”ã€‚**handler æ ¹æœ¬ä¸ä¼šè¢«è°ƒç”¨**ã€‚

### å®Œæ•´æµç¨‹å›¾

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              çŸ­è·¯æ¨¡å¼æµç¨‹                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                â”‚  wrap_tool_call  â”‚
                                â”‚  short_circuit   â”‚
                                â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                         â”‚
                                         â–¼
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚  æ¥æ”¶ ToolCallRequest          â”‚
                        â”‚                                â”‚
                        â”‚  request.tool_call = {         â”‚
                        â”‚    "name": "search",           â”‚
                        â”‚    "args": {"query": "test"},  â”‚
                        â”‚    "id": "call_1"              â”‚
                        â”‚  }                             â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  åˆ¤æ–­æ˜¯å¦éœ€è¦çŸ­è·¯          â”‚
                    â”‚  (å¯åŸºäºæ¡ä»¶åˆ¤æ–­)          â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚  âŒ ä¸è°ƒç”¨ handler(request)             â”‚
            â”‚  âœ… ç›´æ¥è¿”å›é¢„å®šä¹‰çš„ ToolMessage       â”‚
            â”‚                                        â”‚
            â”‚  return ToolMessage(                   â”‚
            â”‚      content="short_circuit_result",   â”‚
            â”‚      tool_call_id=request.tool_call["id"],
            â”‚      name=request.tool_call["name"]    â”‚
            â”‚  )                                     â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  å®é™…å·¥å…·å‡½æ•° search() æ°¸è¿œä¸ä¼šè¢«è°ƒç”¨   â”‚
        â”‚  èŠ‚çœæ—¶é—´å’Œèµ„æº                          â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


å¯¹æ¯”ï¼šæ­£å¸¸æµç¨‹ vs çŸ­è·¯æµç¨‹
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

æ­£å¸¸æµç¨‹:                                çŸ­è·¯æµç¨‹:
â”€â”€â”€â”€â”€â”€â”€â”€â”€                               â”€â”€â”€â”€â”€â”€â”€â”€â”€

wrap_tool_call                          wrap_tool_call
      â”‚                                       â”‚
      â”œâ”€ handler(request)                     â”œâ”€ åˆ¤æ–­æ¡ä»¶
      â”‚      â”‚                                â”‚      â”‚
      â”‚      â–¼                                â”‚      â–¼
      â”‚  è°ƒç”¨å®é™…å·¥å…·                          â”‚  æ»¡è¶³çŸ­è·¯æ¡ä»¶
      â”‚  search(query="test")                  â”‚      â”‚
      â”‚      â”‚                                â”‚      â–¼
      â”‚      â–¼                                â”‚  ç›´æ¥è¿”å›ç»“æœ
      â”‚  æ‰§è¡Œæœç´¢é€»è¾‘                          â”‚  (ä¸è°ƒç”¨ handler)
      â”‚  return "Results..."                   â”‚      â”‚
      â”‚      â”‚                                â”‚      â–¼
      â”‚      â–¼                                â”‚  return ToolMessage(...)
      â–¼  return ToolMessage(...)               â–¼
  è¿”å›ç»“æœ                                    è¿”å›ç»“æœ

è€—æ—¶: ~500ms                                è€—æ—¶: ~1ms
```

### æºç å®ç° (test_wrap_tool_call.py ç¬¬ 273-311 è¡Œ)

```python
@wrap_tool_call
def short_circuit(request: ToolCallRequest, handler: Callable) -> ToolMessage | Command:
    # ä¸è°ƒç”¨ handlerï¼Œç›´æ¥è¿”å›è‡ªå®šä¹‰å“åº”
    handler_called.append(False)  # è®°å½• handler æœªè¢«è°ƒç”¨

    return ToolMessage(
        content="short_circuit_result",
        tool_call_id=request.tool_call["id"],
        name=request.tool_call["name"],
    )
    # handler(request) æ°¸è¿œä¸ä¼šè¢«è°ƒç”¨ï¼
```

### æ•°æ®æµè½¬

```text
è¯·æ±‚æ•°æ®:
â”€â”€â”€â”€â”€â”€â”€â”€â”€
request = {
    "tool_call": {"name": "search", "args": {"query": "test"}, "id": "call_1"},
    "tool": <search å·¥å…·å®ä¾‹>,
    "state": {...},
    "runtime": <ToolRuntime>
}

çŸ­è·¯å†³ç­–:
â”€â”€â”€â”€â”€â”€â”€â”€â”€
if should_short_circuit(request):  # å¯ä»¥åŸºäºä»»ä½•æ¡ä»¶
    return ToolMessage(content="cached_or_mocked_result", ...)
else:
    return handler(request)  # æ­£å¸¸æ‰§è¡Œ

è¿”å›æ•°æ®:
â”€â”€â”€â”€â”€â”€â”€â”€â”€
ToolMessage(
    content="short_circuit_result",  â† ä¸æ˜¯å®é™…å·¥å…·è¿”å›çš„ç»“æœ
    tool_call_id="call_1",
    name="search"
)
```

### ä½¿ç”¨åœºæ™¯

- **æµ‹è¯•/å¼€å‘**: Mock å·¥å…·æ‰§è¡Œï¼Œä¸è°ƒç”¨å®é™… API
- **ç¼“å­˜å‘½ä¸­**: å·²æœ‰ç¼“å­˜ç»“æœï¼Œæ— éœ€é‡å¤æ‰§è¡Œ
- **æ¡ä»¶è·³è¿‡**: æŸäº›æ¡ä»¶ä¸‹ä¸æ‰§è¡Œå·¥å…·
- **é™çº§**: å·¥å…·ä¸å¯ç”¨æ—¶è¿”å›é»˜è®¤å€¼

---

## æ¨¡å¼ 3: å“åº”ä¿®æ”¹ (Response Modification)

### å·¥ä½œåŸç†

æ‰§è¡Œå·¥å…·åï¼Œä¿®æ”¹/å¢å¼º/è¿‡æ»¤å·¥å…·è¿”å›çš„ç»“æœå†ä¼ ç»™ LLMã€‚

### å®Œæ•´æµç¨‹å›¾

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              å“åº”ä¿®æ”¹æ¨¡å¼æµç¨‹                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                â”‚  wrap_tool_call  â”‚
                                â”‚ modify_response  â”‚
                                â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                         â”‚
                                         â–¼
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚  æ¥æ”¶ ToolCallRequest          â”‚
                        â”‚                                â”‚
                        â”‚  request.tool_call = {         â”‚
                        â”‚    "name": "search",           â”‚
                        â”‚    "args": {"query": "test"}   â”‚
                        â”‚  }                             â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  è°ƒç”¨ handler(request)     â”‚
                    â”‚  æ‰§è¡Œå®é™…å·¥å…·              â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚  å®é™…å·¥å…·æ‰§è¡Œ                          â”‚
            â”‚                                        â”‚
            â”‚  search(query="test")                  â”‚
            â”‚      â”‚                                 â”‚
            â”‚      â–¼                                 â”‚
            â”‚  return "Results for: test"            â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  handler è¿”å› ToolMessage:                   â”‚
        â”‚                                              â”‚
        â”‚  ToolMessage(                                â”‚
        â”‚      content="Results for: test",            â”‚
        â”‚      tool_call_id="call_1",                  â”‚
        â”‚      name="search"                           â”‚
        â”‚  )                                           â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  ğŸ”§ ä¿®æ”¹å“åº”å†…å®¹                                   â”‚
    â”‚                                                    â”‚
    â”‚  if isinstance(response, ToolMessage):             â”‚
    â”‚      modified = ToolMessage(                       â”‚
    â”‚          content=f"MODIFIED: {response.content}",  â”‚
    â”‚          tool_call_id=response.tool_call_id,       â”‚
    â”‚          name=response.name                        â”‚
    â”‚      )                                             â”‚
    â”‚      return modified                               â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è¿”å›ä¿®æ”¹åçš„ ToolMessage:                   â”‚
â”‚                                              â”‚
â”‚  ToolMessage(                                â”‚
â”‚      content="MODIFIED: Results for: test",  â”‚ â† å·²ä¿®æ”¹
â”‚      tool_call_id="call_1",                  â”‚
â”‚      name="search"                           â”‚
â”‚  )                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  LLM æ¥æ”¶ä¿®æ”¹åçš„  â”‚
        â”‚  å·¥å…·ç»“æœ          â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æºç å®ç° (test_wrap_tool_call.py ç¬¬ 313-352 è¡Œ)

```python
@wrap_tool_call
def modify_response(request: ToolCallRequest, handler: Callable) -> ToolMessage | Command:
    # å…ˆæ‰§è¡Œå·¥å…·
    response = handler(request)

    # ä¿®æ”¹å“åº”å†…å®¹
    if isinstance(response, ToolMessage):
        modified = ToolMessage(
            content=f"MODIFIED: {response.content}",  # æ·»åŠ å‰ç¼€
            tool_call_id=response.tool_call_id,
            name=response.name,
        )
        return modified
    return response
```

### ä¿®æ”¹ç±»å‹ç¤ºä¾‹

```python
# 1. æ·»åŠ å‰ç¼€/åç¼€
content=f"MODIFIED: {response.content}"

# 2. è¿‡æ»¤æ•æ„Ÿä¿¡æ¯
content=redact_sensitive_data(response.content)

# 3. æ ¼å¼åŒ–
content=format_as_markdown(response.content)

# 4. æˆªæ–­è¿‡é•¿å†…å®¹
content=response.content[:1000] + "..." if len(response.content) > 1000 else response.content

# 5. æ·»åŠ å…ƒæ•°æ®
modified = ToolMessage(
    content=response.content,
    artifact={"original_length": len(response.content), "timestamp": time.time()},
    ...
)

# 6. é”™è¯¯è½¬æ¢
if "error" in response.content.lower():
    return ToolMessage(content="å·¥å…·æ‰§è¡Œå¤±è´¥ï¼Œè¯·é‡è¯•", status="error", ...)
```

### ä½¿ç”¨åœºæ™¯

- **æ ¼å¼åŒ–**: ç»Ÿä¸€æ ¼å¼åŒ–æ‰€æœ‰å·¥å…·è¾“å‡º
- **è„±æ•**: ç§»é™¤æ•æ„Ÿä¿¡æ¯
- **å¢å¼º**: æ·»åŠ é¢å¤–ä¸Šä¸‹æ–‡æˆ–å…ƒæ•°æ®
- **æˆªæ–­**: é™åˆ¶è¿”å›å†…å®¹é•¿åº¦
- **ç¿»è¯‘**: è½¬æ¢è¾“å‡ºè¯­è¨€
- **æ—¥å¿—**: è®°å½•åŸå§‹è¾“å‡º

---

## æ¨¡å¼ 4: ç¼“å­˜æ¨¡å¼ (Caching Pattern)

### å·¥ä½œåŸç†

ç›¸åŒçš„å·¥å…·è°ƒç”¨å‚æ•°å‘½ä¸­ç¼“å­˜æ—¶ï¼Œç›´æ¥è¿”å›ç¼“å­˜ç»“æœï¼Œä¸æ‰§è¡Œå®é™…å·¥å…·ã€‚

### å®Œæ•´æµç¨‹å›¾

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              ç¼“å­˜æ¨¡å¼æµç¨‹                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                â”‚  wrap_tool_call  â”‚
                                â”‚   with_cache     â”‚
                                â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                         â”‚
                                         â–¼
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚  æ¥æ”¶ ToolCallRequest          â”‚
                        â”‚                                â”‚
                        â”‚  request.tool_call = {         â”‚
                        â”‚    "name": "search",           â”‚
                        â”‚    "args": {"query": "test"}   â”‚
                        â”‚  }                             â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚  ç”Ÿæˆç¼“å­˜é”®                                â”‚
            â”‚                                            â”‚
            â”‚  cache_key = (                             â”‚
            â”‚      request.tool.name,                    â”‚
            â”‚      str(request.tool_call["args"])        â”‚
            â”‚  )                                         â”‚
            â”‚  # ("search", "{'query': 'test'}")        â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  æ£€æŸ¥ç¼“å­˜                  â”‚
        â”‚  if cache_key in cache:    â”‚
        â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”˜
             â”‚                   â”‚
     âœ… ç¼“å­˜å‘½ä¸­            âŒ ç¼“å­˜æœªå‘½ä¸­
             â”‚                   â”‚
             â–¼                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“¦ ä»ç¼“å­˜è¿”å›        â”‚  â”‚  ğŸ”§ æ‰§è¡Œå·¥å…·                â”‚
â”‚                      â”‚  â”‚                             â”‚
â”‚  return ToolMessage( â”‚  â”‚  handler_calls.append("æ‰§è¡Œ")â”‚
â”‚    content=cache[key]â”‚  â”‚  response = handler(request)â”‚
â”‚    ...               â”‚  â”‚      â”‚                       â”‚
â”‚  )                   â”‚  â”‚      â–¼                       â”‚
â”‚                      â”‚  â”‚  search(query="test")        â”‚
â”‚  âš¡ï¸ éå¸¸å¿«é€Ÿ!        â”‚  â”‚  return "Results..."         â”‚
â”‚  ä¸è°ƒç”¨å®é™…å·¥å…·      â”‚  â”‚      â”‚                       â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚      â–¼                       â”‚
       â”‚                  â”‚  ç¼“å­˜ç»“æœ                     â”‚
       â”‚                  â”‚  cache[cache_key] =           â”‚
       â”‚                  â”‚      response.content         â”‚
       â”‚                  â”‚      â”‚                       â”‚
       â”‚                  â”‚      â–¼                       â”‚
       â”‚                  â”‚  return response             â”‚
       â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                            â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  è¿”å› ToolMessage         â”‚
        â”‚                          â”‚
        â”‚  ç¬¬ä¸€æ¬¡: å·¥å…·ç»“æœ         â”‚
        â”‚  ç¬¬äºŒæ¬¡: ç¼“å­˜ç»“æœ (ç›¸åŒ)  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


å®é™…æ‰§è¡Œç¤ºä¾‹:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

ç¬¬ä¸€æ¬¡è°ƒç”¨ search(query="test"):
  â””â”€ cache_key = ("search", "{'query': 'test'}")
  â””â”€ ç¼“å­˜æœªå‘½ä¸­ â†’ handler_calls.append("executed")
  â””â”€ æ‰§è¡Œå·¥å…· â†’ "Results for: test"
  â””â”€ cache[cache_key] = "Results for: test"
  â””â”€ è¿”å› ToolMessage(content="Results for: test", ...)

ç¬¬äºŒæ¬¡è°ƒç”¨ search(query="test"):  â† ç›¸åŒå‚æ•°ï¼
  â””â”€ cache_key = ("search", "{'query': 'test'}")
  â””â”€ ç¼“å­˜å‘½ä¸­! âœ…
  â””â”€ ç›´æ¥è¿”å› ToolMessage(content="Results for: test", ...)
  â””â”€ handler æœªè¢«è°ƒç”¨ (èŠ‚çœæ—¶é—´)
```

### æºç å®ç° (test_wrap_tool_call.py ç¬¬ 709-762 è¡Œ)

```python
cache = {}  # ç¼“å­˜å­˜å‚¨
handler_calls = []  # è·Ÿè¸ªå®é™…è°ƒç”¨

@wrap_tool_call
def with_cache(request: ToolCallRequest, handler: Callable) -> ToolMessage | Command:
    # ç”Ÿæˆç¼“å­˜é”®
    cache_key = (request.tool.name, str(request.tool_call["args"]))

    # æ£€æŸ¥ç¼“å­˜
    if cache_key in cache:
        # ç¼“å­˜å‘½ä¸­ï¼Œç›´æ¥è¿”å›
        return ToolMessage(
            content=cache[cache_key],
            tool_call_id=request.tool_call["id"],
            name=request.tool_call["name"],
        )

    # ç¼“å­˜æœªå‘½ä¸­ï¼Œæ‰§è¡Œå·¥å…·
    handler_calls.append("executed")
    response = handler(request)

    # ç¼“å­˜ç»“æœ
    if isinstance(response, ToolMessage):
        cache[cache_key] = response.content

    return response
```

### æ•°æ®æµè½¬

```text
ç¬¬ä¸€æ¬¡è°ƒç”¨:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Input:  {"query": "test"}
Cache:  {} (ç©º)
Action: æ‰§è¡Œ handler â†’ search() â†’ "Results for: test"
Cache:  {("search", "{'query': 'test'}"): "Results for: test"}
Output: ToolMessage(content="Results for: test", ...)
Time:   500ms

ç¬¬äºŒæ¬¡è°ƒç”¨:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Input:  {"query": "test"}  â† ç›¸åŒå‚æ•°
Cache:  {("search", "{'query': 'test'}"): "Results for: test"}  â† æœ‰ç¼“å­˜
Action: ç¼“å­˜å‘½ä¸­ï¼è¿”å›ç¼“å­˜å€¼
Cache:  ä¸å˜
Output: ToolMessage(content="Results for: test", ...)  â† ç›¸åŒç»“æœ
Time:   1ms  â† å¿« 500 å€ï¼
```

### ä½¿ç”¨åœºæ™¯

- **æ˜‚è´µçš„ API è°ƒç”¨**: é¿å…é‡å¤è°ƒç”¨ä»˜è´¹ API
- **æ…¢é€Ÿæ“ä½œ**: æ•°æ®åº“æŸ¥è¯¢ã€å¤§æ–‡ä»¶å¤„ç†
- **é™æ€æ•°æ®**: ä¸ç»å¸¸å˜åŒ–çš„æ•°æ®æŸ¥è¯¢
- **å¼€å‘è°ƒè¯•**: é¿å…é‡å¤è°ƒç”¨å¤–éƒ¨æœåŠ¡

---

## æ¨¡å¼ 5: ç›‘æ§æ¨¡å¼ (Monitoring Pattern)

### å·¥ä½œåŸç†

åœ¨å·¥å…·æ‰§è¡Œå‰åè®°å½•æŒ‡æ ‡ï¼Œå¦‚æ‰§è¡Œæ—¶é—´ã€æˆåŠŸç‡ã€å‚æ•°ç­‰ï¼Œä¸å½±å“å·¥å…·æ‰§è¡Œã€‚

### å®Œæ•´æµç¨‹å›¾

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              ç›‘æ§æ¨¡å¼æµç¨‹                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                â”‚  wrap_tool_call  â”‚
                                â”‚monitor_execution â”‚
                                â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                         â”‚
                                         â–¼
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚  æ¥æ”¶ ToolCallRequest          â”‚
                        â”‚                                â”‚
                        â”‚  æå–ç›‘æ§æ•°æ®:                 â”‚
                        â”‚  - tool_name                   â”‚
                        â”‚  - args                        â”‚
                        â”‚  - tool_call_id                â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  ğŸ“Š å¼€å§‹ç›‘æ§                â”‚
                    â”‚                            â”‚
                    â”‚  start_time = time.time()  â”‚
                    â”‚  log("Starting: search")   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚  æ‰§è¡Œå·¥å…·                          â”‚
            â”‚                                    â”‚
            â”‚  response = handler(request)       â”‚
            â”‚      â”‚                              â”‚
            â”‚      â–¼                              â”‚
            â”‚  å®é™…å·¥å…·æ‰§è¡Œ...                   â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  ğŸ“Š ç»“æŸç›‘æ§                             â”‚
        â”‚                                          â”‚
        â”‚  end_time = time.time()                  â”‚
        â”‚  execution_time = end_time - start_time  â”‚
        â”‚  log("Completed: search, 0.5s")          â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  ğŸ“ˆ è®°å½•æŒ‡æ ‡                                   â”‚
    â”‚                                                â”‚
    â”‚  metrics.append({                              â”‚
    â”‚      "tool": "search",                         â”‚
    â”‚      "execution_time": 0.5,                    â”‚
    â”‚      "success": True,                          â”‚
    â”‚      "args": {"query": "test"},                â”‚
    â”‚      "timestamp": "2025-12-09T10:30:00"        â”‚
    â”‚  })                                            â”‚
    â”‚                                                â”‚
    â”‚  ğŸ’¾ å¯é€‰ï¼šä¿å­˜åˆ° store                         â”‚
    â”‚  if request.runtime.store:                     â”‚
    â”‚      request.runtime.store.mset([              â”‚
    â”‚          (f"metrics:{tool_name}", {...})       â”‚
    â”‚      ])                                        â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âœ… åŸæ ·è¿”å› response                        â”‚
â”‚                                              â”‚
â”‚  return response  â† ä¸ä¿®æ”¹ç»“æœ               â”‚
â”‚                                              â”‚
â”‚  ç›‘æ§æ˜¯"æ—è·¯"æ“ä½œï¼Œä¸å½±å“ä¸»æµç¨‹              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


ç›‘æ§æ•°æ®æ”¶é›†:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   æŒ‡æ ‡ç±»å‹      â”‚             æ”¶é›†çš„æ•°æ®                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ€§èƒ½æŒ‡æ ‡        â”‚ - execution_time: æ‰§è¡Œè€—æ—¶                   â”‚
â”‚                 â”‚ - start_time / end_time: å¼€å§‹/ç»“æŸæ—¶é—´æˆ³     â”‚
â”‚                 â”‚                                              â”‚
â”‚ æˆåŠŸç‡æŒ‡æ ‡      â”‚ - success: æ˜¯å¦æˆåŠŸ (true/false)             â”‚
â”‚                 â”‚ - error_type: é”™è¯¯ç±»å‹ (å¦‚æœ‰)                â”‚
â”‚                 â”‚                                              â”‚
â”‚ è°ƒç”¨æŒ‡æ ‡        â”‚ - tool_name: å·¥å…·åç§°                        â”‚
â”‚                 â”‚ - args: è°ƒç”¨å‚æ•°                             â”‚
â”‚                 â”‚ - tool_call_id: è°ƒç”¨ ID                      â”‚
â”‚                 â”‚                                              â”‚
â”‚ çŠ¶æ€æŒ‡æ ‡        â”‚ - state: Agent å½“å‰çŠ¶æ€                      â”‚
â”‚                 â”‚ - message_count: æ¶ˆæ¯æ•°é‡                    â”‚
â”‚                 â”‚                                              â”‚
â”‚ è‡ªå®šä¹‰æŒ‡æ ‡      â”‚ - user_id: ç”¨æˆ·æ ‡è¯† (ä» state æå–)          â”‚
â”‚                 â”‚ - session_id: ä¼šè¯æ ‡è¯†                       â”‚
â”‚                 â”‚ - any_custom_metric: ä»»æ„è‡ªå®šä¹‰æ•°æ®          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æºç å®ç° (test_wrap_tool_call.py ç¬¬ 764-811 è¡Œ)

```python
metrics = []  # æŒ‡æ ‡å­˜å‚¨

@wrap_tool_call
def monitor_execution(request: ToolCallRequest, handler: Callable) -> ToolMessage | Command:
    import time

    # è®°å½•å¼€å§‹æ—¶é—´
    start_time = time.time()

    # æ‰§è¡Œå·¥å…·
    response = handler(request)

    # è®°å½•ç»“æŸæ—¶é—´
    execution_time = time.time() - start_time

    # æ”¶é›†æŒ‡æ ‡
    metrics.append({
        "tool": request.tool.name,
        "execution_time": execution_time,
        "success": isinstance(response, ToolMessage)
                   and not response.content.startswith("Error:"),
    })

    # åŸæ ·è¿”å›ç»“æœï¼ˆä¸ä¿®æ”¹ï¼‰
    return response
```

### å¢å¼ºç‰ˆç›‘æ§ç¤ºä¾‹

```python
@wrap_tool_call
def advanced_monitor(request: ToolCallRequest, handler: Callable) -> ToolMessage | Command:
    import time

    # æå–å…ƒæ•°æ®
    tool_name = request.tool.name
    args = request.tool_call["args"]
    user_id = request.state.get("user_id", "unknown")

    # å¼€å§‹ç›‘æ§
    start_time = time.time()
    print(f"[{time.strftime('%H:%M:%S')}] å¼€å§‹æ‰§è¡Œ: {tool_name}")
    print(f"  å‚æ•°: {args}")
    print(f"  ç”¨æˆ·: {user_id}")

    error = None
    try:
        response = handler(request)
    except Exception as e:
        error = e
        raise
    finally:
        # æ— è®ºæˆåŠŸå¤±è´¥éƒ½è®°å½•
        end_time = time.time()
        elapsed = end_time - start_time

        metric = {
            "tool": tool_name,
            "args": args,
            "user_id": user_id,
            "execution_time": elapsed,
            "timestamp": start_time,
            "success": error is None,
            "error": str(error) if error else None,
        }

        # è®°å½•åˆ°å†…å­˜
        metrics.append(metric)

        # ä¿å­˜åˆ° storeï¼ˆæŒä¹…åŒ–ï¼‰
        if request.runtime and request.runtime.store:
            request.runtime.store.mset([
                (f"tool_metrics:{tool_name}:{int(start_time)}", metric)
            ])

        # æ—¥å¿—
        status = "âœ… æˆåŠŸ" if error is None else f"âŒ å¤±è´¥: {error}"
        print(f"[{time.strftime('%H:%M:%S')}] å®Œæˆ: {tool_name} - {status} ({elapsed:.3f}s)")

    return response
```

### ä½¿ç”¨åœºæ™¯

- **æ€§èƒ½åˆ†æ**: æ‰¾å‡ºæ…¢é€Ÿå·¥å…·
- **ä½¿ç”¨ç»Ÿè®¡**: å“ªäº›å·¥å…·æœ€å¸¸ç”¨
- **é”™è¯¯è¿½è¸ª**: å“ªäº›å·¥å…·ç»å¸¸å¤±è´¥
- **å®¡è®¡æ—¥å¿—**: è®°å½•æ‰€æœ‰å·¥å…·è°ƒç”¨
- **å®æ—¶ç›‘æ§**: è¿æ¥åˆ°ç›‘æ§ç³»ç»Ÿï¼ˆPrometheusã€Datadogï¼‰
- **æˆæœ¬è·Ÿè¸ª**: è·Ÿè¸ª API è°ƒç”¨è´¹ç”¨

---

## æ¨¡å¼å¯¹æ¯”æ€»ç»“

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              5 ç§æ¨¡å¼å¯¹æ¯”                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ¨¡å¼  â”‚ handlerè°ƒç”¨ â”‚   ä¿®æ”¹è¯·æ±‚/å“åº”  â”‚     ä¸»è¦ç›®çš„     â”‚      å…¸å‹åœºæ™¯      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ é‡è¯•   â”‚ å¤šæ¬¡(1-N)   â”‚ ä¸ä¿®æ”¹           â”‚ æé«˜å¯é æ€§       â”‚ ç½‘ç»œä¸ç¨³å®š         â”‚
â”‚        â”‚             â”‚                  â”‚                  â”‚ API å¶å°”å¤±è´¥       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ çŸ­è·¯   â”‚ 0æ¬¡         â”‚ å®Œå…¨æ›¿æ¢         â”‚ è·³è¿‡æ‰§è¡Œ         â”‚ Mock/æµ‹è¯•          â”‚
â”‚        â”‚             â”‚                  â”‚                  â”‚ ç¼“å­˜å‘½ä¸­           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å“åº”   â”‚ 1æ¬¡         â”‚ ä¿®æ”¹å“åº”         â”‚ å¢å¼º/è¿‡æ»¤/è½¬æ¢   â”‚ æ ¼å¼åŒ–è¾“å‡º         â”‚
â”‚ ä¿®æ”¹   â”‚             â”‚                  â”‚                  â”‚ è„±æ•å¤„ç†           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ç¼“å­˜   â”‚ 0æˆ–1æ¬¡      â”‚ ä¸ä¿®æ”¹           â”‚ æé«˜æ€§èƒ½         â”‚ é‡å¤æŸ¥è¯¢           â”‚
â”‚        â”‚ (é¦–æ¬¡1æ¬¡)   â”‚ (é¦–æ¬¡åç¼“å­˜)     â”‚                  â”‚ æ˜‚è´µæ“ä½œ           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ç›‘æ§   â”‚ 1æ¬¡         â”‚ ä¸ä¿®æ”¹           â”‚ æ”¶é›†æŒ‡æ ‡         â”‚ æ€§èƒ½åˆ†æ           â”‚
â”‚        â”‚             â”‚ (æ—è·¯æ”¶é›†)       â”‚                  â”‚ ä½¿ç”¨ç»Ÿè®¡           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


æ‰§è¡Œæ—¶åºå¯¹æ¯”:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

é‡è¯•æ¨¡å¼:        çŸ­è·¯æ¨¡å¼:        ç¼“å­˜æ¨¡å¼:        ç›‘æ§æ¨¡å¼:
â”€â”€â”€â”€â”€â”€â”€â”€        â”€â”€â”€â”€â”€â”€â”€â”€        â”€â”€â”€â”€â”€â”€â”€â”€        â”€â”€â”€â”€â”€â”€â”€â”€

å°è¯•1 â†’ å¤±è´¥    æ£€æŸ¥æ¡ä»¶         æ£€æŸ¥ç¼“å­˜         è®°å½•å¼€å§‹
  â†“             â†“                â†“                â†“
å°è¯•2 â†’ å¤±è´¥    æ»¡è¶³çŸ­è·¯         æœªå‘½ä¸­            æ‰§è¡Œå·¥å…·
  â†“             â†“                â†“                â†“
å°è¯•3 â†’ æˆåŠŸ    ç›´æ¥è¿”å›         æ‰§è¡Œå·¥å…·         è®°å½•ç»“æŸ
  â†“                              â†“                â†“
è¿”å›ç»“æœ                         ä¿å­˜ç¼“å­˜         è¿”å›ç»“æœ
                                 â†“
                                 è¿”å›ç»“æœ
```

---

## ç»„åˆä½¿ç”¨ç¤ºä¾‹

è¿™äº›æ¨¡å¼å¯ä»¥ç»„åˆä½¿ç”¨ï¼š

```python
from langchain.agents import wrap_tool_call, create_agent

# æ¨¡å¼ç»„åˆï¼šç¼“å­˜ + ç›‘æ§ + é‡è¯•
cache = {}
metrics = []

@wrap_tool_call(name="CacheLayer")
def caching_layer(request, handler):
    """æœ€å¤–å±‚ï¼šç¼“å­˜"""
    cache_key = (request.tool.name, str(request.tool_call["args"]))
    if cache_key in cache:
        return ToolMessage(content=cache[cache_key], ...)
    response = handler(request)
    if isinstance(response, ToolMessage):
        cache[cache_key] = response.content
    return response

@wrap_tool_call(name="MonitoringLayer")
def monitoring_layer(request, handler):
    """ä¸­é—´å±‚ï¼šç›‘æ§"""
    import time
    start = time.time()
    response = handler(request)
    elapsed = time.time() - start
    metrics.append({"tool": request.tool.name, "time": elapsed})
    return response

@wrap_tool_call(name="RetryLayer")
def retry_layer(request, handler):
    """æœ€å†…å±‚ï¼šé‡è¯•"""
    for attempt in range(3):
        try:
            return handler(request)
        except Exception as e:
            if attempt == 2:
                return ToolMessage(content=f"Error: {e}", status="error", ...)

# ç»„åˆä½¿ç”¨ï¼ˆä»å¤–åˆ°å†…ï¼šç¼“å­˜ â†’ ç›‘æ§ â†’ é‡è¯•ï¼‰
agent = create_agent(
    model="openai:gpt-4o",
    tools=[search],
    middleware=[caching_layer, monitoring_layer, retry_layer]
)
```

**æ‰§è¡Œæµç¨‹**ï¼š

```text
è¯·æ±‚è¿›å…¥
   â”‚
   â–¼
ç¼“å­˜å±‚: æ£€æŸ¥ç¼“å­˜
   â”‚
   â”œâ”€ å‘½ä¸­ â†’ ç›´æ¥è¿”å› (ç›‘æ§å±‚å’Œé‡è¯•å±‚éƒ½ä¸æ‰§è¡Œ)
   â”‚
   â””â”€ æœªå‘½ä¸­ â†’ ç»§ç»­
       â”‚
       â–¼
   ç›‘æ§å±‚: è®°å½•å¼€å§‹æ—¶é—´
       â”‚
       â–¼
   é‡è¯•å±‚: å°è¯•æ‰§è¡Œ
       â”‚
       â”œâ”€ æˆåŠŸ â†’ è¿”å›ç»“æœ
       â”‚
       â””â”€ å¤±è´¥ â†’ é‡è¯• (æœ€å¤š3æ¬¡)
           â”‚
           â–¼
   ç›‘æ§å±‚: è®°å½•ç»“æŸæ—¶é—´
       â”‚
       â–¼
   ç¼“å­˜å±‚: ä¿å­˜ç»“æœåˆ°ç¼“å­˜
       â”‚
       â–¼
   è¿”å›æœ€ç»ˆç»“æœ
```

## wrap_tool_call ä¸­é—´ä»¶ç»„åˆæ¨¡å¼æ·±åº¦è§£æ

## ç»„åˆæ¨¡å¼ 1: å¤šä¸­é—´ä»¶ç»„åˆ (Multiple Middleware Composition)

### æ ¸å¿ƒæ¦‚å¿µï¼šæ´‹è‘±æ¨¡å‹

ä¸­é—´ä»¶æŒ‰**åˆ—è¡¨é¡ºåº**åµŒå¥—æ‰§è¡Œï¼Œç¬¬ä¸€ä¸ªæ˜¯**æœ€å¤–å±‚**ï¼Œæœ€åä¸€ä¸ªæ˜¯**æœ€å†…å±‚**ã€‚

### å®Œæ•´æµç¨‹å›¾

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         å¤šä¸­é—´ä»¶ç»„åˆ - æ´‹è‘±æ¨¡å‹                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

é…ç½®:
â”€â”€â”€â”€â”€
middleware = [outer_middleware, inner_middleware]
             â””â”€â”€â”€â”€â”€ æœ€å¤–å±‚ â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€ æœ€å†…å±‚ â”€â”€â”€â”€â”€â”˜


æ‰§è¡Œæµç¨‹ï¼ˆæ—¶åºå›¾ï¼‰:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

æ—¶é—´ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º

        outer_middleware                inner_middleware            å®é™…å·¥å…·
              â”‚                               â”‚                        â”‚
              â”‚  1. outer_before              â”‚                        â”‚
              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º      â”‚                        â”‚
              â”‚                               â”‚  2. inner_before       â”‚
              â”‚                               â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚
              â”‚                               â”‚                        â”‚ 3. search()
              â”‚                               â”‚                        â”‚    æ‰§è¡Œ...
              â”‚                               â”‚  4. inner_after       â”‚
              â”‚                               â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ return "Results"
              â”‚  5. outer_after               â”‚                        â”‚
              â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚                        â”‚
              â”‚                               â”‚                        â”‚
              â–¼                               â–¼                        â–¼
          return response               return response          "Results"


è°ƒç”¨æ ˆè§†å›¾:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                                         â”‚
â”‚  outer_middleware.wrap_tool_call(request, handler_to_inner) {                           â”‚
â”‚      â”‚                                                                                   â”‚
â”‚      â”œâ”€ call_log.append("outer_before")                                                 â”‚
â”‚      â”‚                                                                                   â”‚
â”‚      â”œâ”€ response = handler(request)  â† handler å®é™…æ˜¯ inner_middleware                  â”‚
â”‚      â”‚      â”‚                                                                           â”‚
â”‚      â”‚      â””â”€â”€â–º inner_middleware.wrap_tool_call(request, handler_to_tool) {            â”‚
â”‚      â”‚               â”‚                                                                   â”‚
â”‚      â”‚               â”œâ”€ call_log.append("inner_before")                                 â”‚
â”‚      â”‚               â”‚                                                                   â”‚
â”‚      â”‚               â”œâ”€ response = handler(request)  â† handler æ˜¯å®é™…å·¥å…·                â”‚
â”‚      â”‚               â”‚      â”‚                                                           â”‚
â”‚      â”‚               â”‚      â””â”€â”€â–º ğŸ”§ search(query="test")                                â”‚
â”‚      â”‚               â”‚               return "Results for: test"                         â”‚
â”‚      â”‚               â”‚          â—„â”€â”€â”€â”€â”€â”€â”€                                                â”‚
â”‚      â”‚               â”‚                                                                   â”‚
â”‚      â”‚               â”œâ”€ call_log.append("inner_after")                                  â”‚
â”‚      â”‚               â”‚                                                                   â”‚
â”‚      â”‚               â””â”€ return response                                                 â”‚
â”‚      â”‚           }                                                                       â”‚
â”‚      â”‚      â—„â”€â”€â”€â”€                                                                       â”‚
â”‚      â”‚                                                                                   â”‚
â”‚      â”œâ”€ call_log.append("outer_after")                                                  â”‚
â”‚      â”‚                                                                                   â”‚
â”‚      â””â”€ return response                                                                 â”‚
â”‚  }                                                                                       â”‚
â”‚                                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ‰§è¡Œç»“æœ:
â”€â”€â”€â”€â”€â”€â”€â”€â”€
call_log = [
    "outer_before",   â† Outer å¼€å§‹
    "inner_before",   â† Inner å¼€å§‹
    "inner_after",    â† Inner ç»“æŸ
    "outer_after"     â† Outer ç»“æŸ
]
```

### æºç å®ç° (test_wrap_tool_call.py ç¬¬ 354-396 è¡Œ)

```python
@wrap_tool_call
def outer_middleware(request, handler):
    call_log.append("outer_before")
    response = handler(request)  # handler æ˜¯ inner_middleware
    call_log.append("outer_after")
    return response

@wrap_tool_call
def inner_middleware(request, handler):
    call_log.append("inner_before")
    response = handler(request)  # handler æ˜¯å®é™…å·¥å…·
    call_log.append("inner_after")
    return response

# ç¬¬ä¸€ä¸ªæ˜¯æœ€å¤–å±‚
agent = create_agent(
    model=model,
    tools=[search],
    middleware=[outer_middleware, inner_middleware]
)
```

### æ•°æ®ä¼ é€’é“¾

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Agent     â”‚      â”‚   Outer     â”‚      â”‚   Inner     â”‚      â”‚   Tool      â”‚
â”‚   å…¥å£      â”‚ â”€â”€â”€â–º â”‚ Middleware  â”‚ â”€â”€â”€â–º â”‚ Middleware  â”‚ â”€â”€â”€â–º â”‚  search()   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚                    â”‚                    â”‚                    â”‚
      â”‚  ToolCallRequest   â”‚  ToolCallRequest   â”‚  ToolCallRequest   â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                                      â”‚
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Tool      â”‚      â”‚   Inner     â”‚      â”‚   Outer     â”‚      â”‚   Agent     â”‚
â”‚  search()   â”‚ â”€â”€â”€â–º â”‚ Middleware  â”‚ â”€â”€â”€â–º â”‚ Middleware  â”‚ â”€â”€â”€â–º â”‚   è¿”å›      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚                    â”‚                    â”‚                    â”‚
      â”‚  ToolMessage       â”‚  ToolMessage       â”‚  ToolMessage       â”‚
      â”‚  "Results..."      â”‚  (å¯èƒ½ä¿®æ”¹)        â”‚  (å¯èƒ½å†ä¿®æ”¹)      â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ç»„åˆæ¨¡å¼ 2: ä¸‰å±‚åµŒå¥— (Three Levels Nesting)

### å®Œæ•´æµç¨‹å›¾

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            ä¸‰å±‚åµŒå¥—æ‰§è¡Œæµç¨‹                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

é…ç½®:
â”€â”€â”€â”€â”€
middleware = [outer, middle, inner]
             â””â”€æœ€å¤–å±‚â”€â”˜ â””â”€ä¸­å±‚â”€â”˜ â””â”€æœ€å†…å±‚â”€â”˜


è°ƒç”¨é“¾å¯è§†åŒ–:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    è°ƒç”¨é¡ºåº                                                è¿”å›é¡ºåº
    â”€â”€â”€â”€â”€â”€â”€â”€                                                â”€â”€â”€â”€â”€â”€â”€â”€

         â”‚                                                      â–²
         â–¼                                                      â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚    Outer     â”‚  1. outer_before                  6. â”‚    Outer     â”‚
    â”‚              â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º   â”‚              â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                      â””â”€â”€â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                                                      â”‚
           â”‚ handler(request)                                    â”‚ return
           â–¼                                                      â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   Middle     â”‚  2. middle_before                 5. â”‚   Middle     â”‚
    â”‚              â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º   â”‚              â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                      â””â”€â”€â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                                                      â”‚
           â”‚ handler(request)                                    â”‚ return
           â–¼                                                      â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚    Inner     â”‚  3. inner_before                  4. â”‚    Inner     â”‚
    â”‚              â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º   â”‚              â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                      â””â”€â”€â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                                                      â”‚
           â”‚ handler(request)                                    â”‚ return
           â–¼                                                      â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   å·¥å…·æ‰§è¡Œ   â”‚  3.5 search() æ‰§è¡Œ                    â”‚   å·¥å…·æ‰§è¡Œ   â”‚
    â”‚  search()    â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º   â”‚  returnç»“æœ  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


å®Œæ•´æ—¶åº:
â”€â”€â”€â”€â”€â”€â”€â”€â”€

Outer å¼€å§‹  â”
            â”‚
Middle å¼€å§‹ â”‚
            â”‚
Inner å¼€å§‹  â”‚
            â”‚   â”Œâ”€ è¿™æ˜¯"ä¸‹è¡Œ"é˜¶æ®µ
            â”‚   â”‚  æ¯å±‚éƒ½åœ¨è®¾ç½®è‡ªå·±çš„å‰ç½®é€»è¾‘
            â–¼   â–¼

        å®é™…å·¥å…·æ‰§è¡Œ
        search("test")
        return "Results"

            â–²   â–²
            â”‚   â””â”€ è¿™æ˜¯"ä¸Šè¡Œ"é˜¶æ®µ
            â”‚      æ¯å±‚éƒ½åœ¨å¤„ç†è¿”å›å€¼
Inner ç»“æŸ  â”‚
            â”‚
Middle ç»“æŸ â”‚
            â”‚
Outer ç»“æŸ  â”˜


æ‰§è¡Œæ—¥å¿—:
â”€â”€â”€â”€â”€â”€â”€â”€â”€
[
    "outer_before",    â† 1ï¸âƒ£ æœ€å¤–å±‚è¿›å…¥
    "middle_before",   â† 2ï¸âƒ£ ä¸­é—´å±‚è¿›å…¥
    "inner_before",    â† 3ï¸âƒ£ æœ€å†…å±‚è¿›å…¥
    # æ­¤æ—¶æ‰§è¡Œå®é™…å·¥å…· search()
    "inner_after",     â† 4ï¸âƒ£ æœ€å†…å±‚é€€å‡º
    "middle_after",    â† 5ï¸âƒ£ ä¸­é—´å±‚é€€å‡º
    "outer_after"      â† 6ï¸âƒ£ æœ€å¤–å±‚é€€å‡º
]
```

### æºç å®ç° (test_wrap_tool_call.py ç¬¬ 465-521 è¡Œ)

```python
@wrap_tool_call(name="OuterWrapper")
def outer(request, handler):
    call_log.append("outer_before")
    response = handler(request)  # è°ƒç”¨ middle
    call_log.append("outer_after")
    return response

@wrap_tool_call(name="MiddleWrapper")
def middle(request, handler):
    call_log.append("middle_before")
    response = handler(request)  # è°ƒç”¨ inner
    call_log.append("middle_after")
    return response

@wrap_tool_call(name="InnerWrapper")
def inner(request, handler):
    call_log.append("inner_before")
    response = handler(request)  # è°ƒç”¨å®é™…å·¥å…·
    call_log.append("inner_after")
    return response

# ä»å¤–åˆ°å†…: outer â†’ middle â†’ inner
middleware=[outer, middle, inner]
```

### å®é™…åº”ç”¨åœºæ™¯

```python
# å®æˆ˜ç¤ºä¾‹ï¼šç¼“å­˜ + é‡è¯• + ç›‘æ§
middleware = [
    caching_middleware,      # æœ€å¤–å±‚ï¼šç¼“å­˜æ£€æŸ¥ï¼ˆæœ€å…ˆæ‰§è¡Œï¼‰
    monitoring_middleware,   # ä¸­å±‚ï¼šæ€§èƒ½ç›‘æ§
    retry_middleware         # æœ€å†…å±‚ï¼šé‡è¯•é€»è¾‘ï¼ˆæœ€åæ‰§è¡Œï¼‰
]

# æ‰§è¡Œæµç¨‹:
# 1. ç¼“å­˜å±‚æ£€æŸ¥ â†’ æœªå‘½ä¸­ â†’ ç»§ç»­
# 2. ç›‘æ§å±‚è®°å½•å¼€å§‹æ—¶é—´ â†’ ç»§ç»­
# 3. é‡è¯•å±‚å°è¯•æ‰§è¡Œï¼ˆå¯èƒ½é‡è¯•3æ¬¡ï¼‰
# 4. é‡è¯•å±‚è¿”å›ç»“æœ â†’ ç›‘æ§å±‚
# 5. ç›‘æ§å±‚è®°å½•è€—æ—¶ â†’ ç¼“å­˜å±‚
# 6. ç¼“å­˜å±‚ä¿å­˜ç»“æœ â†’ è¿”å›
```

---

## ç»„åˆæ¨¡å¼ 3: å¤–å±‚æ‹¦æˆªå†…å±‚ (Outer Intercepts Inner)

### æ ¸å¿ƒæ¦‚å¿µ

å¤–å±‚ä¸­é—´ä»¶å¯ä»¥**æ”¹å†™**å†…å±‚è¿”å›çš„ç»“æœï¼Œå³ä½¿å†…å±‚å·²ç»æ­£å¸¸æ‰§è¡Œã€‚

### å®Œæ•´æµç¨‹å›¾

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         å¤–å±‚æ‹¦æˆªå†…å±‚æ¨¡å¼                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  InterceptingOuter (å¤–å±‚)â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  1. call_log.append(       â”‚
                    â”‚      "outer_before")       â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â”‚ è°ƒç”¨ handler (å†…å±‚)
                                 â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  InnerWrapper (å†…å±‚)     â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  2. call_log.append("inner_called")    â”‚
        â”‚                                        â”‚
        â”‚  3. response = handler(request)        â”‚
        â”‚         â”‚                              â”‚
        â”‚         â–¼                              â”‚
        â”‚     æ‰§è¡Œå®é™…å·¥å…· search()              â”‚
        â”‚     return "Results for: test"         â”‚
        â”‚         â”‚                              â”‚
        â”‚         â–¼                              â”‚
        â”‚  4. call_log.append(                   â”‚
        â”‚      "inner_got_response")             â”‚
        â”‚                                        â”‚
        â”‚  5. return response â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
                                                    â”‚
                    å†…å±‚è¿”å› ToolMessage:            â”‚
                    content="Results for: test"     â”‚
                                                    â”‚
                                 â–²                  â”‚
                                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                    å›åˆ° outer_middleware
                                 â”‚
                                 â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  6. call_log.append("outer_after")         â”‚
        â”‚                                            â”‚
        â”‚  7. ğŸ¯ å…³é”®ï¼šå¤–å±‚æ‹¦æˆªå¹¶æ”¹å†™ç»“æœ!           â”‚
        â”‚                                            â”‚
        â”‚  return ToolMessage(                       â”‚
        â”‚      content="Outer intercepted",          â”‚ â† å®Œå…¨æ›¿æ¢å†…å±‚ç»“æœ
        â”‚      tool_call_id=request.tool_call["id"], â”‚
        â”‚      name=request.tool_call["name"]        â”‚
        â”‚  )                                         â”‚
        â”‚                                            â”‚
        â”‚  âš ï¸ å†…å±‚è¿”å›çš„ "Results for: test"        â”‚
        â”‚     è¢«ä¸¢å¼ƒäº†ï¼                              â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  æœ€ç»ˆè¿”å›ç»™ Agent:         â”‚
                    â”‚                            â”‚
                    â”‚  ToolMessage(              â”‚
                    â”‚    content="Outer          â”‚
                    â”‚      intercepted"          â”‚ â† å¤–å±‚çš„ç»“æœ
                    â”‚  )                         â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


å¯¹æ¯”ï¼šä¼ é€’ vs æ‹¦æˆª
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

ä¼ é€’æ¨¡å¼ï¼ˆæ­£å¸¸ï¼‰:                     æ‹¦æˆªæ¨¡å¼:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                     â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Outer: response = handler()           Outer: response = handler()
       return response                       â”‚ è·å¾—å†…å±‚ç»“æœ
          â–²                                  â–¼
          â”‚                           return ToolMessage(
          â”‚ åŸæ ·è¿”å›                        content="Outer intercepted"
          â”‚                           )
    Inner çš„ç»“æœ                           â”‚ æ”¹å†™ç»“æœ
                                           â–¼
                                      å®Œå…¨ä¸åŒçš„ç»“æœ
```

### æºç å®ç° (test_wrap_tool_call.py ç¬¬ 523-577 è¡Œ)

```python
@wrap_tool_call(name="InterceptingOuter")
def intercepting_outer(request, handler):
    call_log.append("outer_before")

    # è°ƒç”¨å†…å±‚ï¼ˆå†…å±‚ä¼šæ‰§è¡Œå·¥å…·å¹¶è¿”å›ç»“æœï¼‰
    response = handler(request)

    call_log.append("outer_after")

    # ğŸ¯ å…³é”®ï¼šæ‹¦æˆªå¹¶æ›¿æ¢ç»“æœ
    return ToolMessage(
        content="Outer intercepted",  # å®Œå…¨æ–°çš„å†…å®¹
        tool_call_id=request.tool_call["id"],
        name=request.tool_call["name"],
    )
    # å†…å±‚çš„ response è¢«ä¸¢å¼ƒï¼

@wrap_tool_call(name="InnerWrapper")
def inner(request, handler):
    call_log.append("inner_called")
    response = handler(request)  # æ‰§è¡Œå·¥å…·: "Results for: test"
    call_log.append("inner_got_response")
    return response  # è¿”å› "Results for: test"

middleware=[intercepting_outer, inner]
```

### æ•°æ®æµè½¬

```text
è¯·æ±‚æµ:
â”€â”€â”€â”€â”€â”€â”€
request â†’ outer â†’ inner â†’ search()
                           â”‚
                           â–¼
                   "Results for: test"

å“åº”æµ:
â”€â”€â”€â”€â”€â”€â”€
"Results for: test" â†’ inner â†’ outer â†’ "Outer intercepted"
                              â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                æ‹¦æˆªç‚¹ï¼å†…å±‚ç»“æœè¢«æ›¿æ¢

æœ€ç»ˆè¾“å‡º:
â”€â”€â”€â”€â”€â”€â”€â”€â”€
ToolMessage(content="Outer intercepted", ...)
â† ä¸æ˜¯å·¥å…·çš„çœŸå®è¾“å‡º "Results for: test"
```

### ä½¿ç”¨åœºæ™¯

- **ç»“æœå®¡æŸ¥**: å¤–å±‚æ£€æŸ¥å†…å±‚ç»“æœï¼Œä¸åˆè§„åˆ™æ›¿æ¢
- **é™çº§å¤„ç†**: å†…å±‚å¤±è´¥æ—¶ï¼Œå¤–å±‚è¿”å›é»˜è®¤å€¼
- **æ ¼å¼ç»Ÿä¸€**: å¤–å±‚å¼ºåˆ¶æ ¼å¼åŒ–æ‰€æœ‰ç»“æœ
- **å®‰å…¨è¿‡æ»¤**: å¤–å±‚æ£€æµ‹å¹¶æ›¿æ¢æ•æ„Ÿå†…å®¹

---

## ç»„åˆæ¨¡å¼ 4: å†…å±‚çŸ­è·¯ (Inner Short Circuits)

### æ ¸å¿ƒæ¦‚å¿µ

å†…å±‚ä¸­é—´ä»¶ç›´æ¥è¿”å›ç»“æœï¼ˆä¸è°ƒç”¨å®é™…å·¥å…·ï¼‰ï¼Œä½†å¤–å±‚ä»ç„¶å¯ä»¥åŒ…è£…è¿™ä¸ªç»“æœã€‚

### å®Œæ•´æµç¨‹å›¾

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         å†…å±‚çŸ­è·¯æ¨¡å¼                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  OuterWrapper (å¤–å±‚)     â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  1. call_log.append(       â”‚
                    â”‚      "outer_before")       â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â”‚ è°ƒç”¨ handler (å†…å±‚)
                                 â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  InnerShortCircuit (å†…å±‚)      â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  2. call_log.append("inner_short_circuit") â”‚
        â”‚                                            â”‚
        â”‚  3. ğŸ”¥ å…³é”®å†³ç­–ï¼šä¸è°ƒç”¨ handler!          â”‚
        â”‚                                            â”‚
        â”‚  âŒ handler(request)  ä¸ä¼šè¢«è°ƒç”¨           â”‚
        â”‚                                            â”‚
        â”‚  âœ… ç›´æ¥è¿”å›è‡ªå®šä¹‰ç»“æœ                     â”‚
        â”‚                                            â”‚
        â”‚  return ToolMessage(                       â”‚
        â”‚      content="inner_result",               â”‚
        â”‚      ...                                   â”‚
        â”‚  )                                         â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â”‚ è¿”å›ç»™å¤–å±‚
                         â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚  4. call_log.append(           â”‚
            â”‚      "outer_after")            â”‚
            â”‚                                â”‚
            â”‚  5. å¤–å±‚åŒ…è£…å†…å±‚çš„ç»“æœ:        â”‚
            â”‚                                â”‚
            â”‚  return ToolMessage(           â”‚
            â”‚      content="outer_wrapped:   â”‚
            â”‚         inner_result",         â”‚ â† åŒ…è£…å†…å±‚ç»“æœ
            â”‚      ...                       â”‚
            â”‚  )                             â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚  æœ€ç»ˆç»“æœ:                 â”‚
                â”‚                            â”‚
                â”‚  ToolMessage(              â”‚
                â”‚    content="outer_wrapped: â”‚
                â”‚      inner_result"         â”‚
                â”‚  )                         â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


å…³é”®ç‚¹ï¼šå®é™…å·¥å…· search() æ°¸è¿œä¸ä¼šè¢«è°ƒç”¨ï¼
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ search()     â”‚  âš ï¸ è¿™ä¸ªå‡½æ•°ä¸ä¼šè¢«æ‰§è¡Œ
    â”‚              â”‚     å› ä¸ºå†…å±‚çŸ­è·¯äº†
    â”‚ æ­£å¸¸åº”è¯¥æ‰§è¡Œ â”‚     handler æ²¡æœ‰è¢«è°ƒç”¨
    â”‚ ä½†è¢«è·³è¿‡äº†   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    å†…å±‚ç›´æ¥è¿”å› "inner_result"ï¼Œè·³è¿‡äº†å·¥å…·æ‰§è¡Œ


æ‰§è¡Œè·¯å¾„å¯¹æ¯”:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

æ­£å¸¸è·¯å¾„:                                å†…å±‚çŸ­è·¯è·¯å¾„:
â”€â”€â”€â”€â”€â”€â”€â”€â”€                               â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

outer_before                             outer_before
   â”‚                                        â”‚
   â–¼                                        â–¼
inner_before                             inner_short_circuit
   â”‚                                        â”‚
   â–¼                                        â”‚ âš¡ï¸ çŸ­è·¯ï¼ä¸è°ƒç”¨ handler
æ‰§è¡Œ search()                               â”‚
   â”‚                                        â”‚ ç›´æ¥è¿”å› "inner_result"
   â–¼                                        â”‚
inner_after                                 â–¼
   â”‚                                     outer_after
   â–¼                                        â”‚
outer_after                                 â–¼
   â”‚                                     åŒ…è£… "inner_result"
   â–¼                                        â”‚
è¿”å› "Results..."                           â–¼
                                        è¿”å› "outer_wrapped: inner_result"
```

### æºç å®ç° (test_wrap_tool_call.py ç¬¬ 579-633 è¡Œ)

```python
@wrap_tool_call(name="OuterWrapper")
def outer(request, handler):
    call_log.append("outer_before")
    response = handler(request)  # è°ƒç”¨å†…å±‚
    call_log.append("outer_after")

    # åŒ…è£…å†…å±‚çš„å“åº”
    if isinstance(response, ToolMessage):
        return ToolMessage(
            content=f"outer_wrapped: {response.content}",  # åŒ…è£…
            tool_call_id=response.tool_call_id,
            name=response.name,
        )
    return response

@wrap_tool_call(name="InnerShortCircuit")
def inner_short_circuit(request, handler):
    call_log.append("inner_short_circuit")

    # âš¡ï¸ çŸ­è·¯ï¼šä¸è°ƒç”¨ handlerï¼Œç›´æ¥è¿”å›
    return ToolMessage(
        content="inner_result",
        tool_call_id=request.tool_call["id"],
        name=request.tool_call["name"],
    )
    # handler(request) æ°¸è¿œä¸ä¼šæ‰§è¡Œ

middleware=[outer, inner_short_circuit]
```

### æ•°æ®æµè½¬è¯¦è§£

```text
æ­¥éª¤ 1: è¿›å…¥å¤–å±‚
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
outer æ¥æ”¶ request
  â””â”€ call_log.append("outer_before")
  â””â”€ è°ƒç”¨ handler(request)  # handler æ˜¯ inner_short_circuit

æ­¥éª¤ 2: è¿›å…¥å†…å±‚ï¼ˆçŸ­è·¯ï¼‰
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
inner_short_circuit æ¥æ”¶ request
  â””â”€ call_log.append("inner_short_circuit")
  â””â”€ ğŸ’¥ ä¸è°ƒç”¨ handlerï¼
  â””â”€ ç›´æ¥è¿”å› ToolMessage(content="inner_result")

æ­¥éª¤ 3: è¿”å›å¤–å±‚
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
outer æ¥æ”¶åˆ° response = ToolMessage(content="inner_result")
  â””â”€ call_log.append("outer_after")
  â””â”€ åŒ…è£…ç»“æœ: content = f"outer_wrapped: {response.content}"
  â””â”€ è¿”å› ToolMessage(content="outer_wrapped: inner_result")

æœ€ç»ˆç»“æœ:
â”€â”€â”€â”€â”€â”€â”€â”€â”€
call_log = ["outer_before", "inner_short_circuit", "outer_after"]
result = ToolMessage(content="outer_wrapped: inner_result")

æ³¨æ„:
- "inner_result" æ¥è‡ªå†…å±‚çš„çŸ­è·¯
- "outer_wrapped:" æ˜¯å¤–å±‚æ·»åŠ çš„å‰ç¼€
- å®é™…å·¥å…· search() ä»æœªè¢«è°ƒç”¨
```

### ä½¿ç”¨åœºæ™¯

- **æµ‹è¯•ç¯å¢ƒ**: å†…å±‚ Mock å·¥å…·è°ƒç”¨ï¼Œå¤–å±‚æ·»åŠ æµ‹è¯•æ ‡è®°
- **ç¼“å­˜ + æ ¼å¼åŒ–**: å†…å±‚ç¼“å­˜çŸ­è·¯ï¼Œå¤–å±‚ç»Ÿä¸€æ ¼å¼åŒ–
- **é™çº§ + åŒ…è£…**: å†…å±‚é™çº§è¿”å›é»˜è®¤å€¼ï¼Œå¤–å±‚åŒ…è£…æˆç»Ÿä¸€æ ¼å¼

---

## ç»„åˆæ¨¡å¼ç»¼åˆå¯¹æ¯”

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         4 ç§ç»„åˆæ¨¡å¼å¯¹æ¯”è¡¨                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    æ¨¡å¼       â”‚  å±‚æ•°  â”‚ å®é™…å·¥å…·è°ƒç”¨ â”‚  å¤–å±‚è¡Œä¸º    â”‚      å…¸å‹ç”¨é€”          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å¤šä¸­é—´ä»¶ç»„åˆ  â”‚  2+    â”‚   1æ¬¡        â”‚ ä¼ é€’ç»“æœ     â”‚ åŠŸèƒ½åˆ†å±‚ï¼ˆç›‘æ§+é‡è¯•ï¼‰  â”‚
â”‚               â”‚        â”‚              â”‚              â”‚                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ä¸‰å±‚åµŒå¥—      â”‚  3     â”‚   1æ¬¡        â”‚ ä¼ é€’ç»“æœ     â”‚ æ›´å¤æ‚çš„åŠŸèƒ½ç»„åˆ       â”‚
â”‚               â”‚        â”‚              â”‚              â”‚ (ç¼“å­˜+ç›‘æ§+é‡è¯•)       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å¤–å±‚æ‹¦æˆªå†…å±‚  â”‚  2+    â”‚   1æ¬¡        â”‚ æ”¹å†™ç»“æœ     â”‚ ç»“æœå®¡æŸ¥/é™çº§/ç»Ÿä¸€æ ¼å¼ â”‚
â”‚               â”‚        â”‚              â”‚              â”‚                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å†…å±‚çŸ­è·¯      â”‚  2+    â”‚   0æ¬¡        â”‚ åŒ…è£…ç»“æœ     â”‚ Mock+æ ¼å¼åŒ–            â”‚
â”‚               â”‚        â”‚  (è¢«è·³è¿‡)    â”‚              â”‚ ç¼“å­˜+ç»Ÿä¸€è¾“å‡º          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


æ‰§è¡Œé¡ºåºå¯¹æ¯”:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

æ¨¡å¼ 1: å¤šä¸­é—´ä»¶ç»„åˆ                æ¨¡å¼ 2: ä¸‰å±‚åµŒå¥—
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€               â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

outer_before                         outer_before
  inner_before                         middle_before
    ğŸ”§ å·¥å…·æ‰§è¡Œ                           inner_before
  inner_after                               ğŸ”§ å·¥å…·æ‰§è¡Œ
outer_after                              inner_after
                                       middle_after
                                     outer_after


æ¨¡å¼ 3: å¤–å±‚æ‹¦æˆªå†…å±‚                æ¨¡å¼ 4: å†…å±‚çŸ­è·¯
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€               â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

outer_before                         outer_before
  inner_called                         inner_short_circuit
    ğŸ”§ å·¥å…·æ‰§è¡Œ                           âš¡ï¸ ä¸æ‰§è¡Œå·¥å…·
  inner_got_response                     è¿”å› "inner_result"
outer_after                          outer_after
  â”œâ”€ æ”¶åˆ°å†…å±‚ç»“æœ                        â”œâ”€ æ”¶åˆ°çŸ­è·¯ç»“æœ
  â””â”€ ğŸ¯ æ”¹å†™ä¸ºæ–°ç»“æœ                     â””â”€ åŒ…è£…çŸ­è·¯ç»“æœ
  è¿”å› "Outer intercepted"              è¿”å› "outer_wrapped: inner_result"
```

---

## å®æˆ˜ç»„åˆç¤ºä¾‹

### ç¤ºä¾‹ 1: ç¼“å­˜ + æ ¼å¼åŒ– + ç›‘æ§ï¼ˆå†…å±‚çŸ­è·¯ + å¤–å±‚åŒ…è£…ï¼‰

```python
metrics = []
cache = {}

@wrap_tool_call(name="Formatter")
def formatter(request, handler):
    """æœ€å¤–å±‚ï¼šæ ¼å¼åŒ–"""
    response = handler(request)
    if isinstance(response, ToolMessage):
        return ToolMessage(
            content=f"ğŸ“Š {response.content}",  # æ·»åŠ å›¾æ ‡
            tool_call_id=response.tool_call_id,
            name=response.name
        )
    return response

@wrap_tool_call(name="Cache")
def cache_middleware(request, handler):
    """ä¸­å±‚ï¼šç¼“å­˜ï¼ˆå¯èƒ½çŸ­è·¯ï¼‰"""
    cache_key = (request.tool.name, str(request.tool_call["args"]))

    # ç¼“å­˜å‘½ä¸­ â†’ çŸ­è·¯
    if cache_key in cache:
        return ToolMessage(content=cache[cache_key], ...)

    # ç¼“å­˜æœªå‘½ä¸­ â†’ æ‰§è¡Œ
    response = handler(request)
    if isinstance(response, ToolMessage):
        cache[cache_key] = response.content
    return response

@wrap_tool_call(name="Monitor")
def monitor(request, handler):
    """æœ€å†…å±‚ï¼šç›‘æ§"""
    import time
    start = time.time()
    response = handler(request)
    elapsed = time.time() - start
    metrics.append({"tool": request.tool.name, "time": elapsed})
    return response

middleware=[formatter, cache_middleware, monitor]

# ç¬¬ä¸€æ¬¡è°ƒç”¨: formatter â†’ cache(æœªå‘½ä¸­) â†’ monitor â†’ å·¥å…·
# ç»“æœ: "ğŸ“Š Results for: test"

# ç¬¬äºŒæ¬¡è°ƒç”¨: formatter â†’ cache(å‘½ä¸­,çŸ­è·¯!) â†’ è¿”å›
# ç»“æœ: "ğŸ“Š Results for: test"
# æ³¨æ„: monitor å’Œå·¥å…·éƒ½æ²¡æ‰§è¡Œï¼ˆè¢« cache çŸ­è·¯ï¼‰
```

### ç¤ºä¾‹ 2: é‡è¯• + æ‹¦æˆªé”™è¯¯ï¼ˆå¤–å±‚æ‹¦æˆªå†…å±‚ï¼‰

```python
@wrap_tool_call(name="ErrorHandler")
def error_handler(request, handler):
    """å¤–å±‚ï¼šé”™è¯¯æ‹¦æˆª"""
    response = handler(request)

    # æ‹¦æˆªé”™è¯¯å“åº”ï¼Œè½¬ä¸ºå‹å¥½æ¶ˆæ¯
    if isinstance(response, ToolMessage) and response.status == "error":
        return ToolMessage(
            content="æŠ±æ­‰ï¼Œå·¥å…·æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•ã€‚",  # å‹å¥½æ¶ˆæ¯
            tool_call_id=response.tool_call_id,
            name=response.name,
            status="error"
        )
    return response

@wrap_tool_call(name="Retry")
def retry(request, handler):
    """å†…å±‚ï¼šé‡è¯•ï¼ˆå¤±è´¥åè¿”å›é”™è¯¯ï¼‰"""
    for attempt in range(3):
        try:
            return handler(request)
        except Exception as e:
            if attempt == 2:
                return ToolMessage(
                    content=f"Tool failed: {e}",  # æŠ€æœ¯é”™è¯¯ä¿¡æ¯
                    status="error",
                    ...
                )

middleware=[error_handler, retry]

# å¦‚æœé‡è¯•3æ¬¡å…¨å¤±è´¥:
# retry è¿”å›: "Tool failed: Connection timeout"
# error_handler æ‹¦æˆªå¹¶æ”¹å†™: "æŠ±æ­‰ï¼Œå·¥å…·æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•ã€‚"
# æœ€ç»ˆç”¨æˆ·çœ‹åˆ°å‹å¥½æ¶ˆæ¯ï¼Œä¸æ˜¯æŠ€æœ¯é”™è¯¯
```

---

## ç»„åˆæ¨¡å¼å†³ç­–æ ‘

```text
å¦‚ä½•é€‰æ‹©ç»„åˆæ¨¡å¼ï¼Ÿ
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    æ˜¯å¦éœ€è¦å®é™…æ‰§è¡Œå·¥å…·ï¼Ÿ
            â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                â”‚
   æ˜¯                å¦
    â”‚                â”‚
    â–¼                â–¼
éœ€è¦ä¿®æ”¹ç»“æœï¼Ÿ    å†…å±‚çŸ­è·¯æ¨¡å¼
    â”‚            (Mock/ç¼“å­˜å‘½ä¸­)
â”Œâ”€â”€â”€â”´â”€â”€â”€â”€â”           â”‚
â”‚        â”‚           â–¼
æ˜¯       å¦      éœ€è¦å¤–å±‚åŒ…è£…ï¼Ÿ
â”‚        â”‚       â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
â–¼        â–¼      æ˜¯         å¦
å¤–å±‚     å¤šå±‚    â”‚          â”‚
æ‹¦æˆª     åµŒå¥—    â–¼          â–¼
å†…å±‚     ä¼ é€’   å¤–å±‚åŒ…è£…   ç›´æ¥è¿”å›
(å®¡æŸ¥)  (ç›‘æ§)   å†…å±‚ç»“æœ   çŸ­è·¯ç»“æœ
```
