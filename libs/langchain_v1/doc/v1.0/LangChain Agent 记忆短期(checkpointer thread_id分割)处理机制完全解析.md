# LangChain Agent çŸ­æœŸè®°å¿† (Checkpointer) å¤„ç†æœºåˆ¶å®Œå…¨è§£æ

åŸºäºæºç åˆ†æï¼š`langgraph/libs/checkpoint/` ç³»åˆ—æ¨¡å—

---

## ä¸€ã€ä»€ä¹ˆæ˜¯"çŸ­æœŸè®°å¿†"ï¼Ÿ

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                                                                                      â•‘
â•‘                          LangChain v1 ä¸­çš„"çŸ­æœŸè®°å¿†"å®šä¹‰                              â•‘
â•‘                                                                                      â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                                                      â•‘
â•‘   åœ¨ LangChain v1 ä¸­ï¼Œ"çŸ­æœŸè®°å¿†"æ˜¯æŒ‡ã€å•ä¸ªå¯¹è¯çº¿ç¨‹å†…çš„çŠ¶æ€æŒä¹…åŒ–ã€‘ã€‚                  â•‘
â•‘                                                                                      â•‘
â•‘   çŸ­æœŸè®°å¿† = å¯¹è¯å†å² = state["messages"] = è¢« Checkpointer æŒä¹…åŒ–çš„æ¶ˆæ¯åˆ—è¡¨          â•‘
â•‘                                                                                      â•‘
â•‘   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â•‘
â•‘   â”‚                                                                            â”‚     â•‘
â•‘   â”‚   state = {                                                                â”‚     â•‘
â•‘   â”‚       "messages": [                        â† è¿™å°±æ˜¯"çŸ­æœŸè®°å¿†"ï¼            â”‚     â•‘
â•‘   â”‚           HumanMessage("ä½ å¥½ï¼Œæˆ‘æ˜¯å¼ ä¸‰"),                                   â”‚     â•‘
â•‘   â”‚           AIMessage("ä½ å¥½å¼ ä¸‰ï¼å¾ˆé«˜å…´è®¤è¯†ä½ "),                               â”‚     â•‘
â•‘   â”‚           HumanMessage("æˆ‘çš„åå­—æ˜¯ä»€ä¹ˆï¼Ÿ"),                                 â”‚     â•‘
â•‘   â”‚           AIMessage("ä½ çš„åå­—æ˜¯å¼ ä¸‰"),                                      â”‚     â•‘
â•‘   â”‚       ],                                                                   â”‚     â•‘
â•‘   â”‚       "todos": [...],                      â† ä¸­é—´ä»¶æ‰©å±•çš„çŠ¶æ€ä¹Ÿä¼šè¢«è®°ä½     â”‚     â•‘
â•‘   â”‚       "structured_response": ...                                          â”‚     â•‘
â•‘   â”‚   }                                                                        â”‚     â•‘
â•‘   â”‚                                                                            â”‚     â•‘
â•‘   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â•‘
â•‘                                                                                      â•‘
â•‘   æ ¸å¿ƒç‰¹å¾ï¼š                                                                          â•‘
â•‘   1. çŸ­æœŸè®°å¿† = çŠ¶æ€ä¸­çš„ messages å­—æ®µ + å…¶ä»– channel å€¼                              â•‘
â•‘   2. çŸ­æœŸè®°å¿†é€šè¿‡ Checkpointer æŒä¹…åŒ–                                                 â•‘
â•‘   3. çŸ­æœŸè®°å¿†é€šè¿‡ thread_id åŒºåˆ†ä¸åŒå¯¹è¯ï¼ˆæ¯ä¸ª thread ç‹¬ç«‹ï¼‰                           â•‘
â•‘   4. çŸ­æœŸè®°å¿†ä¸è·¨ thread å…±äº«ï¼ˆå¯¹è¯ A çœ‹ä¸åˆ°å¯¹è¯ B çš„å†å²ï¼‰                            â•‘
â•‘                                                                                      â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

### 1.1 çŸ­æœŸè®°å¿† vs é•¿æœŸè®°å¿†

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                                     â”‚
â”‚                        çŸ­æœŸè®°å¿† vs é•¿æœŸè®°å¿† å¯¹æ¯”                                     â”‚
â”‚                                                                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚       çŸ­æœŸè®°å¿† (Checkpointer)   â”‚         é•¿æœŸè®°å¿† (Store)                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                 â”‚                                                   â”‚
â”‚  ä½œç”¨åŸŸï¼šå•ä¸ª thread å†…          â”‚  ä½œç”¨åŸŸï¼šè·¨æ‰€æœ‰ thread                            â”‚
â”‚                                 â”‚                                                   â”‚
â”‚  éš”ç¦»æ€§ï¼šå®Œå…¨éš”ç¦»                â”‚  éš”ç¦»æ€§ï¼šå…¨å±€å…±äº«                                  â”‚
â”‚  - thread-1 çœ‹ä¸åˆ° thread-2    â”‚  - æ‰€æœ‰ thread éƒ½èƒ½è®¿é—®                            â”‚
â”‚                                 â”‚                                                   â”‚
â”‚  å­˜å‚¨å†…å®¹ï¼š                       â”‚  å­˜å‚¨å†…å®¹ï¼š                                       â”‚
â”‚  - å¯¹è¯æ¶ˆæ¯å†å²                  â”‚  - ç”¨æˆ·åå¥½                                       â”‚
â”‚  - Agent çŠ¶æ€å¿«ç…§                â”‚  - çŸ¥è¯†åº“                                         â”‚
â”‚  - ä¸­é—´ä»¶æ‰©å±•çŠ¶æ€                â”‚  - è·¨ä¼šè¯è®°å¿†                                     â”‚
â”‚                                 â”‚                                                   â”‚
â”‚  ç”Ÿå‘½å‘¨æœŸï¼š                       â”‚  ç”Ÿå‘½å‘¨æœŸï¼š                                       â”‚
â”‚  - éš thread åˆ›å»º               â”‚  - åº”ç”¨çº§åˆ«                                       â”‚
â”‚  - å¯åˆ é™¤å•ä¸ª thread            â”‚  - æŒä¹…å­˜å‚¨                                       â”‚
â”‚                                 â”‚                                                   â”‚
â”‚  è®¿é—®æ–¹å¼ï¼š                       â”‚  è®¿é—®æ–¹å¼ï¼š                                       â”‚
â”‚  - è‡ªåŠ¨åŠ è½½/ä¿å­˜                 â”‚  - æ‰‹åŠ¨è°ƒç”¨ API                                   â”‚
â”‚  - é€æ˜ï¼Œç”¨æˆ·æ— æ„Ÿ                â”‚  - éœ€è¦åœ¨å·¥å…·/ä¸­é—´ä»¶ä¸­ä½¿ç”¨                        â”‚
â”‚                                 â”‚                                                   â”‚
â”‚  å…¸å‹åœºæ™¯ï¼š                       â”‚  å…¸å‹åœºæ™¯ï¼š                                       â”‚
â”‚  - å•æ¬¡å¯¹è¯ä¸Šä¸‹æ–‡                â”‚  - ç”¨æˆ·ç”»åƒ                                       â”‚
â”‚  - å¤šè½®é—®ç­”                      â”‚  - è·¨ä¼šè¯çŸ¥è¯†                                     â”‚
â”‚                                 â”‚                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## äºŒã€Checkpointer æ ¸å¿ƒæ•°æ®ç»“æ„ï¼ˆæºç è§£æï¼‰

### 2.1 æ ¸å¿ƒç±»å‹å®šä¹‰

æ¥æºï¼š`langgraph/libs/checkpoint/langgraph/checkpoint/base/__init__.py`

```python
# ==================== Checkpoint æ•°æ®ç»“æ„ ====================

class Checkpoint(TypedDict):
    """State snapshot at a given point in time."""

    v: int
    """The version of the checkpoint format. Currently `1`."""
    
    id: str
    """The ID of the checkpoint.
    This is both unique and monotonically increasing, so can be used for sorting
    checkpoints from first to last."""
    
    ts: str
    """The timestamp of the checkpoint in ISO 8601 format."""
    
    channel_values: dict[str, Any]
    """The values of the channels at the time of the checkpoint.
    Mapping from channel name to deserialized channel snapshot value.
    è¿™é‡Œå­˜å‚¨äº† messagesã€todos ç­‰æ‰€æœ‰çŠ¶æ€ï¼"""
    
    channel_versions: ChannelVersions
    """The versions of the channels at the time of the checkpoint.
    The keys are channel names and the values are monotonically increasing
    version strings for each channel."""
    
    versions_seen: dict[str, ChannelVersions]
    """Map from node ID to map from channel name to version seen.
    This keeps track of the versions of the channels that each node has seen.
    Used to determine which nodes to execute next."""
    
    updated_channels: list[str] | None
    """The channels that were updated in this checkpoint."""


# ==================== CheckpointMetadata å…ƒæ•°æ® ====================

class CheckpointMetadata(TypedDict, total=False):
    """Metadata associated with a checkpoint."""

    source: Literal["input", "loop", "update", "fork"]
    """The source of the checkpoint.
    - `"input"`: The checkpoint was created from an input to invoke/stream/batch.
    - `"loop"`: The checkpoint was created from inside the pregel loop.
    - `"update"`: The checkpoint was created from a manual state update.
    - `"fork"`: The checkpoint was created as a copy of another checkpoint.
    """
    
    step: int
    """The step number of the checkpoint.
    `-1` for the first `"input"` checkpoint.
    `0` for the first `"loop"` checkpoint.
    `...` for the `nth` checkpoint afterwards."""
    
    parents: dict[str, str]
    """The IDs of the parent checkpoints.
    Mapping from checkpoint namespace to checkpoint ID."""


# ==================== CheckpointTuple å®Œæ•´å…ƒç»„ ====================

class CheckpointTuple(NamedTuple):
    """A tuple containing a checkpoint and its associated data."""

    config: RunnableConfig
    """è¿è¡Œæ—¶é…ç½®ï¼ŒåŒ…å« thread_id, checkpoint_ns, checkpoint_id"""
    
    checkpoint: Checkpoint
    """å®é™…çš„æ£€æŸ¥ç‚¹æ•°æ®"""
    
    metadata: CheckpointMetadata
    """æ£€æŸ¥ç‚¹å…ƒæ•°æ®"""
    
    parent_config: RunnableConfig | None = None
    """çˆ¶æ£€æŸ¥ç‚¹çš„é…ç½®ï¼ˆç”¨äºå›æº¯å†å²ï¼‰"""
    
    pending_writes: list[PendingWrite] | None = None
    """å¾…å¤„ç†çš„å†™å…¥æ“ä½œ"""
```

### 2.2 æ•°æ®ç»“æ„å…³ç³»å›¾

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                                                                                                  â•‘
â•‘                            Checkpoint æ•°æ®ç»“æ„å…³ç³»å›¾                                              â•‘
â•‘                                                                                                  â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                                                                  â•‘
â•‘   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â•‘
â•‘   â”‚                              CheckpointTuple                                             â”‚   â•‘
â•‘   â”‚                                                                                          â”‚   â•‘
â•‘   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â•‘
â•‘   â”‚   â”‚  config: RunnableConfig                                                         â”‚    â”‚   â•‘
â•‘   â”‚   â”‚  {                                                                              â”‚    â”‚   â•‘
â•‘   â”‚   â”‚      "configurable": {                                                          â”‚    â”‚   â•‘
â•‘   â”‚   â”‚          "thread_id": "user-123-conv-1",     â† å¯¹è¯çº¿ç¨‹æ ‡è¯†                      â”‚    â”‚   â•‘
â•‘   â”‚   â”‚          "checkpoint_ns": "",                â† å‘½åç©ºé—´ï¼ˆå­å›¾ç”¨ï¼‰                â”‚    â”‚   â•‘
â•‘   â”‚   â”‚          "checkpoint_id": "1ef4f797-8335..." â† æ£€æŸ¥ç‚¹å”¯ä¸€ ID                     â”‚    â”‚   â•‘
â•‘   â”‚   â”‚      }                                                                          â”‚    â”‚   â•‘
â•‘   â”‚   â”‚  }                                                                              â”‚    â”‚   â•‘
â•‘   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â•‘
â•‘   â”‚                                                                                          â”‚   â•‘
â•‘   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â•‘
â•‘   â”‚   â”‚  checkpoint: Checkpoint                                                         â”‚    â”‚   â•‘
â•‘   â”‚   â”‚  {                                                                              â”‚    â”‚   â•‘
â•‘   â”‚   â”‚      "v": 2,                                  â† æ ¼å¼ç‰ˆæœ¬                         â”‚    â”‚   â•‘
â•‘   â”‚   â”‚      "id": "1ef4f797-8335...",                â† æ£€æŸ¥ç‚¹ ID                        â”‚    â”‚   â•‘
â•‘   â”‚   â”‚      "ts": "2024-12-10T10:30:00+00:00",       â† æ—¶é—´æˆ³                          â”‚    â”‚   â•‘
â•‘   â”‚   â”‚      "channel_values": {                      â† ğŸ”¥ æ ¸å¿ƒï¼æ‰€æœ‰çŠ¶æ€å€¼              â”‚    â”‚   â•‘
â•‘   â”‚   â”‚          "messages": [                        â† å¯¹è¯å†å²ï¼ˆçŸ­æœŸè®°å¿†ï¼‰             â”‚    â”‚   â•‘
â•‘   â”‚   â”‚              HumanMessage("ä½ å¥½"),                                              â”‚    â”‚   â•‘
â•‘   â”‚   â”‚              AIMessage("ä½ å¥½ï¼"),                                               â”‚    â”‚   â•‘
â•‘   â”‚   â”‚          ],                                                                     â”‚    â”‚   â•‘
â•‘   â”‚   â”‚          "todos": [...],                      â† ä¸­é—´ä»¶æ‰©å±•çŠ¶æ€                   â”‚    â”‚   â•‘
â•‘   â”‚   â”‚          "structured_response": {...}         â† å…¶ä»–çŠ¶æ€                        â”‚    â”‚   â•‘
â•‘   â”‚   â”‚      },                                                                         â”‚    â”‚   â•‘
â•‘   â”‚   â”‚      "channel_versions": {                    â† å„ channel ç‰ˆæœ¬å·               â”‚    â”‚   â•‘
â•‘   â”‚   â”‚          "messages": "00000003.0.123456",                                       â”‚    â”‚   â•‘
â•‘   â”‚   â”‚          "todos": "00000001.0.789012"                                           â”‚    â”‚   â•‘
â•‘   â”‚   â”‚      },                                                                         â”‚    â”‚   â•‘
â•‘   â”‚   â”‚      "versions_seen": {...}                   â† èŠ‚ç‚¹çœ‹åˆ°çš„ç‰ˆæœ¬                   â”‚    â”‚   â•‘
â•‘   â”‚   â”‚  }                                                                              â”‚    â”‚   â•‘
â•‘   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â•‘
â•‘   â”‚                                                                                          â”‚   â•‘
â•‘   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â•‘
â•‘   â”‚   â”‚  metadata: CheckpointMetadata                                                   â”‚    â”‚   â•‘
â•‘   â”‚   â”‚  {                                                                              â”‚    â”‚   â•‘
â•‘   â”‚   â”‚      "source": "loop",                        â† æ¥æºï¼šinput/loop/update/fork   â”‚    â”‚   â•‘
â•‘   â”‚   â”‚      "step": 3,                               â† ç¬¬å‡ æ­¥                          â”‚    â”‚   â•‘
â•‘   â”‚   â”‚      "parents": {}                            â† çˆ¶æ£€æŸ¥ç‚¹æ˜ å°„                     â”‚    â”‚   â•‘
â•‘   â”‚   â”‚  }                                                                              â”‚    â”‚   â•‘
â•‘   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â•‘
â•‘   â”‚                                                                                          â”‚   â•‘
â•‘   â”‚   parent_config: RunnableConfig | None            â† çˆ¶æ£€æŸ¥ç‚¹é…ç½®ï¼ˆç”¨äºå†å²å›æº¯ï¼‰      â”‚   â•‘
â•‘   â”‚   pending_writes: list[PendingWrite] | None       â† å¾…å¤„ç†å†™å…¥                       â”‚   â•‘
â•‘   â”‚                                                                                          â”‚   â•‘
â•‘   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â•‘
â•‘                                                                                                  â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

---

## ä¸‰ã€BaseCheckpointSaver æŠ½è±¡åŸºç±»ï¼ˆæºç è§£æï¼‰

### 3.1 æ ¸å¿ƒæ¥å£å®šä¹‰

æ¥æºï¼š`langgraph/libs/checkpoint/langgraph/checkpoint/base/__init__.py`

```python
class BaseCheckpointSaver(Generic[V]):
    """Base class for creating a graph checkpointer.

    Checkpointers allow LangGraph agents to persist their state
    within and across multiple interactions.

    Attributes:
        serde (SerializerProtocol): Serializer for encoding/decoding checkpoints.
    """

    serde: SerializerProtocol = JsonPlusSerializer()

    def __init__(self, *, serde: SerializerProtocol | None = None) -> None:
        self.serde = maybe_add_typed_methods(serde or self.serde)

    # ==================== åŒæ­¥æ–¹æ³• ====================
    
    def get(self, config: RunnableConfig) -> Checkpoint | None:
        """è·å–æ£€æŸ¥ç‚¹ï¼ˆç®€åŒ–ç‰ˆï¼Œåªè¿”å› Checkpointï¼‰"""
        if value := self.get_tuple(config):
            return value.checkpoint

    def get_tuple(self, config: RunnableConfig) -> CheckpointTuple | None:
        """è·å–å®Œæ•´çš„æ£€æŸ¥ç‚¹å…ƒç»„ï¼ˆåŒ…å« configã€metadata ç­‰ï¼‰
        
        å­ç±»å¿…é¡»å®ç°æ­¤æ–¹æ³•ï¼
        """
        raise NotImplementedError

    def list(
        self,
        config: RunnableConfig | None,
        *,
        filter: dict[str, Any] | None = None,
        before: RunnableConfig | None = None,
        limit: int | None = None,
    ) -> Iterator[CheckpointTuple]:
        """åˆ—å‡ºç¬¦åˆæ¡ä»¶çš„æ£€æŸ¥ç‚¹
        
        Args:
            config: è¿‡æ»¤é…ç½®ï¼ˆthread_id ç­‰ï¼‰
            filter: å…ƒæ•°æ®è¿‡æ»¤æ¡ä»¶
            before: åœ¨æ­¤æ£€æŸ¥ç‚¹ä¹‹å‰
            limit: æœ€å¤§è¿”å›æ•°é‡
        """
        raise NotImplementedError

    def put(
        self,
        config: RunnableConfig,
        checkpoint: Checkpoint,
        metadata: CheckpointMetadata,
        new_versions: ChannelVersions,
    ) -> RunnableConfig:
        """ä¿å­˜æ£€æŸ¥ç‚¹
        
        Returns:
            æ›´æ–°åçš„é…ç½®ï¼ˆåŒ…å«æ–°çš„ checkpoint_idï¼‰
        """
        raise NotImplementedError

    def put_writes(
        self,
        config: RunnableConfig,
        writes: Sequence[tuple[str, Any]],
        task_id: str,
        task_path: str = "",
    ) -> None:
        """ä¿å­˜ä¸­é—´å†™å…¥ï¼ˆç”¨äºå¢é‡æ›´æ–°ï¼‰"""
        raise NotImplementedError

    def delete_thread(self, thread_id: str) -> None:
        """åˆ é™¤æŒ‡å®š thread çš„æ‰€æœ‰æ£€æŸ¥ç‚¹"""
        raise NotImplementedError

    # ==================== å¼‚æ­¥æ–¹æ³• ====================
    # aget, aget_tuple, alist, aput, aput_writes, adelete_thread
    # ï¼ˆä¸åŒæ­¥æ–¹æ³•å¯¹åº”çš„å¼‚æ­¥ç‰ˆæœ¬ï¼‰

    # ==================== ç‰ˆæœ¬æ§åˆ¶ ====================
    
    def get_next_version(self, current: V | None, channel: None) -> V:
        """ç”Ÿæˆ channel çš„ä¸‹ä¸€ä¸ªç‰ˆæœ¬å·
        
        é»˜è®¤ä½¿ç”¨æ•´æ•°ç‰ˆæœ¬ï¼Œæ¯æ¬¡ +1
        å¯ä»¥é‡å†™ä¸ºä½¿ç”¨ str/int/floatï¼Œåªè¦å•è°ƒé€’å¢å³å¯
        """
        if isinstance(current, str):
            raise NotImplementedError
        elif current is None:
            return 1
        else:
            return current + 1
```

### 3.2 æ ¸å¿ƒæ¥å£å…³ç³»å›¾

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                                                                                                  â•‘
â•‘                          BaseCheckpointSaver æ¥å£å…³ç³»å›¾                                           â•‘
â•‘                                                                                                  â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                                                                  â•‘
â•‘                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                 â•‘
â•‘                              â”‚     BaseCheckpointSaver         â”‚                                 â•‘
â•‘                              â”‚         (æŠ½è±¡åŸºç±»)               â”‚                                 â•‘
â•‘                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                 â•‘
â•‘                                           â”‚                                                      â•‘
â•‘                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                               â•‘
â•‘                    â”‚                      â”‚                      â”‚                               â•‘
â•‘                    â–¼                      â–¼                      â–¼                               â•‘
â•‘   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â•‘
â•‘   â”‚    InMemorySaver        â”‚  â”‚    SqliteSaver      â”‚  â”‚   PostgresSaver     â”‚                  â•‘
â•‘   â”‚      (å†…å­˜å­˜å‚¨)          â”‚  â”‚    (SQLite å­˜å‚¨)    â”‚  â”‚  (PostgreSQL å­˜å‚¨)  â”‚                  â•‘
â•‘   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â•‘
â•‘                                                                                                  â•‘
â•‘   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•    â•‘
â•‘                                                                                                  â•‘
â•‘   æ ¸å¿ƒæ–¹æ³•è°ƒç”¨æµç¨‹ï¼š                                                                              â•‘
â•‘                                                                                                  â•‘
â•‘   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â•‘
â•‘   â”‚                                                                                          â”‚   â•‘
â•‘   â”‚   agent.invoke(input, config)                                                            â”‚   â•‘
â•‘   â”‚          â”‚                                                                               â”‚   â•‘
â•‘   â”‚          â”‚  1. åŠ è½½æ£€æŸ¥ç‚¹                                                                â”‚   â•‘
â•‘   â”‚          â–¼                                                                               â”‚   â•‘
â•‘   â”‚   checkpointer.get_tuple(config)  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚   â•‘
â•‘   â”‚          â”‚                                                              â”‚                â”‚   â•‘
â•‘   â”‚          â”‚  è¿”å›: CheckpointTuple (åŒ…å«å†å²çŠ¶æ€)                         â”‚                â”‚   â•‘
â•‘   â”‚          â”‚        æˆ– None (æ–°å¯¹è¯)                                       â”‚                â”‚   â•‘
â•‘   â”‚          â–¼                                                              â”‚                â”‚   â•‘
â•‘   â”‚   åˆå¹¶è¾“å…¥åˆ° state["messages"]                                           â”‚                â”‚   â•‘
â•‘   â”‚          â”‚                                                              â”‚                â”‚   â•‘
â•‘   â”‚          â”‚  2. æ‰§è¡Œå›¾èŠ‚ç‚¹                                                â”‚                â”‚   â•‘
â•‘   â”‚          â–¼                                                              â”‚                â”‚   â•‘
â•‘   â”‚   model_node / tools_node æ‰§è¡Œ                                          â”‚                â”‚   â•‘
â•‘   â”‚          â”‚                                                              â”‚                â”‚   â•‘
â•‘   â”‚          â”‚  3. ä¿å­˜æ£€æŸ¥ç‚¹                                                â”‚                â”‚   â•‘
â•‘   â”‚          â–¼                                                              â”‚                â”‚   â•‘
â•‘   â”‚   checkpointer.put(config, checkpoint, metadata, new_versions)          â”‚                â”‚   â•‘
â•‘   â”‚          â”‚                                                              â”‚                â”‚   â•‘
â•‘   â”‚          â”‚  4. ä¿å­˜ä¸­é—´å†™å…¥ï¼ˆå¯é€‰ï¼‰                                       â”‚                â”‚   â•‘
â•‘   â”‚          â–¼                                                              â”‚                â”‚   â•‘
â•‘   â”‚   checkpointer.put_writes(config, writes, task_id)                      â”‚                â”‚   â•‘
â•‘   â”‚          â”‚                                                              â”‚                â”‚   â•‘
â•‘   â”‚          â”‚  5. å¾ªç¯ç›´åˆ°ç»“æŸ                                               â”‚                â”‚   â•‘
â•‘   â”‚          â–¼                                                              â–¼                â”‚   â•‘
â•‘   â”‚   è¿”å›æœ€ç»ˆ state                                                  å®Œæˆä¿å­˜               â”‚   â•‘
â•‘   â”‚                                                                                          â”‚   â•‘
â•‘   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â•‘
â•‘                                                                                                  â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

---

## å››ã€ä¸‰ç§ Checkpointer å®ç°è¯¦è§£

### 4.1 InMemorySaverï¼ˆå†…å­˜å­˜å‚¨ï¼‰

æ¥æºï¼š`langgraph/libs/checkpoint/langgraph/checkpoint/memory/__init__.py`

```python
class InMemorySaver(
    BaseCheckpointSaver[str], AbstractContextManager, AbstractAsyncContextManager
):
    """An in-memory checkpoint saver.

    Note:
        Only use `InMemorySaver` for debugging or testing purposes.
        For production use cases we recommend installing langgraph-checkpoint-postgres.
    """

    # å­˜å‚¨ç»“æ„ï¼šthread_id -> checkpoint_ns -> checkpoint_id -> checkpoint æ•°æ®
    storage: defaultdict[
        str,                                           # thread_id
        dict[str,                                      # checkpoint_ns
            dict[str,                                  # checkpoint_id
                tuple[                                 # (checkpoint, metadata, parent_id)
                    tuple[str, bytes],                 # checkpoint (type, serialized)
                    tuple[str, bytes],                 # metadata (type, serialized)
                    str | None                         # parent_checkpoint_id
                ]
            ]
        ]
    ]

    # å†™å…¥å­˜å‚¨ï¼š(thread_id, checkpoint_ns, checkpoint_id) -> (task_id, idx) -> write
    writes: defaultdict[
        tuple[str, str, str],                          # (thread_id, ns, checkpoint_id)
        dict[tuple[str, int],                          # (task_id, write_idx)
            tuple[str, str, tuple[str, bytes], str]    # (task_id, channel, value, task_path)
        ]
    ]

    # Blob å­˜å‚¨ï¼š(thread_id, ns, channel, version) -> (type, bytes)
    blobs: dict[
        tuple[str, str, str, str | int | float],
        tuple[str, bytes]
    ]
```

**InMemorySaver å­˜å‚¨ç»“æ„å¯è§†åŒ–ï¼š**

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                                                                                                  â•‘
â•‘                            InMemorySaver å†…éƒ¨å­˜å‚¨ç»“æ„                                             â•‘
â•‘                                                                                                  â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                                                                  â•‘
â•‘   storage (ä¸»å­˜å‚¨)                                                                               â•‘
â•‘   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•    â•‘
â•‘                                                                                                  â•‘
â•‘   {                                                                                              â•‘
â•‘       "user-123-conv-1": {                           â† thread_id                                â•‘
â•‘           "": {                                      â† checkpoint_ns (ç©ºå­—ç¬¦ä¸² = ä¸»å›¾)           â•‘
â•‘               "1ef4f797-8335-6428...": (            â† checkpoint_id                             â•‘
â•‘                   ("json", b'{"v":2,...}'),          â† checkpoint (åºåˆ—åŒ–å)                    â•‘
â•‘                   ("json", b'{"source":"loop"}'),   â† metadata (åºåˆ—åŒ–å)                       â•‘
â•‘                   "1ef4f797-8334-6427..."            â† parent_checkpoint_id                     â•‘
â•‘               ),                                                                                â•‘
â•‘               "1ef4f797-8334-6427...": (...),       â† æ›´æ—©çš„æ£€æŸ¥ç‚¹                              â•‘
â•‘           }                                                                                     â•‘
â•‘       },                                                                                        â•‘
â•‘       "user-456-conv-2": {                           â† å¦ä¸€ä¸ª thread                            â•‘
â•‘           "": {...}                                                                             â•‘
â•‘       }                                                                                         â•‘
â•‘   }                                                                                              â•‘
â•‘                                                                                                  â•‘
â•‘   blobs (å¤§å¯¹è±¡å­˜å‚¨)                                                                             â•‘
â•‘   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•    â•‘
â•‘                                                                                                  â•‘
â•‘   {                                                                                              â•‘
â•‘       ("user-123-conv-1", "", "messages", "3.0.123"): (                                          â•‘
â•‘           "json",                                    â† åºåˆ—åŒ–ç±»å‹                                â•‘
â•‘           b'[{"type":"human",...},...]'              â† messages åˆ—è¡¨ï¼ˆåºåˆ—åŒ–åï¼‰                 â•‘
â•‘       ),                                                                                        â•‘
â•‘       ("user-123-conv-1", "", "todos", "1.0.456"): (                                             â•‘
â•‘           "json",                                                                                â•‘
â•‘           b'[{"id":1,...},...]'                      â† todos åˆ—è¡¨ï¼ˆåºåˆ—åŒ–åï¼‰                    â•‘
â•‘       ),                                                                                        â•‘
â•‘   }                                                                                              â•‘
â•‘                                                                                                  â•‘
â•‘   writes (ä¸­é—´å†™å…¥å­˜å‚¨)                                                                          â•‘
â•‘   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•    â•‘
â•‘                                                                                                  â•‘
â•‘   {                                                                                              â•‘
â•‘       ("user-123-conv-1", "", "1ef4f797-8335..."): { â† (thread_id, ns, checkpoint_id)           â•‘
â•‘           ("task-001", 0): (                         â† (task_id, write_idx)                     â•‘
â•‘               "task-001",                                                                       â•‘
â•‘               "messages",                            â† channel åç§°                             â•‘
â•‘               ("json", b'[...]'),                    â† å†™å…¥å€¼ï¼ˆåºåˆ—åŒ–åï¼‰                        â•‘
â•‘               "model"                                â† task_path                                â•‘
â•‘           ),                                                                                    â•‘
â•‘       }                                                                                         â•‘
â•‘   }                                                                                              â•‘
â•‘                                                                                                  â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

### 4.2 SqliteSaverï¼ˆSQLite å­˜å‚¨ï¼‰

æ¥æºï¼š`langgraph/libs/checkpoint-sqlite/langgraph/checkpoint/sqlite/__init__.py`

```python
class SqliteSaver(BaseCheckpointSaver[str]):
    """A checkpoint saver that stores checkpoints in a SQLite database.

    Note:
        This class is meant for lightweight, synchronous use cases
        (demos and small projects) and does not scale to multiple threads.
    """

    conn: sqlite3.Connection
    is_setup: bool
    lock: threading.Lock

    @classmethod
    @contextmanager
    def from_conn_string(cls, conn_string: str) -> Iterator[SqliteSaver]:
        """ä»è¿æ¥å­—ç¬¦ä¸²åˆ›å»º SqliteSaver
        
        Examples:
            In memory:
                with SqliteSaver.from_conn_string(":memory:") as memory:
                    ...

            To disk:
                with SqliteSaver.from_conn_string("checkpoints.sqlite") as memory:
                    ...
        """
        with closing(
            sqlite3.connect(conn_string, check_same_thread=False)
        ) as conn:
            yield cls(conn)

    def setup(self) -> None:
        """åˆ›å»ºå¿…è¦çš„æ•°æ®åº“è¡¨"""
        self.conn.executescript("""
            PRAGMA journal_mode=WAL;
            
            CREATE TABLE IF NOT EXISTS checkpoints (
                thread_id TEXT NOT NULL,
                checkpoint_ns TEXT NOT NULL DEFAULT '',
                checkpoint_id TEXT NOT NULL,
                parent_checkpoint_id TEXT,
                type TEXT,
                checkpoint BLOB,
                metadata BLOB,
                PRIMARY KEY (thread_id, checkpoint_ns, checkpoint_id)
            );
            
            CREATE TABLE IF NOT EXISTS writes (
                thread_id TEXT NOT NULL,
                checkpoint_ns TEXT NOT NULL DEFAULT '',
                checkpoint_id TEXT NOT NULL,
                task_id TEXT NOT NULL,
                idx INTEGER NOT NULL,
                channel TEXT NOT NULL,
                type TEXT,
                value BLOB,
                PRIMARY KEY (thread_id, checkpoint_ns, checkpoint_id, task_id, idx)
            );
        """)
```

**SQLite è¡¨ç»“æ„ï¼š**

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                                                                                                  â•‘
â•‘                             SqliteSaver æ•°æ®åº“è¡¨ç»“æ„                                              â•‘
â•‘                                                                                                  â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                                                                  â•‘
â•‘   checkpoints è¡¨                                                                                 â•‘
â•‘   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â•‘
â•‘   â”‚ å­—æ®µ                  â”‚ ç±»å‹          â”‚ è¯´æ˜                                              â”‚   â•‘
â•‘   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â•‘
â•‘   â”‚ thread_id            â”‚ TEXT NOT NULL â”‚ å¯¹è¯çº¿ç¨‹ ID                                       â”‚   â•‘
â•‘   â”‚ checkpoint_ns        â”‚ TEXT NOT NULL â”‚ å‘½åç©ºé—´ï¼ˆå­å›¾ç”¨ï¼Œé»˜è®¤ç©ºï¼‰                          â”‚   â•‘
â•‘   â”‚ checkpoint_id        â”‚ TEXT NOT NULL â”‚ æ£€æŸ¥ç‚¹å”¯ä¸€ ID                                     â”‚   â•‘
â•‘   â”‚ parent_checkpoint_id â”‚ TEXT          â”‚ çˆ¶æ£€æŸ¥ç‚¹ IDï¼ˆç”¨äºå†å²å›æº¯ï¼‰                        â”‚   â•‘
â•‘   â”‚ type                 â”‚ TEXT          â”‚ åºåˆ—åŒ–ç±»å‹ï¼ˆå¦‚ "json"ï¼‰                           â”‚   â•‘
â•‘   â”‚ checkpoint           â”‚ BLOB          â”‚ åºåˆ—åŒ–åçš„æ£€æŸ¥ç‚¹æ•°æ®                              â”‚   â•‘
â•‘   â”‚ metadata             â”‚ BLOB          â”‚ åºåˆ—åŒ–åçš„å…ƒæ•°æ®                                  â”‚   â•‘
â•‘   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â•‘
â•‘   PRIMARY KEY (thread_id, checkpoint_ns, checkpoint_id)                                          â•‘
â•‘                                                                                                  â•‘
â•‘   writes è¡¨                                                                                      â•‘
â•‘   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â•‘
â•‘   â”‚ å­—æ®µ                  â”‚ ç±»å‹          â”‚ è¯´æ˜                                              â”‚   â•‘
â•‘   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â•‘
â•‘   â”‚ thread_id            â”‚ TEXT NOT NULL â”‚ å¯¹è¯çº¿ç¨‹ ID                                       â”‚   â•‘
â•‘   â”‚ checkpoint_ns        â”‚ TEXT NOT NULL â”‚ å‘½åç©ºé—´                                          â”‚   â•‘
â•‘   â”‚ checkpoint_id        â”‚ TEXT NOT NULL â”‚ å…³è”çš„æ£€æŸ¥ç‚¹ ID                                   â”‚   â•‘
â•‘   â”‚ task_id              â”‚ TEXT NOT NULL â”‚ ä»»åŠ¡ ID                                          â”‚   â•‘
â•‘   â”‚ idx                  â”‚ INTEGER       â”‚ å†™å…¥ç´¢å¼•                                          â”‚   â•‘
â•‘   â”‚ channel              â”‚ TEXT NOT NULL â”‚ é€šé“åç§°ï¼ˆå¦‚ "messages"ï¼‰                         â”‚   â•‘
â•‘   â”‚ type                 â”‚ TEXT          â”‚ åºåˆ—åŒ–ç±»å‹                                        â”‚   â•‘
â•‘   â”‚ value                â”‚ BLOB          â”‚ åºåˆ—åŒ–åçš„å€¼                                      â”‚   â•‘
â•‘   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â•‘
â•‘   PRIMARY KEY (thread_id, checkpoint_ns, checkpoint_id, task_id, idx)                            â•‘
â•‘                                                                                                  â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

### 4.3 PostgresSaverï¼ˆPostgreSQL å­˜å‚¨ï¼‰

æ¥æºï¼š`langgraph/libs/checkpoint-postgres/langgraph/checkpoint/postgres/__init__.py`

```python
class PostgresSaver(BasePostgresSaver):
    """Checkpointer that stores checkpoints in a Postgres database."""

    lock: threading.Lock

    @classmethod
    @contextmanager
    def from_conn_string(
        cls, conn_string: str, *, pipeline: bool = False
    ) -> Iterator[PostgresSaver]:
        """Create a new PostgresSaver instance from a connection string.

        Args:
            conn_string: The Postgres connection info string.
            pipeline: whether to use Pipeline

        Returns:
            PostgresSaver: A new PostgresSaver instance.
        """
        with Connection.connect(
            conn_string, autocommit=True, prepare_threshold=0, row_factory=dict_row
        ) as conn:
            if pipeline:
                with conn.pipeline() as pipe:
                    yield cls(conn, pipe)
            else:
                yield cls(conn)

    def setup(self) -> None:
        """Set up the checkpoint database.
        
        This method creates the necessary tables in the Postgres database 
        if they don't already exist and runs database migrations.
        It MUST be called directly by the user the first time checkpointer is used.
        """
        # æ‰§è¡Œè¿ç§»è„šæœ¬...
```

### 4.4 ä¸‰ç§å®ç°å¯¹æ¯”

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                                                                                                  â•‘
â•‘                             ä¸‰ç§ Checkpointer å®ç°å¯¹æ¯”                                            â•‘
â•‘                                                                                                  â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                                                                  â•‘
â•‘   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â•‘
â•‘   â”‚ ç‰¹æ€§             â”‚ InMemorySaver       â”‚ SqliteSaver          â”‚ PostgresSaver            â”‚    â•‘
â•‘   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â•‘
â•‘   â”‚ æŒä¹…åŒ–           â”‚ âŒ è¿›ç¨‹ç»“æŸå³ä¸¢å¤±    â”‚ âœ… æ–‡ä»¶æŒä¹…åŒ–         â”‚ âœ… æ•°æ®åº“æŒä¹…åŒ–           â”‚    â•‘
â•‘   â”‚ å¤šçº¿ç¨‹           â”‚ âœ… æ”¯æŒ              â”‚ âš ï¸ å•çº¿ç¨‹å»ºè®®         â”‚ âœ… æ”¯æŒ                   â”‚    â•‘
â•‘   â”‚ å¼‚æ­¥æ”¯æŒ         â”‚ âœ… æ”¯æŒ              â”‚ âš ï¸ éœ€è¦ aiosqlite    â”‚ âœ… AsyncPostgresSaver    â”‚    â•‘
â•‘   â”‚ åˆ†å¸ƒå¼           â”‚ âŒ å•è¿›ç¨‹             â”‚ âŒ å•æœº               â”‚ âœ… æ”¯æŒ                   â”‚    â•‘
â•‘   â”‚ é€‚ç”¨åœºæ™¯         â”‚ å¼€å‘/æµ‹è¯•            â”‚ å°å‹é¡¹ç›®/å•ç”¨æˆ·       â”‚ ç”Ÿäº§ç¯å¢ƒ                  â”‚    â•‘
â•‘   â”‚ å®‰è£…è¦æ±‚         â”‚ å†…ç½®                 â”‚ å†…ç½®                  â”‚ pip install              â”‚    â•‘
â•‘   â”‚                 â”‚                     â”‚                      â”‚ langgraph-checkpoint-    â”‚    â•‘
â•‘   â”‚                 â”‚                     â”‚                      â”‚ postgres                 â”‚    â•‘
â•‘   â”‚ æ€§èƒ½             â”‚ ğŸš€ æœ€å¿«              â”‚ ğŸƒ ä¸­ç­‰               â”‚ ğŸƒ ä¸­ç­‰ï¼ˆç½‘ç»œå¼€é”€ï¼‰        â”‚    â•‘
â•‘   â”‚ æ•°æ®æ¢å¤         â”‚ âŒ ä¸æ”¯æŒ             â”‚ âœ… æ”¯æŒ               â”‚ âœ… æ”¯æŒ + å¤‡ä»½            â”‚    â•‘
â•‘   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â•‘
â•‘                                                                                                  â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

---

## äº”ã€åºåˆ—åŒ–æœºåˆ¶ï¼ˆSerdeï¼‰

### 5.1 JsonPlusSerializer

æ¥æºï¼š`langgraph/libs/checkpoint/langgraph/checkpoint/serde/jsonplus.py`

```python
class JsonPlusSerializer(SerializerProtocol):
    """Serializer that uses ormsgpack, with optional fallbacks.

    !!! warning
        Security note: This serializer is intended for use within BaseCheckpointSaver
        and called within the Pregel loop. It should not be used on untrusted
        python objects. If an attacker can write directly to your checkpoint database,
        they may be able to trigger code execution when data is deserialized.
    """

    def __init__(
        self,
        *,
        pickle_fallback: bool = False,
        allowed_json_modules: Sequence[tuple[str, ...]] | Literal[True] | None = None,
    ) -> None:
        self.pickle_fallback = pickle_fallback
        # ...

    def dumps_typed(self, obj: Any) -> tuple[str, bytes]:
        """åºåˆ—åŒ–å¯¹è±¡ï¼Œè¿”å› (ç±»å‹, å­—èŠ‚)
        
        Returns:
            tuple[str, bytes]: (åºåˆ—åŒ–ç±»å‹, åºåˆ—åŒ–åçš„å­—èŠ‚)
        """
        # ...

    def loads_typed(self, data: tuple[str, bytes]) -> Any:
        """ååºåˆ—åŒ–å¯¹è±¡
        
        Args:
            data: (åºåˆ—åŒ–ç±»å‹, åºåˆ—åŒ–åçš„å­—èŠ‚)
        
        Returns:
            Any: ååºåˆ—åŒ–åçš„å¯¹è±¡
        """
        # ...
```

**æ”¯æŒçš„åºåˆ—åŒ–ç±»å‹ï¼š**

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                                                                                                  â•‘
â•‘                            JsonPlusSerializer æ”¯æŒçš„ç±»å‹                                          â•‘
â•‘                                                                                                  â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                                                                  â•‘
â•‘   åŸç”Ÿæ”¯æŒç±»å‹ï¼š                                                                                  â•‘
â•‘   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â•‘
â•‘   â”‚  â€¢ åŸºç¡€ç±»å‹ï¼šstr, int, float, bool, None                                                 â”‚   â•‘
â•‘   â”‚  â€¢ é›†åˆç±»å‹ï¼šlist, dict, tuple, set, frozenset                                           â”‚   â•‘
â•‘   â”‚  â€¢ æ—¥æœŸæ—¶é—´ï¼šdatetime, date, time, timedelta, timezone, ZoneInfo                         â”‚   â•‘
â•‘   â”‚  â€¢ æ•°å€¼ç±»å‹ï¼šDecimal, complex                                                            â”‚   â•‘
â•‘   â”‚  â€¢ äºŒè¿›åˆ¶ï¼šbytes, bytearray                                                              â”‚   â•‘
â•‘   â”‚  â€¢ ç½‘ç»œç±»å‹ï¼šIPv4Address, IPv4Network, IPv6Address, IPv6Network ç­‰                        â”‚   â•‘
â•‘   â”‚  â€¢ è·¯å¾„ç±»å‹ï¼špathlib.Path                                                                â”‚   â•‘
â•‘   â”‚  â€¢ æšä¸¾ï¼šEnum å­ç±»                                                                        â”‚   â•‘
â•‘   â”‚  â€¢ UUIDï¼šuuid.UUID                                                                       â”‚   â•‘
â•‘   â”‚  â€¢ æ­£åˆ™ï¼šre.Pattern                                                                      â”‚   â•‘
â•‘   â”‚  â€¢ dataclassesï¼šè‡ªåŠ¨åºåˆ—åŒ–                                                               â”‚   â•‘
â•‘   â”‚  â€¢ Pydanticï¼šBaseModel å­ç±»                                                              â”‚   â•‘
â•‘   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â•‘
â•‘                                                                                                  â•‘
â•‘   LangChain ç‰¹æ®Šç±»å‹ï¼š                                                                           â•‘
â•‘   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â•‘
â•‘   â”‚  â€¢ HumanMessage, AIMessage, SystemMessage, ToolMessage                                   â”‚   â•‘
â•‘   â”‚  â€¢ ToolCall, InvalidToolCall                                                             â”‚   â•‘
â•‘   â”‚  â€¢ Document                                                                              â”‚   â•‘
â•‘   â”‚  â€¢ å…¶ä»– LangChain å¯¹è±¡ï¼ˆé€šè¿‡ lc_serializable æ¥å£ï¼‰                                       â”‚   â•‘
â•‘   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â•‘
â•‘                                                                                                  â•‘
â•‘   åºåˆ—åŒ–æ ¼å¼ï¼š                                                                                    â•‘
â•‘   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â•‘
â•‘   â”‚  â€¢ ä½¿ç”¨ ormsgpackï¼ˆé«˜æ€§èƒ½ MessagePack åº“ï¼‰                                                â”‚   â•‘
â•‘   â”‚  â€¢ æ”¯æŒ pickle å›é€€ï¼ˆéœ€è¦æ˜¾å¼å¯ç”¨ï¼Œä¸æ¨èï¼‰                                                â”‚   â•‘
â•‘   â”‚  â€¢ è¾“å‡ºï¼š(type: str, data: bytes) å…ƒç»„                                                   â”‚   â•‘
â•‘   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â•‘
â•‘                                                                                                  â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

---

## å…­ã€å®Œæ•´æ•°æ®æµï¼ˆæºç çº§ï¼‰

### 6.1 Agent è°ƒç”¨æ—¶çš„æ£€æŸ¥ç‚¹æµç¨‹

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                                                                                                  â•‘
â•‘                         Agent è°ƒç”¨æ—¶çš„å®Œæ•´æ£€æŸ¥ç‚¹æµç¨‹                                               â•‘
â•‘                                                                                                  â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                                                                  â•‘
â•‘   ç”¨æˆ·è°ƒç”¨                                                                                        â•‘
â•‘   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â•‘
â•‘   â”‚                                                                                              â•‘
â•‘   â”‚  agent.invoke(                                                                               â•‘
â•‘   â”‚      {"messages": [HumanMessage("ä½ å¥½")]},                                                   â•‘
â•‘   â”‚      config={"configurable": {"thread_id": "conv-123"}}                                      â•‘
â•‘   â”‚  )                                                                                           â•‘
â•‘   â”‚                                                                                              â•‘
â•‘   â–¼                                                                                              â•‘
â•‘   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â•‘
â•‘   â•‘ é˜¶æ®µ 1: æ£€æŸ¥ç‚¹åŠ è½½                                                                       â•‘   â•‘
â•‘   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â•‘
â•‘   â”‚                                                                                              â•‘
â•‘   â”‚  1. LangGraph ä» config æå– thread_id = "conv-123"                                         â•‘
â•‘   â”‚                                                                                              â•‘
â•‘   â”‚  2. è°ƒç”¨ checkpointer.get_tuple(config)                                                     â•‘
â•‘   â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â•‘
â•‘   â”‚     â”‚  InMemorySaver.get_tuple():                                                     â”‚     â•‘
â•‘   â”‚     â”‚                                                                                 â”‚     â•‘
â•‘   â”‚     â”‚  thread_id = config["configurable"]["thread_id"]  # "conv-123"                  â”‚     â•‘
â•‘   â”‚     â”‚  checkpoint_ns = config["configurable"].get("checkpoint_ns", "")  # ""          â”‚     â•‘
â•‘   â”‚     â”‚                                                                                 â”‚     â•‘
â•‘   â”‚     â”‚  # è·å–è¯¥ thread æœ€æ–°çš„æ£€æŸ¥ç‚¹                                                   â”‚     â•‘
â•‘   â”‚     â”‚  if checkpoints := self.storage[thread_id][checkpoint_ns]:                      â”‚     â•‘
â•‘   â”‚     â”‚      checkpoint_id = max(checkpoints.keys())  # æœ€æ–°çš„ ID                       â”‚     â•‘
â•‘   â”‚     â”‚      checkpoint, metadata, parent_id = checkpoints[checkpoint_id]               â”‚     â•‘
â•‘   â”‚     â”‚                                                                                 â”‚     â•‘
â•‘   â”‚     â”‚      # ååºåˆ—åŒ–                                                                 â”‚     â•‘
â•‘   â”‚     â”‚      checkpoint_ = self.serde.loads_typed(checkpoint)                           â”‚     â•‘
â•‘   â”‚     â”‚      channel_values = self._load_blobs(thread_id, checkpoint_ns, versions)      â”‚     â•‘
â•‘   â”‚     â”‚                                                                                 â”‚     â•‘
â•‘   â”‚     â”‚      return CheckpointTuple(                                                    â”‚     â•‘
â•‘   â”‚     â”‚          config=...,                                                            â”‚     â•‘
â•‘   â”‚     â”‚          checkpoint={**checkpoint_, "channel_values": channel_values},          â”‚     â•‘
â•‘   â”‚     â”‚          metadata=...,                                                          â”‚     â•‘
â•‘   â”‚     â”‚          parent_config=...,                                                     â”‚     â•‘
â•‘   â”‚     â”‚          pending_writes=...                                                     â”‚     â•‘
â•‘   â”‚     â”‚      )                                                                          â”‚     â•‘
â•‘   â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â•‘
â•‘   â”‚                                                                                              â•‘
â•‘   â”‚  3. æ¢å¤çŠ¶æ€                                                                                 â•‘
â•‘   â”‚     state = {                                                                                â•‘
â•‘   â”‚         "messages": [                                                                        â•‘
â•‘   â”‚             HumanMessage("ä¹‹å‰çš„é—®é¢˜"),   â† ä»æ£€æŸ¥ç‚¹æ¢å¤                                      â•‘
â•‘   â”‚             AIMessage("ä¹‹å‰çš„å›ç­”"),                                                         â•‘
â•‘   â”‚         ],                                                                                   â•‘
â•‘   â”‚         "todos": [...],                   â† å…¶ä»–çŠ¶æ€ä¹Ÿæ¢å¤                                   â•‘
â•‘   â”‚     }                                                                                        â•‘
â•‘   â”‚                                                                                              â•‘
â•‘   â”‚  4. åˆå¹¶ç”¨æˆ·è¾“å…¥ï¼ˆä½¿ç”¨ add_messages reducerï¼‰                                                â•‘
â•‘   â”‚     state["messages"].append(HumanMessage("ä½ å¥½"))                                           â•‘
â•‘   â”‚                                                                                              â•‘
â•‘   â–¼                                                                                              â•‘
â•‘   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â•‘
â•‘   â•‘ é˜¶æ®µ 2: å›¾æ‰§è¡Œ                                                                           â•‘   â•‘
â•‘   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â•‘
â•‘   â”‚                                                                                              â•‘
â•‘   â”‚  model_node æ‰§è¡Œ:                                                                            â•‘
â•‘   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â•‘
â•‘   â”‚  â”‚  def model_node(state, runtime):                                                 â”‚        â•‘
â•‘   â”‚  â”‚      request = ModelRequest(                                                     â”‚        â•‘
â•‘   â”‚  â”‚          model=model,                                                            â”‚        â•‘
â•‘   â”‚  â”‚          messages=state["messages"],  # â† åŒ…å«å®Œæ•´å†å²ï¼                          â”‚        â•‘
â•‘   â”‚  â”‚          ...                                                                     â”‚        â•‘
â•‘   â”‚  â”‚      )                                                                           â”‚        â•‘
â•‘   â”‚  â”‚      response = model.invoke(request.messages)                                   â”‚        â•‘
â•‘   â”‚  â”‚      return {"messages": [response]}  # â† è¿”å›æ–°æ¶ˆæ¯                             â”‚        â•‘
â•‘   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â•‘
â•‘   â”‚                                                                                              â•‘
â•‘   â”‚  add_messages reducer è‡ªåŠ¨è¿½åŠ :                                                              â•‘
â•‘   â”‚  state["messages"] = [                                                                       â•‘
â•‘   â”‚      HumanMessage("ä¹‹å‰çš„é—®é¢˜"),                                                             â•‘
â•‘   â”‚      AIMessage("ä¹‹å‰çš„å›ç­”"),                                                                â•‘
â•‘   â”‚      HumanMessage("ä½ å¥½"),                                                                   â•‘
â•‘   â”‚      AIMessage("ä½ å¥½ï¼æœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©ä½ çš„å—ï¼Ÿ"),  â† æ–°è¿½åŠ                                      â•‘
â•‘   â”‚  ]                                                                                           â•‘
â•‘   â”‚                                                                                              â•‘
â•‘   â–¼                                                                                              â•‘
â•‘   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â•‘
â•‘   â•‘ é˜¶æ®µ 3: æ£€æŸ¥ç‚¹ä¿å­˜                                                                       â•‘   â•‘
â•‘   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â•‘
â•‘   â”‚                                                                                              â•‘
â•‘   â”‚  æ¯ä¸ªèŠ‚ç‚¹æ‰§è¡Œåï¼Œè‡ªåŠ¨ä¿å­˜æ£€æŸ¥ç‚¹:                                                              â•‘
â•‘   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â•‘
â•‘   â”‚  â”‚  InMemorySaver.put():                                                            â”‚        â•‘
â•‘   â”‚  â”‚                                                                                  â”‚        â•‘
â•‘   â”‚  â”‚  thread_id = config["configurable"]["thread_id"]                                 â”‚        â•‘
â•‘   â”‚  â”‚  checkpoint_ns = config["configurable"]["checkpoint_ns"]                         â”‚        â•‘
â•‘   â”‚  â”‚                                                                                  â”‚        â•‘
â•‘   â”‚  â”‚  # åˆ†ç¦» channel_valuesï¼ˆå­˜åˆ° blobsï¼‰                                             â”‚        â•‘
â•‘   â”‚  â”‚  values = checkpoint.pop("channel_values")                                       â”‚        â•‘
â•‘   â”‚  â”‚  for k, v in new_versions.items():                                               â”‚        â•‘
â•‘   â”‚  â”‚      self.blobs[(thread_id, checkpoint_ns, k, v)] = (                            â”‚        â•‘
â•‘   â”‚  â”‚          self.serde.dumps_typed(values[k])                                       â”‚        â•‘
â•‘   â”‚  â”‚      )                                                                           â”‚        â•‘
â•‘   â”‚  â”‚                                                                                  â”‚        â•‘
â•‘   â”‚  â”‚  # ä¿å­˜æ£€æŸ¥ç‚¹                                                                    â”‚        â•‘
â•‘   â”‚  â”‚  self.storage[thread_id][checkpoint_ns][checkpoint["id"]] = (                    â”‚        â•‘
â•‘   â”‚  â”‚      self.serde.dumps_typed(checkpoint),                                         â”‚        â•‘
â•‘   â”‚  â”‚      self.serde.dumps_typed(metadata),                                           â”‚        â•‘
â•‘   â”‚  â”‚      parent_checkpoint_id,                                                       â”‚        â•‘
â•‘   â”‚  â”‚  )                                                                               â”‚        â•‘
â•‘   â”‚  â”‚                                                                                  â”‚        â•‘
â•‘   â”‚  â”‚  return updated_config  # åŒ…å«æ–°çš„ checkpoint_id                                 â”‚        â•‘
â•‘   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â•‘
â•‘   â”‚                                                                                              â•‘
â•‘   â–¼                                                                                              â•‘
â•‘   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â•‘
â•‘   â•‘ é˜¶æ®µ 4: è¿”å›ç»“æœ                                                                         â•‘   â•‘
â•‘   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â•‘
â•‘   â”‚                                                                                              â•‘
â•‘   â”‚  è¿”å›æœ€ç»ˆ state:                                                                             â•‘
â•‘   â”‚  {                                                                                           â•‘
â•‘   â”‚      "messages": [å®Œæ•´å¯¹è¯å†å²...],                                                          â•‘
â•‘   â”‚      "todos": [...],                                                                         â•‘
â•‘   â”‚      ...                                                                                     â•‘
â•‘   â”‚  }                                                                                           â•‘
â•‘   â”‚                                                                                              â•‘
â•‘   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â•‘
â•‘                                                                                                  â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

### 6.2 thread_id éš”ç¦»æœºåˆ¶

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                                                                                                  â•‘
â•‘                            thread_id éš”ç¦»æœºåˆ¶                                                     â•‘
â•‘                                                                                                  â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                                                                  â•‘
â•‘   ç”¨æˆ· A å¯¹è¯ (thread_id = "user-A-conv-1")                                                      â•‘
â•‘   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•    â•‘
â•‘                                                                                                  â•‘
â•‘   agent.invoke({"messages": [HumanMessage("æˆ‘å«å¼ ä¸‰")]},                                         â•‘
â•‘                config={"configurable": {"thread_id": "user-A-conv-1"}})                          â•‘
â•‘                                                                                                  â•‘
â•‘   å­˜å‚¨ä½ç½®:                                                                                       â•‘
â•‘   storage["user-A-conv-1"][""][checkpoint_id] = {                                                â•‘
â•‘       "channel_values": {                                                                        â•‘
â•‘           "messages": [HumanMessage("æˆ‘å«å¼ ä¸‰"), AIMessage("ä½ å¥½å¼ ä¸‰ï¼")]                         â•‘
â•‘       }                                                                                          â•‘
â•‘   }                                                                                              â•‘
â•‘                                                                                                  â•‘
â•‘   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â•‘
â•‘                                                                                                  â•‘
â•‘   ç”¨æˆ· B å¯¹è¯ (thread_id = "user-B-conv-1")                                                      â•‘
â•‘   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•    â•‘
â•‘                                                                                                  â•‘
â•‘   agent.invoke({"messages": [HumanMessage("æˆ‘å«æå››")]},                                         â•‘
â•‘                config={"configurable": {"thread_id": "user-B-conv-1"}})                          â•‘
â•‘                                                                                                  â•‘
â•‘   å­˜å‚¨ä½ç½®ï¼ˆå®Œå…¨ç‹¬ç«‹ï¼ï¼‰:                                                                          â•‘
â•‘   storage["user-B-conv-1"][""][checkpoint_id] = {                                                â•‘
â•‘       "channel_values": {                                                                        â•‘
â•‘           "messages": [HumanMessage("æˆ‘å«æå››"), AIMessage("ä½ å¥½æå››ï¼")]                         â•‘
â•‘       }                                                                                          â•‘
â•‘   }                                                                                              â•‘
â•‘                                                                                                  â•‘
â•‘   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â•‘
â•‘                                                                                                  â•‘
â•‘   ç”¨æˆ· A ç»§ç»­å¯¹è¯ (ç›¸åŒ thread_id)                                                                â•‘
â•‘   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•    â•‘
â•‘                                                                                                  â•‘
â•‘   agent.invoke({"messages": [HumanMessage("æˆ‘å«ä»€ä¹ˆï¼Ÿ")]},                                       â•‘
â•‘                config={"configurable": {"thread_id": "user-A-conv-1"}})                          â•‘
â•‘                                                                                                  â•‘
â•‘   1. ä» storage["user-A-conv-1"] åŠ è½½å†å²                                                        â•‘
â•‘   2. AI çœ‹åˆ°: [HumanMessage("æˆ‘å«å¼ ä¸‰"), AIMessage("ä½ å¥½å¼ ä¸‰ï¼"), HumanMessage("æˆ‘å«ä»€ä¹ˆï¼Ÿ")]     â•‘
â•‘   3. AI å›ç­”: "ä½ å«å¼ ä¸‰ï¼"  â† æ­£ç¡®å›å¿†ï¼                                                          â•‘
â•‘                                                                                                  â•‘
â•‘   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â•‘
â•‘                                                                                                  â•‘
â•‘   ç”¨æˆ· A æ–°å¯¹è¯ (æ–° thread_id)                                                                   â•‘
â•‘   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•    â•‘
â•‘                                                                                                  â•‘
â•‘   agent.invoke({"messages": [HumanMessage("æˆ‘å«ä»€ä¹ˆï¼Ÿ")]},                                       â•‘
â•‘                config={"configurable": {"thread_id": "user-A-conv-2"}})  â† æ–° thread!           â•‘
â•‘                                                                                                  â•‘
â•‘   1. storage["user-A-conv-2"] ä¸å­˜åœ¨ï¼Œåˆå§‹åŒ–ç©ºçŠ¶æ€                                                â•‘
â•‘   2. AI åªçœ‹åˆ°: [HumanMessage("æˆ‘å«ä»€ä¹ˆï¼Ÿ")]                                                     â•‘
â•‘   3. AI å›ç­”: "æŠ±æ­‰ï¼Œä½ è¿˜æ²¡å‘Šè¯‰æˆ‘ä½ çš„åå­—"  â† æ²¡æœ‰å†å²è®°å¿†ï¼                                       â•‘
â•‘                                                                                                  â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

---

## ä¸ƒã€ç”¨æˆ·å¯ç”¨çš„æ¥å£

### 7.1 create_agent çš„ checkpointer å‚æ•°

æ¥æºï¼š`libs/langchain_v1/langchain/agents/factory.py`

```python
def create_agent(
    model: LanguageModelLike,
    tools: Sequence[BaseTool | Callable[..., Any]] = (),
    *,
    # ... å…¶ä»–å‚æ•° ...
    checkpointer: Checkpointer | None = None,  # â† çŸ­æœŸè®°å¿†
    store: BaseStore | None = None,             # â† é•¿æœŸè®°å¿†
    # ...
) -> CompiledGraph:
    """
    Args:
        checkpointer: An optional checkpoint saver object.

            Used for persisting the state of the graph (e.g., as chat memory) for a
            single thread (e.g., a single conversation).
        store: An optional store object.

            Used for persisting data across multiple threads (e.g., multiple
            conversations / users).
    """
    # ...
    return graph.compile(
        checkpointer=checkpointer,  # â† ä¼ é€’ç»™å›¾ç¼–è¯‘
        store=store,
        # ...
    )
```

### 7.2 å®Œæ•´ä½¿ç”¨ç¤ºä¾‹

```python
from langchain.agents import create_agent
from langchain_core.messages import HumanMessage
from langgraph.checkpoint.memory import MemorySaver

# ==================== 1. åˆ›å»º Checkpointer ====================

# æ–¹å¼ 1: å†…å­˜å­˜å‚¨ï¼ˆå¼€å‘/æµ‹è¯•ï¼‰
checkpointer = MemorySaver()

# æ–¹å¼ 2: SQLite å­˜å‚¨ï¼ˆå°å‹é¡¹ç›®ï¼‰
from langgraph.checkpoint.sqlite import SqliteSaver
with SqliteSaver.from_conn_string("chat.db") as checkpointer:
    # ... ä½¿ç”¨ checkpointer ...
    pass

# æ–¹å¼ 3: PostgreSQL å­˜å‚¨ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
from langgraph.checkpoint.postgres import PostgresSaver
DB_URI = "postgres://user:pass@localhost:5432/dbname"
with PostgresSaver.from_conn_string(DB_URI) as checkpointer:
    checkpointer.setup()  # â† é¦–æ¬¡ä½¿ç”¨éœ€è¦è°ƒç”¨ï¼
    # ... ä½¿ç”¨ checkpointer ...
    pass


# ==================== 2. åˆ›å»ºå¸¦è®°å¿†çš„ Agent ====================

agent = create_agent(
    model="openai:gpt-4o",
    tools=[],
    system_prompt="ä½ æ˜¯ä¸€ä¸ªå‹å¥½çš„åŠ©æ‰‹ã€‚",
    checkpointer=checkpointer,  # â† å¯ç”¨çŸ­æœŸè®°å¿†
)


# ==================== 3. å¯¹è¯ï¼ˆè‡ªåŠ¨ä¿å­˜/åŠ è½½è®°å¿†ï¼‰====================

# å®šä¹‰å¯¹è¯çº¿ç¨‹ ID
config = {"configurable": {"thread_id": "user-123-conversation-1"}}

# ç¬¬ä¸€è½®å¯¹è¯
result1 = agent.invoke(
    {"messages": [HumanMessage(content="æˆ‘å«å¼ ä¸‰ï¼Œæˆ‘å–œæ¬¢ç¼–ç¨‹")]},
    config=config,
)
print(result1["messages"][-1].content)
# è¾“å‡º: "ä½ å¥½å¼ ä¸‰ï¼å¾ˆé«˜å…´è®¤è¯†ä¸€ä½å–œæ¬¢ç¼–ç¨‹çš„æœ‹å‹ï¼"

# ç¬¬äºŒè½®å¯¹è¯ - Agent ä¼šè®°ä½ä¹‹å‰çš„å¯¹è¯
result2 = agent.invoke(
    {"messages": [HumanMessage(content="æˆ‘å«ä»€ä¹ˆåå­—ï¼Ÿæˆ‘å–œæ¬¢ä»€ä¹ˆï¼Ÿ")]},
    config=config,  # â† ä½¿ç”¨ç›¸åŒçš„ thread_id
)
print(result2["messages"][-1].content)
# è¾“å‡º: "ä½ å«å¼ ä¸‰ï¼Œä½ å–œæ¬¢ç¼–ç¨‹ï¼"


# ==================== 4. æŸ¥çœ‹å¯¹è¯å†å² ====================

# æ–¹å¼ 1: ä»ç»“æœè·å–
for msg in result2["messages"]:
    print(f"{msg.__class__.__name__}: {msg.content}")

# æ–¹å¼ 2: ç›´æ¥ä» checkpointer è·å–
checkpoint_tuple = checkpointer.get_tuple(config)
if checkpoint_tuple:
    messages = checkpoint_tuple.checkpoint["channel_values"]["messages"]
    for msg in messages:
        print(f"{msg.__class__.__name__}: {msg.content}")


# ==================== 5. åˆ—å‡ºæ‰€æœ‰æ£€æŸ¥ç‚¹ ====================

for checkpoint in checkpointer.list(config, limit=10):
    print(f"ID: {checkpoint.config['configurable']['checkpoint_id']}")
    print(f"Step: {checkpoint.metadata.get('step', 'N/A')}")
    print(f"Source: {checkpoint.metadata.get('source', 'N/A')}")
    print("---")


# ==================== 6. åˆ é™¤å¯¹è¯å†å² ====================

# åˆ é™¤æŒ‡å®š thread çš„æ‰€æœ‰æ£€æŸ¥ç‚¹
checkpointer.delete_thread("user-123-conversation-1")


# ==================== 7. å›æº¯åˆ°å†å²çŠ¶æ€ ====================

# è·å–æŒ‡å®šæ£€æŸ¥ç‚¹
specific_config = {
    "configurable": {
        "thread_id": "user-123-conversation-1",
        "checkpoint_id": "1ef4f797-8335-6428-8001-8a1503f9b875"  # ç‰¹å®šæ£€æŸ¥ç‚¹ ID
    }
}
historical_state = checkpointer.get_tuple(specific_config)


# ==================== 8. æ–°å¯¹è¯ï¼ˆç‹¬ç«‹è®°å¿†ï¼‰====================

new_config = {"configurable": {"thread_id": "user-123-conversation-2"}}  # æ–° thread

result3 = agent.invoke(
    {"messages": [HumanMessage(content="æˆ‘å«ä»€ä¹ˆï¼Ÿ")]},
    config=new_config,  # â† æ–°çš„ thread_id
)
print(result3["messages"][-1].content)
# è¾“å‡º: "æŠ±æ­‰ï¼Œä½ è¿˜æ²¡æœ‰å‘Šè¯‰æˆ‘ä½ çš„åå­—ã€‚"  â† æ²¡æœ‰ä¹‹å‰å¯¹è¯çš„è®°å¿†ï¼
```

### 7.3 é«˜çº§ç”¨æ³•

```python
# ==================== å¸¦å‘½åç©ºé—´çš„æ£€æŸ¥ç‚¹ï¼ˆå­å›¾åœºæ™¯ï¼‰====================

config_with_ns = {
    "configurable": {
        "thread_id": "main-thread",
        "checkpoint_ns": "sub_agent_1"  # â† å‘½åç©ºé—´
    }
}

# ==================== æµå¼è·å–çŠ¶æ€æ›´æ–° ====================

for chunk in agent.stream(
    {"messages": [HumanMessage(content="è®²ä¸ªæ•…äº‹")]},
    config=config,
    stream_mode="values"  # è¿”å›å®Œæ•´çŠ¶æ€
):
    print(chunk["messages"][-1].content)


# ==================== å¼‚æ­¥ä½¿ç”¨ ====================

import asyncio

async def chat():
    result = await agent.ainvoke(
        {"messages": [HumanMessage(content="ä½ å¥½")]},
        config=config,
    )
    return result

asyncio.run(chat())
```

---

## å…«ã€å¸¸è§é—®é¢˜å’Œæœ€ä½³å®è·µ

### 8.1 thread_id è®¾è®¡å»ºè®®

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                                                                                                  â•‘
â•‘                            thread_id è®¾è®¡æ¨¡å¼                                                     â•‘
â•‘                                                                                                  â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                                                                  â•‘
â•‘   æ¨èæ¨¡å¼ï¼š                                                                                      â•‘
â•‘   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â•‘
â•‘   â”‚                                                                                          â”‚   â•‘
â•‘   â”‚  1. ç”¨æˆ· + ä¼šè¯æ¨¡å¼:                                                                     â”‚   â•‘
â•‘   â”‚     thread_id = f"{user_id}-{session_id}"                                                â”‚   â•‘
â•‘   â”‚     ä¾‹: "user-123-session-abc"                                                           â”‚   â•‘
â•‘   â”‚                                                                                          â”‚   â•‘
â•‘   â”‚  2. ç”¨æˆ· + æ—¶é—´æˆ³æ¨¡å¼:                                                                    â”‚   â•‘
â•‘   â”‚     thread_id = f"{user_id}-{timestamp}"                                                 â”‚   â•‘
â•‘   â”‚     ä¾‹: "user-123-1702200000"                                                            â”‚   â•‘
â•‘   â”‚                                                                                          â”‚   â•‘
â•‘   â”‚  3. ä¸šåŠ¡åœºæ™¯æ¨¡å¼:                                                                         â”‚   â•‘
â•‘   â”‚     thread_id = f"{business_type}-{business_id}"                                         â”‚   â•‘
â•‘   â”‚     ä¾‹: "order-12345" "support-ticket-789"                                               â”‚   â•‘
â•‘   â”‚                                                                                          â”‚   â•‘
â•‘   â”‚  4. UUID æ¨¡å¼ï¼ˆç®€å•åœºæ™¯ï¼‰:                                                                â”‚   â•‘
â•‘   â”‚     thread_id = str(uuid.uuid4())                                                        â”‚   â•‘
â•‘   â”‚     ä¾‹: "1ef4f797-8335-6428-8001-8a1503f9b875"                                           â”‚   â•‘
â•‘   â”‚                                                                                          â”‚   â•‘
â•‘   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â•‘
â•‘                                                                                                  â•‘
â•‘   æ³¨æ„äº‹é¡¹ï¼š                                                                                      â•‘
â•‘   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â•‘
â•‘   â”‚  â€¢ thread_id å¿…é¡»æ˜¯å­—ç¬¦ä¸²                                                                â”‚   â•‘
â•‘   â”‚  â€¢ å»ºè®®åŒ…å«ç”¨æˆ·æ ‡è¯†ï¼Œä¾¿äºç®¡ç†å’Œæ¸…ç†                                                       â”‚   â•‘
â•‘   â”‚  â€¢ é¿å…ä½¿ç”¨æ•æ„Ÿä¿¡æ¯ï¼ˆå¦‚æ‰‹æœºå·ã€é‚®ç®±ï¼‰                                                     â”‚   â•‘
â•‘   â”‚  â€¢ è€ƒè™‘åŠ å…¥è¿‡æœŸæœºåˆ¶ï¼Œå®šæœŸæ¸…ç†å†å²å¯¹è¯                                                     â”‚   â•‘
â•‘   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â•‘
â•‘                                                                                                  â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

### 8.2 Checkpointer é€‰æ‹©æŒ‡å—

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                                                                                                  â•‘
â•‘                            Checkpointer é€‰æ‹©å†³ç­–æ ‘                                                â•‘
â•‘                                                                                                  â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                                                                  â•‘
â•‘                               æ˜¯å¦éœ€è¦æŒä¹…åŒ–ï¼Ÿ                                                    â•‘
â•‘                                    â”‚                                                             â•‘
â•‘                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                  â•‘
â•‘                         â”‚                     â”‚                                                  â•‘
â•‘                        å¦                    æ˜¯                                                  â•‘
â•‘                         â”‚                     â”‚                                                  â•‘
â•‘                         â–¼                     â–¼                                                  â•‘
â•‘               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      æ˜¯å¦éœ€è¦åˆ†å¸ƒå¼ï¼Ÿ                                           â•‘
â•‘               â”‚  InMemorySaver  â”‚            â”‚                                                   â•‘
â•‘               â”‚   (å¼€å‘/æµ‹è¯•)   â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”                                           â•‘
â•‘               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚               â”‚                                           â•‘
â•‘                                     å¦              æ˜¯                                           â•‘
â•‘                                      â”‚               â”‚                                           â•‘
â•‘                                      â–¼               â–¼                                           â•‘
â•‘                             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                             â•‘
â•‘                             â”‚  SqliteSaver    â”‚  â”‚ PostgresSaver   â”‚                             â•‘
â•‘                             â”‚ (å°å‹é¡¹ç›®/å•æœº) â”‚  â”‚  (ç”Ÿäº§ç¯å¢ƒ)     â”‚                             â•‘
â•‘                             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                             â•‘
â•‘                                                                                                  â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

---

## ä¹ã€æ€»ç»“

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                                                                                                  â•‘
â•‘                         LangChain v1 çŸ­æœŸè®°å¿†æœºåˆ¶æ€»ç»“                                              â•‘
â•‘                                                                                                  â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                                                                  â•‘
â•‘   1. ä»€ä¹ˆæ˜¯çŸ­æœŸè®°å¿†ï¼Ÿ                                                                             â•‘
â•‘      â€¢ å•ä¸ªå¯¹è¯çº¿ç¨‹å†…çš„çŠ¶æ€æŒä¹…åŒ–                                                                 â•‘
â•‘      â€¢ ä¸»è¦å­˜å‚¨ state["messages"]ï¼ˆå¯¹è¯å†å²ï¼‰                                                    â•‘
â•‘      â€¢ é€šè¿‡ thread_id éš”ç¦»ä¸åŒå¯¹è¯                                                               â•‘
â•‘                                                                                                  â•‘
â•‘   2. æ ¸å¿ƒæ•°æ®ç»“æ„                                                                                 â•‘
â•‘      â€¢ Checkpoint: çŠ¶æ€å¿«ç…§ï¼ˆchannel_valuesã€versions ç­‰ï¼‰                                       â•‘
â•‘      â€¢ CheckpointMetadata: å…ƒæ•°æ®ï¼ˆsourceã€stepã€parentsï¼‰                                       â•‘
â•‘      â€¢ CheckpointTuple: å®Œæ•´å…ƒç»„ï¼ˆconfigã€checkpointã€metadataã€parentï¼‰                         â•‘
â•‘                                                                                                  â•‘
â•‘   3. ä¸‰ç§å®ç°                                                                                     â•‘
â•‘      â€¢ InMemorySaver: å†…å­˜å­˜å‚¨ï¼Œå¼€å‘æµ‹è¯•ç”¨                                                       â•‘
â•‘      â€¢ SqliteSaver: SQLite å­˜å‚¨ï¼Œå°å‹é¡¹ç›®ç”¨                                                      â•‘
â•‘      â€¢ PostgresSaver: PostgreSQL å­˜å‚¨ï¼Œç”Ÿäº§ç¯å¢ƒç”¨                                                â•‘
â•‘                                                                                                  â•‘
â•‘   4. æ•°æ®æµ                                                                                       â•‘
â•‘      â€¢ invoke å¼€å§‹ â†’ checkpointer.get_tuple() â†’ åŠ è½½å†å²çŠ¶æ€                                     â•‘
â•‘      â€¢ èŠ‚ç‚¹æ‰§è¡Œ â†’ çŠ¶æ€æ›´æ–° â†’ checkpointer.put() â†’ ä¿å­˜æ£€æŸ¥ç‚¹                                     â•‘
â•‘      â€¢ å®Œå…¨è‡ªåŠ¨ï¼Œç”¨æˆ·æ— æ„Ÿ                                                                        â•‘
â•‘                                                                                                  â•‘
â•‘   5. ç”¨æˆ·æ¥å£                                                                                     â•‘
â•‘      â€¢ create_agent(checkpointer=...) å¯ç”¨çŸ­æœŸè®°å¿†                                               â•‘
â•‘      â€¢ invoke(config={"configurable": {"thread_id": ...}}) æŒ‡å®šå¯¹è¯                              â•‘
â•‘      â€¢ checkpointer.list/get_tuple/delete_thread ç®¡ç†æ£€æŸ¥ç‚¹                                      â•‘
â•‘                                                                                                  â•‘
â•‘   6. å…³é”®æºç ä½ç½®                                                                                 â•‘
â•‘      â€¢ BaseCheckpointSaver: langgraph/checkpoint/base/__init__.py                               â•‘
â•‘      â€¢ InMemorySaver: langgraph/checkpoint/memory/__init__.py                                   â•‘
â•‘      â€¢ SqliteSaver: langgraph/checkpoint/sqlite/__init__.py                                     â•‘
â•‘      â€¢ PostgresSaver: langgraph/checkpoint/postgres/__init__.py                                 â•‘
â•‘      â€¢ JsonPlusSerializer: langgraph/checkpoint/serde/jsonplus.py                               â•‘
â•‘                                                                                                  â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```
