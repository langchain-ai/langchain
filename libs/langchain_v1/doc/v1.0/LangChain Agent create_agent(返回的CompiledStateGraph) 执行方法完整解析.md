# LangChain Agent create_agent(è¿”å›çš„CompiledStateGraph) æ‰§è¡Œæ–¹æ³•å®Œæ•´è§£æ

## ä¸€ã€æ–¹æ³•ç­¾åæ€»è§ˆ

`create_agent` è¿”å›çš„æ˜¯ `CompiledStateGraph`ï¼Œå®ƒç»§æ‰¿è‡ª LangGraphï¼Œæä¾›å››ä¸ªæ‰§è¡Œæ–¹æ³•ï¼š

```python
# æºç ä½ç½®: langgraph/libs/langgraph/langgraph/pregel/main.py

# åŒæ­¥æ–¹æ³•
def invoke(input, config, *, context, stream_mode, ...) -> dict[str, Any]
def stream(input, config, *, context, stream_mode, ...) -> Iterator[...]

# å¼‚æ­¥æ–¹æ³•
async def ainvoke(input, config, *, context, stream_mode, ...) -> dict[str, Any]
async def astream(input, config, *, context, stream_mode, ...) -> AsyncIterator[...]
```

---

## äºŒã€å‚æ•°å®Œæ•´å®šä¹‰

### ç»Ÿä¸€å‡½æ•°ç­¾åï¼ˆä»¥ astream ä¸ºä¾‹ï¼‰

```python
async def astream(
    self,
    input: InputT | Command | None,           # â‘  çŠ¶æ€è¾“å…¥
    config: RunnableConfig | None = None,      # â‘¡ è¿è¡Œé…ç½®
    *,
    context: ContextT | None = None,           # â‘¢ è¿è¡Œæ—¶ä¸Šä¸‹æ–‡
    stream_mode: StreamMode | Sequence[StreamMode] | None = None,
    print_mode: StreamMode | Sequence[StreamMode] = (),
    output_keys: str | Sequence[str] | None = None,
    interrupt_before: All | Sequence[str] | None = None,
    interrupt_after: All | Sequence[str] | None = None,
    durability: Durability | None = None,
    subgraphs: bool = False,
    debug: bool | None = None,
    **kwargs,
) -> AsyncIterator[dict[str, Any] | Any]:
```

---

## ä¸‰ã€æ ¸å¿ƒå‚æ•°è¯¦è§£

### å‚æ•° â‘ ï¼š`input` - çŠ¶æ€è¾“å…¥

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  input: InputT | Command | None                                                                    â”‚
â”‚                                                                                                     â”‚
â”‚  ç±»å‹è¯´æ˜ï¼š                                                                                          â”‚
â”‚  â€¢ InputT = _InputAgentState = TypedDict("messages": list[AnyMessage | dict])                      â”‚
â”‚  â€¢ å¯¹äº create_agentï¼Œå¿…é¡»åŒ…å« messages å­—æ®µ                                                         â”‚
â”‚  â€¢ å¯ä»¥åŒ…å«ä¸­é—´ä»¶æ‰©å±•çš„å…¶ä»–å­—æ®µï¼ˆå¦‚ attachmentsï¼‰                                                      â”‚
â”‚                                                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æºç å®šä¹‰**ï¼ˆ`langchain_v1/langchain/agents/middleware/types.py` ç¬¬ 312-315 è¡Œï¼‰ï¼š

```python
class _InputAgentState(TypedDict):
    """Input state schema for the agent."""
    messages: Required[Annotated[list[AnyMessage | dict], add_messages]]
```

**æ•°æ®ç»“æ„ç¤ºä¾‹**ï¼š

```python
# åŸºç¡€ç”¨æ³•
input = {
    "messages": [
        {"role": "user", "content": "ä½ å¥½"},
        # æˆ–ä½¿ç”¨ Message å¯¹è±¡
        HumanMessage(content="ä½ å¥½"),
    ]
}

# æ‰©å±•ç”¨æ³•ï¼ˆå¦‚æœä¸­é—´ä»¶å®šä¹‰äº† attachmentsï¼‰
input = {
    "messages": [HumanMessage(content="è¯·åˆ†æè¿™ä»½æ–‡ä»¶")],
    "attachments": [
        {"file_id": "001", "file_name": "report.pdf", "markdown": "# æŠ¥å‘Šå†…å®¹...", "status": "parsed"}
    ]
}
```

---

### å‚æ•° â‘¡ï¼š`config` - è¿è¡Œé…ç½®

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  config: RunnableConfig | None                                                                     â”‚
â”‚                                                                                                     â”‚
â”‚  æ¥æº: langchain_core/runnables/config.py ç¬¬ 49-103 è¡Œ                                              â”‚
â”‚                                                                                                     â”‚
â”‚  class RunnableConfig(TypedDict, total=False):                                                     â”‚
â”‚      tags: list[str]                    # æ ‡ç­¾ï¼Œç”¨äºè¿‡æ»¤                                             â”‚
â”‚      metadata: dict[str, Any]           # å…ƒæ•°æ®                                                    â”‚
â”‚      callbacks: Callbacks               # å›è°ƒå‡½æ•°                                                  â”‚
â”‚      run_name: str                      # è¿è¡Œåç§°                                                  â”‚
â”‚      max_concurrency: int | None        # æœ€å¤§å¹¶å‘æ•°                                                â”‚
â”‚      recursion_limit: int               # é€’å½’é™åˆ¶ (é»˜è®¤ 25)                                        â”‚
â”‚      configurable: dict[str, Any]       # â˜… å…³é”®ï¼šå¯é…ç½®é¡¹ï¼ˆåŒ…å« thread_idï¼‰                         â”‚
â”‚      run_id: uuid.UUID | None           # è¿è¡Œ ID                                                   â”‚
â”‚                                                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**`configurable` å­å­—æ®µè¯¦è§£**ï¼š

| å­—æ®µ | ç±»å‹ | ç”¨é€” | é‡è¦ç¨‹åº¦ |
|------|------|------|---------|
| `thread_id` | `str` | **Checkpointer è¯†åˆ«å¯¹è¯çº¿ç¨‹** | â­â­â­ å¿…éœ€ï¼ˆå¦‚æœç”¨è®°å¿†ï¼‰ |
| `user_id` | `str` | ç”¨æˆ·æ ‡è¯† | å¯é€‰ |
| å…¶ä»–è‡ªå®šä¹‰ | `Any` | åº”ç”¨å±‚è‡ªå®šä¹‰é…ç½® | å¯é€‰ |

**æ•°æ®ç»“æ„ç¤ºä¾‹**ï¼š

```python
config = {
    "configurable": {
        "thread_id": "conversation-123",  # â˜… Checkpointer å¿…éœ€
        "user_id": "user-456",
    },
    "recursion_limit": 100,  # é˜²æ­¢æ— é™å¾ªç¯
    "tags": ["production"],
    "metadata": {"request_id": "req-789"},
}
```

---

### å‚æ•° â‘¢ï¼š`context` - è¿è¡Œæ—¶ä¸Šä¸‹æ–‡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  context: ContextT | None                                                                          â”‚
â”‚                                                                                                     â”‚
â”‚  æ¥æº: langgraph/runtime.py ç¬¬ 28-101 è¡Œ                                                            â”‚
â”‚                                                                                                     â”‚
â”‚  Context ä¼šè¢«åŒ…è£…åˆ° Runtime å¯¹è±¡ä¸­ï¼š                                                                  â”‚
â”‚                                                                                                     â”‚
â”‚  @dataclass                                                                                        â”‚
â”‚  class Runtime(Generic[ContextT]):                                                                 â”‚
â”‚      context: ContextT          # â˜… ä½ ä¼ å…¥çš„ context åœ¨è¿™é‡Œ                                          â”‚
â”‚      store: BaseStore | None    # é•¿æœŸå­˜å‚¨                                                          â”‚
â”‚      stream_writer: StreamWriter # æµå¼å†™å…¥å™¨                                                       â”‚
â”‚      previous: Any              # ä¸Šä¸€æ¬¡è¿”å›å€¼                                                       â”‚
â”‚                                                                                                     â”‚
â”‚  ä¸­é—´ä»¶é€šè¿‡ request.runtime.context è®¿é—®                                                             â”‚
â”‚                                                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Context çš„ä½¿ç”¨åœºæ™¯**ï¼ˆç”¨æˆ·è‡ªå®šä¹‰ schemaï¼‰ï¼š

```python
from dataclasses import dataclass

@dataclass
class MyContext:
    user_id: str
    model: str = "openai/gpt-4o"
    system_prompt: str = "ä½ æ˜¯ä¸€ä¸ªåŠ©æ‰‹"
    tools: list[str] = field(default_factory=list)

# åˆ›å»º agent æ—¶æŒ‡å®š context_schema
agent = create_agent(
    model="openai:gpt-4o",
    tools=[...],
    context_schema=MyContext,
)

# è°ƒç”¨æ—¶ä¼ å…¥ context
result = await agent.ainvoke(
    {"messages": [...]},
    context=MyContext(user_id="123", model="deepseek/deepseek-chat"),
)
```

**ä¸­é—´ä»¶å¦‚ä½•è®¿é—® Context**ï¼ˆ`context_middlewares.py`ï¼‰ï¼š

```python
@dynamic_prompt
def context_aware_prompt(request: ModelRequest) -> str:
    return request.runtime.context.system_prompt  # â† ä»è¿™é‡Œè¯»å–

@wrap_model_call
async def context_based_model(request, handler):
    model_spec = request.runtime.context.model  # â† ä»è¿™é‡Œè¯»å–
    model = load_chat_model(model_spec)
    request = request.override(model=model)
    return await handler(request)
```

---

### å‚æ•° â‘£ï¼š`stream_mode` - æµå¼æ¨¡å¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  stream_mode: StreamMode | Sequence[StreamMode] | None                                             â”‚
â”‚                                                                                                     â”‚
â”‚  StreamMode = Literal["values", "updates", "custom", "messages", "checkpoints", "tasks", "debug"]  â”‚
â”‚                                                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

| æ¨¡å¼ | è¾“å‡ºå†…å®¹ | å…¸å‹ç”¨é€” |
|------|---------|---------|
| `"values"` | æ¯æ­¥åçš„**å®Œæ•´ State** | è·å–æœ€ç»ˆç»“æœ |
| `"updates"` | **èŠ‚ç‚¹å + è¯¥èŠ‚ç‚¹çš„æ›´æ–°** | è°ƒè¯•ã€æŸ¥çœ‹æ‰§è¡Œæµç¨‹ |
| `"messages"` | **LLM token + metadata** (2-tuple) | æµå¼èŠå¤©ç•Œé¢ |
| `"custom"` | é€šè¿‡ `StreamWriter` è‡ªå®šä¹‰è¾“å‡º | è‡ªå®šä¹‰æ•°æ®æµ |
| `"checkpoints"` | Checkpoint åˆ›å»ºäº‹ä»¶ | ç›‘æ§çŠ¶æ€ä¿å­˜ |
| `"tasks"` | ä»»åŠ¡å¼€å§‹/å®Œæˆäº‹ä»¶ | ç›‘æ§æ‰§è¡Œè¿›åº¦ |
| `"debug"` | è¯¦ç»†è°ƒè¯•ä¿¡æ¯ | å¼€å‘è°ƒè¯• |

**å¤šæ¨¡å¼ç»„åˆ**ï¼š

```python
# åŒæ—¶è·å–å¤šç§è¾“å‡º
async for chunk in agent.astream(
    {"messages": [...]},
    stream_mode=["values", "messages"],  # ç»„åˆæ¨¡å¼
):
    # chunk æ˜¯ (mode, data) å…ƒç»„
    mode, data = chunk
    if mode == "messages":
        print(data[0].content, end="")  # æµå¼è¾“å‡º token
    elif mode == "values":
        final_result = data  # å®Œæ•´ç»“æœ
```

---

### å…¶ä»–å‚æ•°

| å‚æ•° | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `output_keys` | `str \| Sequence[str]` | æŒ‡å®šè¾“å‡ºå“ªäº› state å­—æ®µ |
| `interrupt_before` | `list[str]` | åœ¨è¿™äº›èŠ‚ç‚¹**ä¹‹å‰**æš‚åœï¼ˆäººå·¥å®¡æ‰¹ï¼‰ |
| `interrupt_after` | `list[str]` | åœ¨è¿™äº›èŠ‚ç‚¹**ä¹‹å**æš‚åœ |
| `durability` | `"sync" \| "async" \| "exit"` | Checkpoint æŒä¹…åŒ–æ¨¡å¼ |
| `subgraphs` | `bool` | æ˜¯å¦æµå¼è¾“å‡ºå­å›¾ |
| `debug` | `bool` | å¯ç”¨è°ƒè¯•æ—¥å¿— |

---

## å››ã€å®Œæ•´æ•°æ®æµå›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              create_agent æ‰§è¡Œæ–¹æ³•æ•°æ®æµ                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                                        ç”¨æˆ·è°ƒç”¨
                                            â”‚
                                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  graph.astream(                                                                                    â”‚
â”‚      input = {"messages": [...], "attachments": [...]},  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚      config = {"configurable": {"thread_id": "xxx"}, ...}, â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”                    â”‚
â”‚      context = MyContext(user_id="123", model="gpt-4o"),  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”                â”‚
â”‚      stream_mode = "messages",                                            â”‚   â”‚   â”‚                â”‚
â”‚  )                                                                        â”‚   â”‚   â”‚                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                                            â”‚   â”‚   â”‚
                                                                            â–¼   â–¼   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                      LangGraph æ‰§è¡Œå¼•æ“                                              â”‚
â”‚                                                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                                    æ•°æ®åˆ†å‘                                                     â”‚â”‚
â”‚  â”‚                                                                                                â”‚â”‚
â”‚  â”‚  input â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º State                    â”‚â”‚
â”‚  â”‚  {"messages": [...], "attachments": [...]}                            (æŒä¹…åŒ–ï¼Œä¼šè¢« Checkpointerâ”‚â”‚
â”‚  â”‚                                                                        ä¿å­˜å’Œæ¢å¤)              â”‚â”‚
â”‚  â”‚                                                                                                â”‚â”‚
â”‚  â”‚  config.configurable â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º Checkpointer             â”‚â”‚
â”‚  â”‚  {"thread_id": "xxx", "user_id": "123"}                               (é€šè¿‡ thread_id è¯†åˆ«å¯¹è¯) â”‚â”‚
â”‚  â”‚                                                                                                â”‚â”‚
â”‚  â”‚  context â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º Runtime.context          â”‚â”‚
â”‚  â”‚  MyContext(user_id="123", model="gpt-4o")                             (ä¸æŒä¹…åŒ–ï¼Œæ¯æ¬¡ä¼ å…¥)      â”‚â”‚
â”‚  â”‚                                                                                                â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                               â”‚                                                     â”‚
â”‚                                               â–¼                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                                    ä¸­é—´ä»¶å¤„ç†                                                   â”‚â”‚
â”‚  â”‚                                                                                                â”‚â”‚
â”‚  â”‚  request.state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º è¯»å– attachments â”€â”€â–º inject_attachment_context              â”‚â”‚
â”‚  â”‚                                                                                                â”‚â”‚
â”‚  â”‚  request.runtime.context â”€â”€â”€â”€â”€â”€â”€â–º è¯»å– system_prompt â”€â–º context_aware_prompt                  â”‚â”‚
â”‚  â”‚                                   è¯»å– model â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º context_based_model                   â”‚â”‚
â”‚  â”‚                                   è¯»å– tools/mcps â”€â”€â”€â”€â–º DynamicToolMiddleware                 â”‚â”‚
â”‚  â”‚                                                                                                â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                               â”‚                                                     â”‚
â”‚                                               â–¼                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                                   Agent æ‰§è¡Œå¾ªç¯                                                â”‚â”‚
â”‚  â”‚                                                                                                â”‚â”‚
â”‚  â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                    â”‚â”‚
â”‚  â”‚     â”‚ Checkpointerâ”‚     â”‚    Model    â”‚     â”‚   Tools     â”‚                                    â”‚â”‚
â”‚  â”‚     â”‚ æ¢å¤å†å²çŠ¶æ€  â”‚â”€â”€â”€â”€â–ºâ”‚    Node     â”‚â”€â”€â”€â”€â–ºâ”‚   Node      â”‚â”€â”€â”                                 â”‚â”‚
â”‚  â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                                 â”‚â”‚
â”‚  â”‚                               â”‚                    â”‚          â”‚                                 â”‚â”‚
â”‚  â”‚                               â–¼                    â–¼          â”‚                                 â”‚â”‚
â”‚  â”‚                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚                                 â”‚â”‚
â”‚  â”‚                         â”‚         ğŸ¤– LLM               â”‚      â”‚                                 â”‚â”‚
â”‚  â”‚                         â”‚    (ç”± context.model å†³å®š)    â”‚â—„â”€â”€â”€â”€â”€â”˜ å¾ªç¯                            â”‚â”‚
â”‚  â”‚                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                       â”‚â”‚
â”‚  â”‚                                                                                                â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                               â”‚                                                     â”‚
â”‚                                               â–¼                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                                    è¾“å‡ºæµ                                                       â”‚â”‚
â”‚  â”‚                                                                                                â”‚â”‚
â”‚  â”‚  stream_mode="values"   â”€â”€â”€â”€â”€â”€â–º {"messages": [...å…¨éƒ¨æ¶ˆæ¯...]}                                  â”‚â”‚
â”‚  â”‚  stream_mode="updates"  â”€â”€â”€â”€â”€â”€â–º {"model": {"messages": [AIMessage(...)]}}                      â”‚â”‚
â”‚  â”‚  stream_mode="messages" â”€â”€â”€â”€â”€â”€â–º (AIMessageChunk(...), {"langgraph_node": "model"})             â”‚â”‚
â”‚  â”‚                                                                                                â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## äº”ã€å››ç§æ–¹æ³•çš„åŒºåˆ«

| æ–¹æ³• | åŒæ­¥/å¼‚æ­¥ | è¿”å›ç±»å‹ | å…¸å‹åœºæ™¯ |
|------|---------|---------|---------|
| `invoke()` | åŒæ­¥ | `dict` (æœ€ç»ˆç»“æœ) | ç®€å•è„šæœ¬ã€æµ‹è¯• |
| `stream()` | åŒæ­¥ | `Iterator` (é€æ­¥è¾“å‡º) | åŒæ­¥æµå¼å¤„ç† |
| `ainvoke()` | å¼‚æ­¥ | `dict` (æœ€ç»ˆç»“æœ) | å¼‚æ­¥ API æœåŠ¡ |
| `astream()` | å¼‚æ­¥ | `AsyncIterator` (é€æ­¥è¾“å‡º) | **èŠå¤©åº”ç”¨æ¨è** |

---

## å…­ã€å®Œæ•´ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹ 1ï¼šåŸºç¡€ä½¿ç”¨

```python
from langchain.agents import create_agent

# åˆ›å»º Agent
agent = create_agent(
    model="openai:gpt-4o",
    tools=[search_tool, calculator_tool],
    system_prompt="ä½ æ˜¯ä¸€ä¸ªæœ‰å¸®åŠ©çš„åŠ©æ‰‹",
)

# åŒæ­¥è°ƒç”¨ï¼ˆè·å–æœ€ç»ˆç»“æœï¼‰
result = agent.invoke({"messages": [{"role": "user", "content": "åŒ—äº¬å¤©æ°”å¦‚ä½•ï¼Ÿ"}]})
print(result["messages"][-1].content)
```

### ç¤ºä¾‹ 2ï¼šå¸¦è®°å¿†çš„å¯¹è¯

```python
from langgraph.checkpoint.memory import InMemorySaver

# åˆ›å»ºå¸¦ checkpointer çš„ Agent
agent = create_agent(
    model="openai:gpt-4o",
    checkpointer=InMemorySaver(),  # å¯ç”¨è®°å¿†
)

# ç¬¬ä¸€è½®å¯¹è¯
result1 = agent.invoke(
    {"messages": [{"role": "user", "content": "æˆ‘å«å¼ ä¸‰"}]},
    config={"configurable": {"thread_id": "conv-001"}},  # â˜… æŒ‡å®šå¯¹è¯ ID
)

# ç¬¬äºŒè½®å¯¹è¯ï¼ˆè‡ªåŠ¨æ¢å¤å†å²ï¼‰
result2 = agent.invoke(
    {"messages": [{"role": "user", "content": "æˆ‘å«ä»€ä¹ˆï¼Ÿ"}]},
    config={"configurable": {"thread_id": "conv-001"}},  # â˜… åŒä¸€ä¸ª thread_id
)
# æ¨¡å‹ä¼šå›ç­”"å¼ ä¸‰"
```

### ç¤ºä¾‹ 3ï¼šæµå¼è¾“å‡ºï¼ˆèŠå¤©åº”ç”¨ï¼‰

```python
# å¼‚æ­¥æµå¼è¾“å‡ºï¼ˆèŠå¤©ç•Œé¢æ¨èï¼‰
async for msg, metadata in agent.astream(
    {"messages": [HumanMessage(content="å†™ä¸€é¦–è¯—")]},
    config={"configurable": {"thread_id": "conv-001"}},
    stream_mode="messages",  # æµå¼ token
):
    if isinstance(msg, AIMessageChunk):
        print(msg.content, end="", flush=True)  # é€å­—è¾“å‡º
```

### ç¤ºä¾‹ 4ï¼šå¸¦ Context çš„åŠ¨æ€é…ç½®

```python
from dataclasses import dataclass

@dataclass
class MyContext:
    user_id: str
    model: str
    system_prompt: str

# åˆ›å»º Agentï¼ŒæŒ‡å®š context_schema
agent = create_agent(
    model="openai:gpt-4o",
    context_schema=MyContext,
    middleware=[context_aware_prompt, context_based_model],
)

# è°ƒç”¨æ—¶ä¼ å…¥ contextï¼ˆå¯åŠ¨æ€æ”¹å˜æ¨¡å‹å’Œæç¤ºè¯ï¼‰
result = await agent.ainvoke(
    {"messages": [HumanMessage(content="ä½ å¥½")]},
    context=MyContext(
        user_id="user-123",
        model="deepseek/deepseek-chat",  # åŠ¨æ€é€‰æ‹©æ¨¡å‹
        system_prompt="ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„PythonåŠ©æ‰‹",  # åŠ¨æ€æç¤ºè¯
    ),
)
```

### ç¤ºä¾‹ 5ï¼šå¸¦é™„ä»¶çš„å®Œæ•´è°ƒç”¨

```python
# å‡è®¾æœ‰è‡ªå®šä¹‰çš„ AttachmentMiddleware
result = await agent.ainvoke(
    {
        "messages": [HumanMessage(content="è¯·åˆ†æè¿™ä»½æŠ¥å‘Š")],
        "attachments": [
            {
                "file_id": "file-001",
                "file_name": "report.pdf",
                "status": "parsed",
                "markdown": "# 2024å¹´åº¦æŠ¥å‘Š\n\n## æ”¶å…¥æƒ…å†µ...",
            }
        ],
    },
    config={
        "configurable": {
            "thread_id": "analysis-session-001",
            "user_id": "user-123",
        },
        "recursion_limit": 50,
    },
    context=MyContext(
        model="openai/gpt-4o",
        system_prompt="ä½ æ˜¯æ•°æ®åˆ†æä¸“å®¶",
    ),
)
```

---

## ä¸ƒã€å‚æ•°æ„ä¹‰æ€»ç»“

| å‚æ•° | ä½œç”¨ | æŒä¹…åŒ– | è®¿é—®æ–¹å¼ |
|------|------|--------|---------|
| **`input`** | State åˆå§‹å€¼ | âœ… Checkpointer ä¿å­˜ | `request.state` |
| **`config.configurable.thread_id`** | å¯¹è¯çº¿ç¨‹æ ‡è¯† | âŒ | Checkpointer å†…éƒ¨ä½¿ç”¨ |
| **`context`** | è¿è¡Œæ—¶é…ç½® | âŒ æ¯æ¬¡ä¼ å…¥ | `request.runtime.context` |
| **`stream_mode`** | æ§åˆ¶è¾“å‡ºæ ¼å¼ | âŒ | å½±å“è¿”å›å€¼ |

**æ ¸å¿ƒè®¾è®¡ç†å¿µ**ï¼š
- **`input`** = **æ•°æ®**ï¼ˆä¼šæŒä¹…åŒ–ï¼Œç”¨äºå¯¹è¯å†å²ï¼‰
- **`context`** = **é…ç½®**ï¼ˆä¸æŒä¹…åŒ–ï¼Œç”¨äºåŠ¨æ€æ§åˆ¶è¡Œä¸ºï¼‰
- **`config`** = **è¿è¡Œæ—¶å…ƒæ•°æ®**ï¼ˆåŒ…å« thread_id ç­‰æ ‡è¯†ç¬¦ï¼‰
