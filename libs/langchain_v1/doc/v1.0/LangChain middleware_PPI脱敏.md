# LangChain middleware_PPIè„±æ•

ä½¿ç”¨å¯é…ç½®çš„ç­–ç•¥æ£€æµ‹å’Œå¤„ç†å¯¹è¯ä¸­çš„ä¸ªäººèº«ä»½ä¿¡æ¯ï¼ˆPIIï¼‰ã€‚PII æ£€æµ‹é€‚ç”¨äºä»¥ä¸‹åœºæ™¯ï¼š

- éœ€è¦åˆè§„è¦æ±‚çš„åŒ»ç–—ä¿å¥å’Œé‡‘èåº”ç”¨
- éœ€è¦æ¸…ç†æ—¥å¿—çš„å®¢æˆ·æœåŠ¡è„±æ•
- å¤„ç†æ•æ„Ÿç”¨æˆ·æ•°æ®çš„ä»»ä½•åº”ç”¨

## API å‚è€ƒ

### åŸºæœ¬ä½¿ç”¨

```python
from langchain.agents import create_agent
from langchain.agents.middleware import PIIMiddleware

agent = create_agent(
    model="gpt-4o",
    tools=[],
    middleware=[
        PIIMiddleware("email", strategy="redact", apply_to_input=True),
        PIIMiddleware("credit_card", strategy="mask", apply_to_input=True),
    ],
)
```

## è‡ªå®šä¹‰ä¸ªäººèº«ä»½ä¿¡æ¯ç±»å‹

ä½ å¯ä»¥é€šè¿‡æä¾› `detector` å‚æ•°æ¥åˆ›å»ºè‡ªå®šä¹‰çš„ PII ç±»å‹ã€‚è¿™ä½¿ä½ èƒ½å¤Ÿåœ¨å†…ç½®ç±»å‹ä¹‹å¤–ï¼Œæ£€æµ‹ç‰¹å®šäºä½ ç”¨ä¾‹çš„æ¨¡å¼ã€‚

### åˆ›å»ºè‡ªå®šä¹‰æ£€æµ‹å™¨çš„ä¸‰ç§æ–¹æ³•

1. **æ­£åˆ™è¡¨è¾¾å¼æ¨¡å¼å­—ç¬¦ä¸²** - ç®€å•çš„æ¨¡å¼åŒ¹é…
2. **ç¼–è¯‘çš„æ­£åˆ™è¡¨è¾¾å¼å¯¹è±¡** - æ”¯æŒæ ‡å¿—çš„æ­£åˆ™è¡¨è¾¾å¼
3. **è‡ªå®šä¹‰å‡½æ•°** - å¸¦éªŒè¯çš„å¤æ‚æ£€æµ‹é€»è¾‘

### ç¤ºä¾‹ä»£ç 

```python
from langchain.agents import create_agent
from langchain.agents.middleware import PIIMiddleware
import re

# ============================================================================
# Method 1: ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æ¨¡å¼å­—ç¬¦ä¸²
# ============================================================================
# ç›®çš„ï¼šæ£€æµ‹å’Œä¿æŠ¤ API å¯†é’¥ï¼Œé˜²æ­¢æ•æ„Ÿä¿¡æ¯æ³„éœ²
# å®ç°æ–¹å¼ï¼š
#   - ä½¿ç”¨ç®€å•çš„æ­£åˆ™è¡¨è¾¾å¼å­—ç¬¦ä¸²ç›´æ¥åŒ¹é… OpenAI API å¯†é’¥æ ¼å¼
#   - æ¨¡å¼ r"sk-[a-zA-Z0-9]{32}" åŒ¹é…ä»¥ "sk-" å¼€å¤´ï¼Œåè·Ÿ32ä½å­—æ¯æ•°å­—çš„å­—ç¬¦ä¸²
#   - å½“æ£€æµ‹åˆ° API å¯†é’¥æ—¶ï¼Œä½¿ç”¨ "block" ç­–ç•¥ç›´æ¥æŠ›å‡ºå¼‚å¸¸ï¼Œé˜»æ­¢è¯·æ±‚ç»§ç»­æ‰§è¡Œ
agent1 = create_agent(
    model="gpt-4o",
    tools=[],
    middleware=[
        PIIMiddleware(
            "api_key",  # è‡ªå®šä¹‰ PII ç±»å‹åç§°
            detector=r"sk-[a-zA-Z0-9]{32}",  # æ­£åˆ™è¡¨è¾¾å¼å­—ç¬¦ä¸²ï¼šåŒ¹é… API å¯†é’¥æ ¼å¼
            strategy="block",  # æ£€æµ‹åˆ°æ—¶æŠ›å‡ºå¼‚å¸¸ï¼Œé˜»æ­¢æ‰§è¡Œ
        ),
    ],
)

# ============================================================================
# Method 2: ä½¿ç”¨ç¼–è¯‘çš„æ­£åˆ™è¡¨è¾¾å¼å¯¹è±¡
# ============================================================================
# ç›®çš„ï¼šæ£€æµ‹ç”µè¯å·ç å¹¶éƒ¨åˆ†é®ç›–ï¼Œä¿æŠ¤ç”¨æˆ·éšç§åŒæ—¶ä¿ç•™éƒ¨åˆ†ä¿¡æ¯ç”¨äºè¯†åˆ«
# å®ç°æ–¹å¼ï¼š
#   - ä½¿ç”¨ re.compile() ç¼–è¯‘æ­£åˆ™è¡¨è¾¾å¼ï¼Œå¯ä»¥æ·»åŠ æ ‡å¿—ï¼ˆå¦‚ re.IGNORECASEï¼‰
#   - æ¨¡å¼åŒ¹é…å›½é™…ç”µè¯å·ç æ ¼å¼ï¼šå¯é€‰çš„å›½å®¶ä»£ç  + åŒºå· + å·ç 
#   - ä½¿ç”¨ "mask" ç­–ç•¥éƒ¨åˆ†é®ç›–ï¼Œä¿ç•™æœ€åå‡ ä½æ•°å­—ç”¨äºè¯†åˆ«
agent2 = create_agent(
    model="gpt-4o",
    tools=[],
    middleware=[
        PIIMiddleware(
            "phone_number",  # è‡ªå®šä¹‰ PII ç±»å‹åç§°
            # ç¼–è¯‘çš„æ­£åˆ™è¡¨è¾¾å¼ï¼šåŒ¹é…ç”µè¯å·ç æ ¼å¼
            # \+? å¯é€‰çš„å›½å®¶ä»£ç å‰ç¼€
            # \d{1,3} 1-3ä½å›½å®¶ä»£ç 
            # [\s.-]? å¯é€‰çš„åˆ†éš”ç¬¦ï¼ˆç©ºæ ¼ã€ç‚¹ã€æ¨ªçº¿ï¼‰
            # \d{3,4} 3-4ä½åŒºå·
            # [\s.-]? å¯é€‰çš„åˆ†éš”ç¬¦
            # \d{4} 4ä½å·ç 
            detector=re.compile(r"\+?\d{1,3}[\s.-]?\d{3,4}[\s.-]?\d{4}"),
            strategy="mask",  # éƒ¨åˆ†é®ç›–ç­–ç•¥ï¼Œä¾‹å¦‚ï¼š****-****-1234
        ),
    ],
)

# ============================================================================
# Method 3: ä½¿ç”¨è‡ªå®šä¹‰æ£€æµ‹å‡½æ•°
# ============================================================================
# ç›®çš„ï¼šæ£€æµ‹ç¤¾ä¼šå®‰å…¨å·ç ï¼ˆSSNï¼‰å¹¶è¿›è¡ŒéªŒè¯ï¼Œç¡®ä¿æ£€æµ‹çš„å‡†ç¡®æ€§
# å®ç°æ–¹å¼ï¼š
#   - å®šä¹‰è‡ªå®šä¹‰å‡½æ•°ï¼Œå…ˆä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼åŒ¹é… SSN æ ¼å¼
#   - ç„¶åè¿›è¡Œä¸šåŠ¡é€»è¾‘éªŒè¯ï¼šæ’é™¤æ— æ•ˆçš„ SSN å·ç ï¼ˆ000ã€666ã€900-999ï¼‰
#   - è¿”å›åŒ…å«åŒ¹é…æ–‡æœ¬å’Œä½ç½®ä¿¡æ¯çš„å­—å…¸åˆ—è¡¨
#   - ä½¿ç”¨ "hash" ç­–ç•¥å°† SSN æ›¿æ¢ä¸ºç¡®å®šæ€§å“ˆå¸Œå€¼ï¼Œä¾¿äºè¿½è¸ªä½†ä¿æŠ¤éšç§
def detect_ssn(content: str) -> list[dict[str, str | int]]:
    """æ£€æµ‹å¹¶éªŒè¯ç¤¾ä¼šå®‰å…¨å·ç ï¼ˆSSNï¼‰
    
    ç›®çš„ï¼šå‡†ç¡®æ£€æµ‹æœ‰æ•ˆçš„ SSNï¼Œæ’é™¤æµ‹è¯•å·ç å’Œæ— æ•ˆå·ç 
    å®ç°æ–¹å¼ï¼š
      1. ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼åŒ¹é… SSN æ ¼å¼ï¼ˆXXX-XX-XXXXï¼‰
      2. éªŒè¯å‰ä¸‰ä½æ•°å­—ï¼Œæ’é™¤æ— æ•ˆå·ç ï¼š
         - ä¸èƒ½æ˜¯ 000
         - ä¸èƒ½æ˜¯ 666
         - ä¸èƒ½æ˜¯ 900-999ï¼ˆä¿ç•™ç”¨äºæµ‹è¯•ï¼‰
      3. è¿”å›åŒ¹é…é¡¹çš„æ–‡æœ¬å’Œä½ç½®ä¿¡æ¯
    
    Returns:
        åŒ…å« 'text'ã€'start' å’Œ 'end' é”®çš„å­—å…¸åˆ—è¡¨
    """
    import re
    matches = []
    # åŒ¹é… SSN æ ¼å¼ï¼š3ä½æ•°å­—-2ä½æ•°å­—-4ä½æ•°å­—
    pattern = r"\d{3}-\d{2}-\d{4}"
    for match in re.finditer(pattern, content):
        ssn = match.group(0)
        # éªŒè¯ï¼šå‰ä¸‰ä½æ•°å­—ä¸èƒ½æ˜¯ 000ã€666 æˆ– 900-999
        first_three = int(ssn[:3])
        if first_three not in [0, 666] and not (900 <= first_three <= 999):
            # è¿”å›åŒ¹é…ä¿¡æ¯ï¼šæ–‡æœ¬å†…å®¹å’Œåœ¨åŸæ–‡ä¸­çš„ä½ç½®
            matches.append({
                "text": ssn,  # åŒ¹é…åˆ°çš„å®Œæ•´æ–‡æœ¬
                "start": match.start(),  # åœ¨åŸæ–‡ä¸­çš„èµ·å§‹ä½ç½®
                "end": match.end(),  # åœ¨åŸæ–‡ä¸­çš„ç»“æŸä½ç½®
            })
    return matches

agent3 = create_agent(
    model="gpt-4o",
    tools=[],
    middleware=[
        PIIMiddleware(
            "ssn",  # è‡ªå®šä¹‰ PII ç±»å‹åç§°
            detector=detect_ssn,  # ä¼ å…¥è‡ªå®šä¹‰æ£€æµ‹å‡½æ•°
            strategy="hash",  # ä½¿ç”¨å“ˆå¸Œç­–ç•¥ï¼šæ›¿æ¢ä¸ºç¡®å®šæ€§å“ˆå¸Œå€¼
        ),
    ],
)
```

### è‡ªå®šä¹‰æ£€æµ‹å‡½æ•°ç­¾å

æ£€æµ‹å‡½æ•°å¿…é¡»æ¥å—ä¸€ä¸ªå­—ç¬¦ä¸²ï¼ˆå†…å®¹ï¼‰å¹¶è¿”å›åŒ¹é…é¡¹ï¼š

è¿”å›ä¸€ä¸ªåŒ…å« `text`ã€`start` å’Œ `end` é”®çš„å­—å…¸åˆ—è¡¨ï¼š

```python
def detector(content: str) -> list[dict[str, str | int]]:
    return [
        {"text": "matched_text", "start": 0, "end": 12},
        # ... more matches
    ]
```

### é€‰æ‹©æ£€æµ‹å™¨ç±»å‹çš„å»ºè®®

- **å¯¹äºç®€å•æ¨¡å¼**ï¼Œä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼å­—ç¬¦ä¸²
- **å½“ä½ éœ€è¦æ ‡å¿—**ï¼ˆä¾‹å¦‚ï¼Œä¸åŒºåˆ†å¤§å°å†™åŒ¹é…ï¼‰æ—¶ï¼Œä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼å¯¹è±¡
- **å½“ä½ éœ€è¦è¶…å‡ºæ¨¡å¼åŒ¹é…çš„éªŒè¯é€»è¾‘**æ—¶ï¼Œä½¿ç”¨è‡ªå®šä¹‰å‡½æ•°
- è‡ªå®šä¹‰å‡½æ•°è®©æ‚¨å®Œå…¨æ§åˆ¶æ£€æµ‹é€»è¾‘ï¼Œå¹¶å¯ä»¥å®ç°å¤æ‚çš„éªŒè¯è§„åˆ™

## é…ç½®é€‰é¡¹

| å‚æ•° | ç±»å‹ | å¿…éœ€ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|------|--------|------|
| `pii_type` | å­—ç¬¦ä¸² | æ˜¯ | - | è¦æ£€æµ‹çš„ä¸ªäººä¿¡æ¯ç±»å‹ã€‚å¯ä»¥æ˜¯å†…ç½®ç±»å‹ï¼ˆ`email`ï¼Œ`credit_card`ï¼Œ`ip`ï¼Œ`mac_address`ï¼Œ`url`ï¼‰æˆ–è‡ªå®šä¹‰ç±»å‹åç§° |
| `strategy` | å­—ç¬¦ä¸² | å¦ | `"mask"` | å¦‚ä½•å¤„ç†æ£€æµ‹åˆ°çš„ä¸ªäººèº«ä»½ä¿¡æ¯ï¼ˆPIIï¼‰ã€‚é€‰é¡¹ï¼š<br>- `'block'` - æ£€æµ‹åˆ°æ—¶æŠ›å‡ºå¼‚å¸¸<br>- `'redact'` - æ›¿æ¢ä¸º `[REDACTED_TYPE]`<br>- `'mask'` - éƒ¨åˆ†é®ç›–ï¼ˆä¾‹å¦‚ï¼Œ`****-****-****-1234`ï¼‰<br>- `'hash'` - æ›¿æ¢ä¸ºç¡®å®šæ€§å“ˆå¸Œ |
| `detector` | function \| regex | å¦ | - | è‡ªå®šä¹‰æ£€æµ‹å‡½æ•°æˆ–æ­£åˆ™è¡¨è¾¾å¼æ¨¡å¼ã€‚å¦‚æœæœªæä¾›ï¼Œåˆ™ä½¿ç”¨å†…ç½®çš„ PII ç±»å‹æ£€æµ‹å™¨ |
| `apply_to_input` | å¸ƒå°”å€¼ | å¦ | `True` | åœ¨è°ƒç”¨æ¨¡å‹å‰æ£€æŸ¥ç”¨æˆ·æ¶ˆæ¯ |
| `apply_to_output` | å¸ƒå°”å€¼ | å¦ | `False` | è°ƒç”¨æ¨¡å‹åæ£€æŸ¥ AI æ¶ˆæ¯ |
| `apply_to_tool_results` | å¸ƒå°”å€¼ | å¦ | `False` | æ‰§è¡Œåæ£€æŸ¥å·¥å…·ç»“æœæ¶ˆæ¯ |


## # PIIMiddleware å®Œæ•´æµç¨‹è§£æ

### ä¸€ã€ä¸­é—´ä»¶æ¦‚è¿°

`PIIMiddleware` æ˜¯ä¸€ä¸ª**æ•æ„Ÿä¿¡æ¯æ£€æµ‹ä¸å¤„ç†ä¸­é—´ä»¶**ï¼Œé€šè¿‡ `before_model` å’Œ `after_model` ä¸¤ä¸ªé’©å­å®ç°ã€‚å®ƒå¯ä»¥æ£€æµ‹å¹¶å¤„ç†å¯¹è¯ä¸­çš„ä¸ªäººæ•æ„Ÿä¿¡æ¯ï¼ˆPII - Personally Identifiable Informationï¼‰ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                         â”‚
â”‚   æ ¸å¿ƒåŠŸèƒ½ï¼š                                                             â”‚
â”‚                                                                         â”‚
â”‚   1. æ£€æµ‹æ•æ„Ÿä¿¡æ¯                                                        â”‚
â”‚      - emailï¼šé‚®ç®±åœ°å€                                                   â”‚
â”‚      - credit_cardï¼šä¿¡ç”¨å¡å·ï¼ˆå¸¦ Luhn ç®—æ³•éªŒè¯ï¼‰                         â”‚
â”‚      - ipï¼šIP åœ°å€                                                       â”‚
â”‚      - mac_addressï¼šMAC åœ°å€                                             â”‚
â”‚      - urlï¼šç½‘å€                                                         â”‚
â”‚      - è‡ªå®šä¹‰ï¼šé€šè¿‡æ­£åˆ™è¡¨è¾¾å¼æˆ–è‡ªå®šä¹‰å‡½æ•°                                 â”‚
â”‚                                                                         â”‚
â”‚   2. å¤„ç†ç­–ç•¥                                                            â”‚
â”‚      - blockï¼šæ£€æµ‹åˆ° PII æ—¶æŠ›å‡ºå¼‚å¸¸ï¼Œé˜»æ­¢ç»§ç»­                            â”‚
â”‚      - redactï¼šæ›¿æ¢ä¸º [REDACTED_TYPE] å ä½ç¬¦                             â”‚
â”‚      - maskï¼šéƒ¨åˆ†é®è”½ï¼ˆå¦‚ ****-****-****-1234ï¼‰                          â”‚
â”‚      - hashï¼šæ›¿æ¢ä¸ºç¡®å®šæ€§å“ˆå¸Œï¼ˆå¦‚ <email_hash:a1b2c3d4>ï¼‰                â”‚
â”‚                                                                         â”‚
â”‚   3. åº”ç”¨èŒƒå›´                                                            â”‚
â”‚      - apply_to_inputï¼šç”¨æˆ·è¾“å…¥ï¼ˆHumanMessageï¼‰                          â”‚
â”‚      - apply_to_outputï¼šAI è¾“å‡ºï¼ˆAIMessageï¼‰                             â”‚
â”‚      - apply_to_tool_resultsï¼šå·¥å…·è¿”å›ï¼ˆToolMessageï¼‰                    â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### äºŒã€è¾“å…¥è¾“å‡ºå®šä¹‰

#### é…ç½®å‚æ•°

```python
PIIMiddleware(
    pii_type: "email" | "credit_card" | "ip" | "mac_address" | "url" | str,
    strategy: "block" | "redact" | "mask" | "hash" = "redact",
    detector: Callable[[str], list[PIIMatch]] | str | None = None,
    apply_to_input: bool = True,       # æ£€æŸ¥ç”¨æˆ·è¾“å…¥
    apply_to_output: bool = False,     # æ£€æŸ¥ AI è¾“å‡º
    apply_to_tool_results: bool = False,  # æ£€æŸ¥å·¥å…·è¿”å›
)
```

| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|--------|------|
| `pii_type` | `str` | å¿…å¡« | PII ç±»å‹åç§°ï¼ˆå†…ç½®æˆ–è‡ªå®šä¹‰ï¼‰ |
| `strategy` | `str` | `"redact"` | å¤„ç†ç­–ç•¥ |
| `detector` | `Callable/str/None` | `None` | è‡ªå®šä¹‰æ£€æµ‹å™¨æˆ–æ­£åˆ™ |
| `apply_to_input` | `bool` | `True` | æ˜¯å¦æ£€æŸ¥ç”¨æˆ·æ¶ˆæ¯ |
| `apply_to_output` | `bool` | `False` | æ˜¯å¦æ£€æŸ¥ AI è¾“å‡º |
| `apply_to_tool_results` | `bool` | `False` | æ˜¯å¦æ£€æŸ¥å·¥å…·ç»“æœ |

#### before_model è¾“å…¥è¾“å‡º

| è¾“å…¥ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `state["messages"]` | `list[AnyMessage]` | å½“å‰æ¶ˆæ¯åˆ—è¡¨ |
| `runtime` | `Runtime` | LangGraph è¿è¡Œæ—¶ï¼ˆæœªä½¿ç”¨ï¼‰ |

| è¾“å‡º | æ¡ä»¶ | ç±»å‹ | è¯´æ˜ |
|------|------|------|------|
| `None` | æœªæ£€æµ‹åˆ° PII | `None` | ä¸ä¿®æ”¹çŠ¶æ€ |
| `{"messages": [...]}` | æ£€æµ‹åˆ° PII + é block | `dict` | è¿”å›å¤„ç†åçš„æ¶ˆæ¯åˆ—è¡¨ |
| `raise PIIDetectionError` | æ£€æµ‹åˆ° PII + block | Exception | é˜»æ­¢æ‰§è¡Œ |

#### after_model è¾“å…¥è¾“å‡º

| è¾“å…¥ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `state["messages"]` | `list[AnyMessage]` | å½“å‰æ¶ˆæ¯åˆ—è¡¨ï¼ˆåŒ…å«æœ€æ–° AI å“åº”ï¼‰ |
| `runtime` | `Runtime` | LangGraph è¿è¡Œæ—¶ï¼ˆæœªä½¿ç”¨ï¼‰ |

| è¾“å‡º | æ¡ä»¶ | ç±»å‹ | è¯´æ˜ |
|------|------|------|------|
| `None` | æœªæ£€æµ‹åˆ° PII æˆ– apply_to_output=False | `None` | ä¸ä¿®æ”¹çŠ¶æ€ |
| `{"messages": [...]}` | æ£€æµ‹åˆ° PII + é block | `dict` | è¿”å›å¤„ç†åçš„æ¶ˆæ¯åˆ—è¡¨ |
| `raise PIIDetectionError` | æ£€æµ‹åˆ° PII + block | Exception | é˜»æ­¢æ‰§è¡Œ |

---

### ä¸‰ã€å››ç§å¤„ç†ç­–ç•¥è¯¦è§£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           å››ç§ PII å¤„ç†ç­–ç•¥å¯¹æ¯”                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                     â”‚
â”‚  åŸå§‹å†…å®¹: "æˆ‘çš„é‚®ç®±æ˜¯ john@example.comï¼Œä¿¡ç”¨å¡å·æ˜¯ 4111-1111-1111-1111"             â”‚
â”‚                                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ strategy = "block"                                                          â”‚   â”‚
â”‚  â”‚                                                                             â”‚   â”‚
â”‚  â”‚ ç»“æœ: raise PIIDetectionError("PII detected: email at position 5-21")       â”‚   â”‚
â”‚  â”‚                                                                             â”‚   â”‚
â”‚  â”‚ âœ… é€‚ç”¨åœºæ™¯: ä¸¥æ ¼ç¦æ­¢ä»»ä½• PII è¿›å…¥ç³»ç»Ÿ                                       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ strategy = "redact"                                                         â”‚   â”‚
â”‚  â”‚                                                                             â”‚   â”‚
â”‚  â”‚ ç»“æœ: "æˆ‘çš„é‚®ç®±æ˜¯ [REDACTED_EMAIL]ï¼Œä¿¡ç”¨å¡å·æ˜¯ [REDACTED_CREDIT_CARD]"       â”‚   â”‚
â”‚  â”‚                                                                             â”‚   â”‚
â”‚  â”‚ âœ… é€‚ç”¨åœºæ™¯: é€šç”¨åˆè§„ã€æ—¥å¿—è„±æ•ã€æ•°æ®æ¸…æ´—                                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ strategy = "mask"                                                           â”‚   â”‚
â”‚  â”‚                                                                             â”‚   â”‚
â”‚  â”‚ ç»“æœ: "æˆ‘çš„é‚®ç®±æ˜¯ j***@example.comï¼Œä¿¡ç”¨å¡å·æ˜¯ ****-****-****-1111"          â”‚   â”‚
â”‚  â”‚                                                                             â”‚   â”‚
â”‚  â”‚ âœ… é€‚ç”¨åœºæ™¯: å®¢æœç•Œé¢ã€ä¿ç•™éƒ¨åˆ†å¯è¯»æ€§ã€ç”¨æˆ·ç¡®è®¤                              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ strategy = "hash"                                                           â”‚   â”‚
â”‚  â”‚                                                                             â”‚   â”‚
â”‚  â”‚ ç»“æœ: "æˆ‘çš„é‚®ç®±æ˜¯ <email_hash:a1b2c3d4>ï¼Œä¿¡ç”¨å¡å·æ˜¯ <credit_card_hash:e5f6>  â”‚   â”‚
â”‚  â”‚                                                                             â”‚   â”‚
â”‚  â”‚ âœ… é€‚ç”¨åœºæ™¯: æ•°æ®åˆ†æã€è°ƒè¯•è¿½è¸ªã€ä¿æŒå”¯ä¸€æ€§ä½†éšè—åŸå€¼                        â”‚   â”‚
â”‚  â”‚ ğŸ’¡ ç‰¹ç‚¹: ç›¸åŒè¾“å…¥äº§ç”Ÿç›¸åŒå“ˆå¸Œï¼Œå¯ç”¨äºå…³è”åˆ†æ                                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### å››ã€å®Œæ•´æµç¨‹å›¾

```
ç”¨æˆ·å‘é€æ¶ˆæ¯
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                                      â”‚
â”‚                       before_model(state, runtime)                                   â”‚
â”‚                                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Step 1: æ£€æŸ¥æ˜¯å¦å¯ç”¨è¾“å…¥/å·¥å…·ç»“æœæ£€æŸ¥                                          â”‚  â”‚
â”‚  â”‚                                                                                â”‚  â”‚
â”‚  â”‚   if not self.apply_to_input and not self.apply_to_tool_results:               â”‚  â”‚
â”‚  â”‚       return None  # è·³è¿‡æ£€æŸ¥                                                  â”‚  â”‚
â”‚  â”‚                                                                                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                           â”‚                                          â”‚
â”‚                                           â–¼                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Step 2: æ£€æŸ¥ç”¨æˆ·è¾“å…¥ï¼ˆå¦‚æœ apply_to_input=Trueï¼‰                               â”‚  â”‚
â”‚  â”‚                                                                                â”‚  â”‚
â”‚  â”‚   # æ‰¾åˆ°æœ€åä¸€ä¸ª HumanMessage                                                  â”‚  â”‚
â”‚  â”‚   for i in range(len(messages) - 1, -1, -1):                                   â”‚  â”‚
â”‚  â”‚       if isinstance(messages[i], HumanMessage):                                â”‚  â”‚
â”‚  â”‚           last_user_msg = messages[i]                                          â”‚  â”‚
â”‚  â”‚           last_user_idx = i                                                    â”‚  â”‚
â”‚  â”‚           break                                                                â”‚  â”‚
â”‚  â”‚                                                                                â”‚  â”‚
â”‚  â”‚   # æ£€æµ‹å¹¶å¤„ç† PII                                                             â”‚  â”‚
â”‚  â”‚   content = str(last_user_msg.content)                                         â”‚  â”‚
â”‚  â”‚   new_content, matches = self._process_content(content)                        â”‚  â”‚
â”‚  â”‚                                                                                â”‚  â”‚
â”‚  â”‚   if matches:                                                                  â”‚  â”‚
â”‚  â”‚       # åˆ›å»ºæ›´æ–°åçš„ HumanMessage                                              â”‚  â”‚
â”‚  â”‚       new_messages[last_user_idx] = HumanMessage(content=new_content, ...)     â”‚  â”‚
â”‚  â”‚       any_modified = True                                                      â”‚  â”‚
â”‚  â”‚                                                                                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                           â”‚                                          â”‚
â”‚                                           â–¼                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Step 3: æ£€æŸ¥å·¥å…·ç»“æœï¼ˆå¦‚æœ apply_to_tool_results=Trueï¼‰                        â”‚  â”‚
â”‚  â”‚                                                                                â”‚  â”‚
â”‚  â”‚   # æ‰¾åˆ°æœ€åä¸€ä¸ª AIMessage                                                     â”‚  â”‚
â”‚  â”‚   for i in range(len(messages) - 1, -1, -1):                                   â”‚  â”‚
â”‚  â”‚       if isinstance(messages[i], AIMessage):                                   â”‚  â”‚
â”‚  â”‚           last_ai_idx = i                                                      â”‚  â”‚
â”‚  â”‚           break                                                                â”‚  â”‚
â”‚  â”‚                                                                                â”‚  â”‚
â”‚  â”‚   # å¤„ç† AIMessage ä¹‹åçš„æ‰€æœ‰ ToolMessage                                      â”‚  â”‚
â”‚  â”‚   for i in range(last_ai_idx + 1, len(messages)):                              â”‚  â”‚
â”‚  â”‚       msg = messages[i]                                                        â”‚  â”‚
â”‚  â”‚       if isinstance(msg, ToolMessage):                                         â”‚  â”‚
â”‚  â”‚           content = str(msg.content)                                           â”‚  â”‚
â”‚  â”‚           new_content, matches = self._process_content(content)                â”‚  â”‚
â”‚  â”‚                                                                                â”‚  â”‚
â”‚  â”‚           if matches:                                                          â”‚  â”‚
â”‚  â”‚               new_messages[i] = ToolMessage(content=new_content, ...)          â”‚  â”‚
â”‚  â”‚               any_modified = True                                              â”‚  â”‚
â”‚  â”‚                                                                                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                           â”‚                                          â”‚
â”‚                                           â–¼                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Step 4: è¿”å›ç»“æœ                                                               â”‚  â”‚
â”‚  â”‚                                                                                â”‚  â”‚
â”‚  â”‚   if any_modified:                                                             â”‚  â”‚
â”‚  â”‚       return {"messages": new_messages}  # æ›´æ–°çŠ¶æ€                            â”‚  â”‚
â”‚  â”‚   return None  # æ— ä¿®æ”¹                                                        â”‚  â”‚
â”‚  â”‚                                                                                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                           â”‚
                                           â–¼
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚        model èŠ‚ç‚¹           â”‚
                              â”‚      ï¼ˆè°ƒç”¨ LLMï¼‰           â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                           â”‚
                                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                                      â”‚
â”‚                       after_model(state, runtime)                                    â”‚
â”‚                                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Step 1: æ£€æŸ¥æ˜¯å¦å¯ç”¨è¾“å‡ºæ£€æŸ¥                                                   â”‚  â”‚
â”‚  â”‚                                                                                â”‚  â”‚
â”‚  â”‚   if not self.apply_to_output:                                                 â”‚  â”‚
â”‚  â”‚       return None  # è·³è¿‡æ£€æŸ¥                                                  â”‚  â”‚
â”‚  â”‚                                                                                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                           â”‚                                          â”‚
â”‚                                           â–¼                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Step 2: è·å–æœ€åä¸€ä¸ª AIMessage                                                 â”‚  â”‚
â”‚  â”‚                                                                                â”‚  â”‚
â”‚  â”‚   for i in range(len(messages) - 1, -1, -1):                                   â”‚  â”‚
â”‚  â”‚       if isinstance(messages[i], AIMessage):                                   â”‚  â”‚
â”‚  â”‚           last_ai_msg = messages[i]                                            â”‚  â”‚
â”‚  â”‚           last_ai_idx = i                                                      â”‚  â”‚
â”‚  â”‚           break                                                                â”‚  â”‚
â”‚  â”‚                                                                                â”‚  â”‚
â”‚  â”‚   if not last_ai_msg or not last_ai_msg.content:                               â”‚  â”‚
â”‚  â”‚       return None                                                              â”‚  â”‚
â”‚  â”‚                                                                                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                           â”‚                                          â”‚
â”‚                                           â–¼                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Step 3: æ£€æµ‹å¹¶å¤„ç† PII                                                         â”‚  â”‚
â”‚  â”‚                                                                                â”‚  â”‚
â”‚  â”‚   content = str(last_ai_msg.content)                                           â”‚  â”‚
â”‚  â”‚   new_content, matches = self._process_content(content)                        â”‚  â”‚
â”‚  â”‚                                                                                â”‚  â”‚
â”‚  â”‚   if not matches:                                                              â”‚  â”‚
â”‚  â”‚       return None  # æ—  PII                                                    â”‚  â”‚
â”‚  â”‚                                                                                â”‚  â”‚
â”‚  â”‚   # åˆ›å»ºæ›´æ–°åçš„ AIMessageï¼ˆä¿ç•™ tool_callsï¼‰                                  â”‚  â”‚
â”‚  â”‚   updated_message = AIMessage(                                                 â”‚  â”‚
â”‚  â”‚       content=new_content,                                                     â”‚  â”‚
â”‚  â”‚       id=last_ai_msg.id,                                                       â”‚  â”‚
â”‚  â”‚       name=last_ai_msg.name,                                                   â”‚  â”‚
â”‚  â”‚       tool_calls=last_ai_msg.tool_calls,  # ä¿ç•™å·¥å…·è°ƒç”¨                       â”‚  â”‚
â”‚  â”‚   )                                                                            â”‚  â”‚
â”‚  â”‚                                                                                â”‚  â”‚
â”‚  â”‚   new_messages[last_ai_idx] = updated_message                                  â”‚  â”‚
â”‚  â”‚   return {"messages": new_messages}                                            â”‚  â”‚
â”‚  â”‚                                                                                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                           â”‚
                                           â–¼
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚  ç»§ç»­æ‰§è¡Œï¼ˆtools æˆ– ENDï¼‰   â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### äº”ã€_process_content æ ¸å¿ƒé€»è¾‘

```
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚  _process_content(content)  â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                           â”‚
                                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                                      â”‚
â”‚  è¾“å…¥: content = "è”ç³»æˆ‘: john@example.com æˆ– 4111-1111-1111-1111"                   â”‚
â”‚                                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Step 1: è°ƒç”¨æ£€æµ‹å™¨                                                             â”‚  â”‚
â”‚  â”‚                                                                                â”‚  â”‚
â”‚  â”‚   matches = self.detector(content)                                             â”‚  â”‚
â”‚  â”‚                                                                                â”‚  â”‚
â”‚  â”‚   # æ£€æµ‹å™¨è¿”å› PIIMatch åˆ—è¡¨                                                   â”‚  â”‚
â”‚  â”‚   matches = [                                                                  â”‚  â”‚
â”‚  â”‚       PIIMatch(start=5, end=21, value="john@example.com", type="email"),       â”‚  â”‚
â”‚  â”‚   ]                                                                            â”‚  â”‚
â”‚  â”‚                                                                                â”‚  â”‚
â”‚  â”‚   if not matches:                                                              â”‚  â”‚
â”‚  â”‚       return content, []  # æ—  PIIï¼ŒåŸæ ·è¿”å›                                   â”‚  â”‚
â”‚  â”‚                                                                                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                           â”‚                                          â”‚
â”‚                                           â–¼                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Step 2: åº”ç”¨å¤„ç†ç­–ç•¥                                                           â”‚  â”‚
â”‚  â”‚                                                                                â”‚  â”‚
â”‚  â”‚   sanitized = apply_strategy(content, matches, self.strategy)                  â”‚  â”‚
â”‚  â”‚                                                                                â”‚  â”‚
â”‚  â”‚   # æ ¹æ® strategy ä¸åŒï¼Œç»“æœä¸åŒï¼š                                             â”‚  â”‚
â”‚  â”‚                                                                                â”‚  â”‚
â”‚  â”‚   strategy="block":                                                            â”‚  â”‚
â”‚  â”‚       raise PIIDetectionError(...)                                             â”‚  â”‚
â”‚  â”‚                                                                                â”‚  â”‚
â”‚  â”‚   strategy="redact":                                                           â”‚  â”‚
â”‚  â”‚       sanitized = "è”ç³»æˆ‘: [REDACTED_EMAIL] æˆ– 4111-1111-1111-1111"             â”‚  â”‚
â”‚  â”‚                                                                                â”‚  â”‚
â”‚  â”‚   strategy="mask":                                                             â”‚  â”‚
â”‚  â”‚       sanitized = "è”ç³»æˆ‘: j***@example.com æˆ– 4111-1111-1111-1111"             â”‚  â”‚
â”‚  â”‚                                                                                â”‚  â”‚
â”‚  â”‚   strategy="hash":                                                             â”‚  â”‚
â”‚  â”‚       sanitized = "è”ç³»æˆ‘: <email_hash:a1b2c3d4> æˆ– 4111-1111-1111-1111"        â”‚  â”‚
â”‚  â”‚                                                                                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                           â”‚                                          â”‚
â”‚                                           â–¼                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Step 3: è¿”å›ç»“æœ                                                               â”‚  â”‚
â”‚  â”‚                                                                                â”‚  â”‚
â”‚  â”‚   return sanitized, matches                                                    â”‚  â”‚
â”‚  â”‚                                                                                â”‚  â”‚
â”‚  â”‚   # sanitized: å¤„ç†åçš„å†…å®¹                                                    â”‚  â”‚
â”‚  â”‚   # matches: æ£€æµ‹åˆ°çš„ PII åˆ—è¡¨ï¼ˆç”¨äºåˆ¤æ–­æ˜¯å¦æœ‰ä¿®æ”¹ï¼‰                           â”‚  â”‚
â”‚  â”‚                                                                                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### å…­ã€æ¶ˆæ¯å¤„ç†å‰åå¯¹æ¯”

#### åœºæ™¯ï¼šapply_to_input=True, strategy="redact", pii_type="email"

```
å¤„ç†å‰ messages:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [                                                                              â”‚
â”‚   HumanMessage("ä½ å¥½"),                                                        â”‚
â”‚   AIMessage("ä½ å¥½ï¼æœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©ä½ çš„ï¼Ÿ"),                                      â”‚
â”‚   HumanMessage("è¯·å‘é‚®ä»¶åˆ° john@example.com å’Œ jane@company.org"),              â”‚ â† å¾…å¤„ç†
â”‚ ]                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å¤„ç†å messages:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [                                                                              â”‚
â”‚   HumanMessage("ä½ å¥½"),                                                        â”‚
â”‚   AIMessage("ä½ å¥½ï¼æœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©ä½ çš„ï¼Ÿ"),                                      â”‚
â”‚   HumanMessage("è¯·å‘é‚®ä»¶åˆ° [REDACTED_EMAIL] å’Œ [REDACTED_EMAIL]"),              â”‚ â† å·²è„±æ•
â”‚ ]                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### åœºæ™¯ï¼šapply_to_tool_results=True, strategy="mask", pii_type="credit_card"

```
å¤„ç†å‰ messages:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [                                                                              â”‚
â”‚   HumanMessage("æŸ¥è¯¢æˆ‘çš„è®¢å•"),                                                â”‚
â”‚   AIMessage(tool_calls=[{name: "query_order", ...}]),                          â”‚
â”‚   ToolMessage(                                                                 â”‚
â”‚       content="è®¢å•å·: 12345, æ”¯ä»˜å¡å·: 4111-1111-1111-1111",                   â”‚ â† å¾…å¤„ç†
â”‚       tool_call_id="call_1"                                                    â”‚
â”‚   ),                                                                           â”‚
â”‚ ]                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å¤„ç†å messages:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [                                                                              â”‚
â”‚   HumanMessage("æŸ¥è¯¢æˆ‘çš„è®¢å•"),                                                â”‚
â”‚   AIMessage(tool_calls=[{name: "query_order", ...}]),                          â”‚
â”‚   ToolMessage(                                                                 â”‚
â”‚       content="è®¢å•å·: 12345, æ”¯ä»˜å¡å·: ****-****-****-1111",                   â”‚ â† å·²é®è”½
â”‚       tool_call_id="call_1"                                                    â”‚
â”‚   ),                                                                           â”‚
â”‚ ]                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### ä¸ƒã€å®Œæ•´æ•°æ®æµæ€»ç»“

```
ç”¨æˆ·å‘é€æ¶ˆæ¯ï¼ˆå¯èƒ½åŒ…å« PIIï¼‰
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ before_model (PIIMiddleware)                                     â”‚
â”‚                                                                  â”‚
â”‚  æ£€æŸ¥èŒƒå›´:                                                        â”‚
â”‚  â”œâ”€ apply_to_input=True â†’ æ£€æŸ¥æœ€åä¸€ä¸ª HumanMessage              â”‚
â”‚  â””â”€ apply_to_tool_results=True â†’ æ£€æŸ¥æœ€å AI ä¹‹åçš„ ToolMessage  â”‚
â”‚                                                                  â”‚
â”‚  å¤„ç†æµç¨‹:                                                        â”‚
â”‚  1. æå–æ¶ˆæ¯å†…å®¹                                                  â”‚
â”‚  2. è°ƒç”¨ detector(content) æ£€æµ‹ PII                              â”‚
â”‚  3. å¦‚æœæœ‰ PII:                                                   â”‚
â”‚     - block: raise PIIDetectionError                             â”‚
â”‚     - å…¶ä»–: apply_strategy() å¤„ç†å†…å®¹                            â”‚
â”‚  4. è¿”å›æ›´æ–°åçš„ messages æˆ– None                                â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ model èŠ‚ç‚¹ï¼ˆè°ƒç”¨ LLMï¼‰                                            â”‚
â”‚                                                                  â”‚
â”‚ - æ­¤æ—¶ç”¨æˆ·è¾“å…¥ä¸­çš„ PII å·²è¢«å¤„ç†                                  â”‚
â”‚ - LLM çœ‹åˆ°çš„æ˜¯è„±æ•åçš„å†…å®¹                                       â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ after_model (PIIMiddleware)                                      â”‚
â”‚                                                                  â”‚
â”‚  æ£€æŸ¥èŒƒå›´:                                                        â”‚
â”‚  â””â”€ apply_to_output=True â†’ æ£€æŸ¥æœ€åä¸€ä¸ª AIMessage                â”‚
â”‚                                                                  â”‚
â”‚  å¤„ç†æµç¨‹:                                                        â”‚
â”‚  1. æå– AI å“åº”å†…å®¹                                              â”‚
â”‚  2. è°ƒç”¨ detector(content) æ£€æµ‹ PII                              â”‚
â”‚  3. å¦‚æœæœ‰ PII:                                                   â”‚
â”‚     - block: raise PIIDetectionError                             â”‚
â”‚     - å…¶ä»–: apply_strategy() å¤„ç†å†…å®¹                            â”‚
â”‚  4. åˆ›å»ºæ–° AIMessageï¼ˆä¿ç•™ tool_callsï¼‰                          â”‚
â”‚  5. è¿”å›æ›´æ–°åçš„ messages æˆ– None                                â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
ç»§ç»­æ‰§è¡Œï¼ˆtools èŠ‚ç‚¹æˆ– ENDï¼‰
```

---

### å…«ã€ä½¿ç”¨ç¤ºä¾‹

```python
from langchain.agents import create_agent
from langchain.agents.middleware import PIIMiddleware

# åœºæ™¯ 1: åŸºç¡€ç”¨æ³• - è„±æ•ç”¨æˆ·è¾“å…¥ä¸­çš„é‚®ç®±
agent = create_agent(
    model="openai:gpt-4o",
    tools=[...],
    middleware=[
        PIIMiddleware("email", strategy="redact"),  # é»˜è®¤åªæ£€æŸ¥è¾“å…¥
    ],
)

# åœºæ™¯ 2: å¤šç§ PII ç±»å‹ï¼Œä¸åŒç­–ç•¥
agent = create_agent(
    model="openai:gpt-4o",
    tools=[...],
    middleware=[
        PIIMiddleware("credit_card", strategy="mask"),   # ä¿¡ç”¨å¡éƒ¨åˆ†é®è”½
        PIIMiddleware("email", strategy="hash"),         # é‚®ç®±å“ˆå¸ŒåŒ–
        PIIMiddleware("ip", strategy="redact"),          # IP å®Œå…¨è„±æ•
    ],
)

# åœºæ™¯ 3: å…¨é¢æ£€æŸ¥ï¼ˆè¾“å…¥ + è¾“å‡º + å·¥å…·ç»“æœï¼‰
agent = create_agent(
    model="openai:gpt-4o",
    tools=[db_query_tool, email_tool],
    middleware=[
        PIIMiddleware(
            "credit_card",
            strategy="mask",
            apply_to_input=True,        # æ£€æŸ¥ç”¨æˆ·è¾“å…¥
            apply_to_output=True,       # æ£€æŸ¥ AI è¾“å‡º
            apply_to_tool_results=True, # æ£€æŸ¥å·¥å…·è¿”å›ï¼ˆå¦‚æ•°æ®åº“æŸ¥è¯¢ï¼‰
        ),
    ],
)

# åœºæ™¯ 4: ä¸¥æ ¼æ¨¡å¼ - é˜»æ­¢ä»»ä½• PII
agent = create_agent(
    model="openai:gpt-4o",
    tools=[...],
    middleware=[
        PIIMiddleware("email", strategy="block"),
        PIIMiddleware("credit_card", strategy="block"),
    ],
)

try:
    result = agent.invoke({"messages": [HumanMessage("æˆ‘çš„é‚®ç®±æ˜¯ test@example.com")]})
except PIIDetectionError as e:
    print(f"æ£€æµ‹åˆ°æ•æ„Ÿä¿¡æ¯: {e}")

# åœºæ™¯ 5: è‡ªå®šä¹‰ PII ç±»å‹ï¼ˆAPI Keyï¼‰
agent = create_agent(
    model="openai:gpt-4o",
    tools=[...],
    middleware=[
        PIIMiddleware(
            "api_key",
            detector=r"sk-[a-zA-Z0-9]{32,}",  # æ­£åˆ™è¡¨è¾¾å¼
            strategy="redact",
        ),
    ],
)

# åœºæ™¯ 6: è‡ªå®šä¹‰æ£€æµ‹å‡½æ•°
def detect_chinese_id(content: str) -> list[PIIMatch]:
    """æ£€æµ‹ä¸­å›½èº«ä»½è¯å·"""
    import re
    pattern = r'\d{17}[\dXx]'
    matches = []
    for m in re.finditer(pattern, content):
        matches.append(PIIMatch(
            start=m.start(),
            end=m.end(),
            value=m.group(),
            type="chinese_id"
        ))
    return matches

agent = create_agent(
    model="openai:gpt-4o",
    tools=[...],
    middleware=[
        PIIMiddleware(
            "chinese_id",
            detector=detect_chinese_id,
            strategy="mask",
        ),
    ],
)
```

---

### ä¹ã€å†…ç½®æ£€æµ‹å™¨è¯´æ˜

| æ£€æµ‹å™¨ | å‡½æ•° | æ£€æµ‹è§„åˆ™ |
|--------|------|----------|
| `email` | `detect_email` | æ ‡å‡†é‚®ç®±æ ¼å¼æ­£åˆ™ |
| `credit_card` | `detect_credit_card` | ä¿¡ç”¨å¡æ ¼å¼ + **Luhn ç®—æ³•éªŒè¯** |
| `ip` | `detect_ip` | IPv4/IPv6 + **stdlib éªŒè¯** |
| `mac_address` | `detect_mac_address` | MAC åœ°å€æ ¼å¼æ­£åˆ™ |
| `url` | `detect_url` | http/https URL + è£¸åŸŸå |

---

### åã€å…³é”®è®¾è®¡æ€»ç»“

| ç»„ä»¶ | ä½œç”¨ |
|------|------|
| `pii_type` | PII ç±»å‹æ ‡è¯†ï¼Œç”¨äºæ¶ˆæ¯å’Œå“ˆå¸Œå‰ç¼€ |
| `strategy` | å¤„ç†ç­–ç•¥ï¼ˆblock/redact/mask/hashï¼‰ |
| `detector` | æ£€æµ‹å‡½æ•°ï¼Œè¿”å› `list[PIIMatch]` |
| `apply_to_input` | æ˜¯å¦æ£€æŸ¥ HumanMessage |
| `apply_to_output` | æ˜¯å¦æ£€æŸ¥ AIMessage |
| `apply_to_tool_results` | æ˜¯å¦æ£€æŸ¥ ToolMessage |
| `before_model` | æ¨¡å‹è°ƒç”¨å‰æ£€æŸ¥ç”¨æˆ·è¾“å…¥å’Œå·¥å…·ç»“æœ |
| `after_model` | æ¨¡å‹è°ƒç”¨åæ£€æŸ¥ AI è¾“å‡º |
| `name` å±æ€§ | è¿”å› `PIIMiddleware[email]`ï¼Œæ”¯æŒå¤šå®ä¾‹åŒºåˆ† |
| `PIIDetectionError` | block ç­–ç•¥æ—¶æŠ›å‡ºçš„å¼‚å¸¸ |


