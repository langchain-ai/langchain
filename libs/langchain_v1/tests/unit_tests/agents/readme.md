# LangChain v1 Agent æµ‹è¯•ç”¨ä¾‹æ€»è§ˆ

## ğŸ“Š æµ‹è¯•ç»Ÿè®¡

- **æ€»æµ‹è¯•æ–‡ä»¶**: 35+ ä¸ª
- **æ€»æµ‹è¯•ç”¨ä¾‹**: 386+ ä¸ª
- **æµ‹è¯•ç±»åˆ«**: 3 å¤§ç±»ï¼ˆæ ¸å¿ƒåŠŸèƒ½ã€ä¸­é—´ä»¶æ ¸å¿ƒã€ä¸­é—´ä»¶å®ç°ï¼‰

---

## 1. æ ¸å¿ƒåŠŸèƒ½æµ‹è¯• (Core Features)

### 1.1 `test_response_format.py` (24 ä¸ªæµ‹è¯•)
**æµ‹è¯•ç»“æ„åŒ–è¾“å‡ºåŠŸèƒ½**

```text
æµ‹è¯•ç±»åˆ«:
â”œâ”€â”€ ToolStrategy ç­–ç•¥æµ‹è¯•
â”‚   â”œâ”€â”€ Pydantic Model
â”‚   â”œâ”€â”€ Dataclass
â”‚   â”œâ”€â”€ TypedDict
â”‚   â””â”€â”€ JSON Schema
â”‚
â”œâ”€â”€ ProviderStrategy ç­–ç•¥æµ‹è¯•
â”‚   â”œâ”€â”€ Pydantic Model
â”‚   â”œâ”€â”€ Dataclass
â”‚   â”œâ”€â”€ TypedDict
â”‚   â””â”€â”€ JSON Schema
â”‚
â”œâ”€â”€ Union ç±»å‹æ”¯æŒ
â”‚   â”œâ”€â”€ Union of JSON Schemas
â”‚   â””â”€â”€ Union of Types
â”‚
â”œâ”€â”€ é”™è¯¯å¤„ç†
â”‚   â”œâ”€â”€ Multiple Structured Outputs Error
â”‚   â”œâ”€â”€ Validation Error (with/without retry)
â”‚   â””â”€â”€ Custom error formatters
â”‚
â””â”€â”€ Provider ç­–ç•¥æµ‹è¯•
    â””â”€â”€ Middleware model swap (Provider â†’ Tool strategy)
```

### 1.2 `test_injected_runtime_create_agent.py` (15 ä¸ªæµ‹è¯•)
**æµ‹è¯•è¿è¡Œæ—¶æ³¨å…¥åŠŸèƒ½**

| æµ‹è¯•åç§° | æµ‹è¯•å†…å®¹ |
|---------|---------|
| `test_tool_runtime_basic_injection` | åŸºæœ¬ ToolRuntime æ³¨å…¥ |
| `test_tool_runtime_async_injection` | å¼‚æ­¥å·¥å…·æ³¨å…¥ |
| `test_tool_runtime_state_access` | è®¿é—® state |
| `test_tool_runtime_with_store` | è®¿é—® store |
| `test_tool_runtime_with_multiple_tools` | å¤šå·¥å…·æ³¨å…¥ |
| `test_tool_runtime_config_access` | è®¿é—® config |
| `test_tool_runtime_with_custom_state` | è‡ªå®šä¹‰çŠ¶æ€ |
| `test_tool_runtime_no_runtime_parameter` | æ—  runtime å‚æ•° |
| `test_tool_runtime_parallel_execution` | å¹¶è¡Œæ‰§è¡Œ |
| `test_tool_runtime_error_handling` | é”™è¯¯å¤„ç† |
| `test_tool_runtime_with_middleware` | ä¸ä¸­é—´ä»¶é…åˆ |
| `test_tool_runtime_type_hints` | ç±»å‹æç¤º |
| `test_tool_runtime_name_based_injection` | åŸºäºåç§°çš„æ³¨å…¥ |
| `test_combined_injected_state_runtime_store` | ç»„åˆæ³¨å…¥ï¼ˆåŒæ­¥ï¼‰ |
| `test_combined_injected_state_runtime_store_async` | ç»„åˆæ³¨å…¥ï¼ˆå¼‚æ­¥ï¼‰ |

### 1.3 `test_system_message.py` (26 ä¸ªæµ‹è¯•)
**æµ‹è¯•ç³»ç»Ÿæ¶ˆæ¯å¤„ç†**

```text
æµ‹è¯•ç±»åˆ«:
â”œâ”€â”€ ModelRequest ç³»ç»Ÿæ¶ˆæ¯
â”‚   â”œâ”€â”€ å„ç§ç³»ç»Ÿè¾“å…¥ï¼ˆNone/str/SystemMessageï¼‰
â”‚   â”œâ”€â”€ system_prompt å±æ€§
â”‚   â”œâ”€â”€ override æ–¹æ³•
â”‚   â”œâ”€â”€ å¤æ‚å†…å®¹ï¼ˆblocks + metadataï¼‰
â”‚   â””â”€â”€ å¤šæ¬¡ override
â”‚
â”œâ”€â”€ create_agent ç³»ç»Ÿæç¤º
â”‚   â”œâ”€â”€ å„ç§ system_prompt å‚æ•°
â”‚   â”œâ”€â”€ ä¸­é—´ä»¶è®¾ç½®åˆå§‹ç³»ç»Ÿæ¶ˆæ¯
â”‚   â”œâ”€â”€ ä¸­é—´ä»¶æ›´æ–°ç³»ç»Ÿæ¶ˆæ¯
â”‚   â””â”€â”€ å¤šä¸­é—´ä»¶é“¾å¼ä¿®æ”¹
â”‚
â”œâ”€â”€ Cache Control
â”‚   â”œâ”€â”€ æ·»åŠ  cache_control
â”‚   â”œâ”€â”€ è·¨ä¸­é—´ä»¶ä¿æŒ
â”‚   â””â”€â”€ Metadata åˆå¹¶
â”‚
â””â”€â”€ å…¼å®¹æ€§
    â”œâ”€â”€ å‘åå…¼å®¹å­—ç¬¦ä¸² system_prompt
    â”œâ”€â”€ å†…å®¹æ ¼å¼å˜åŒ–
    â””â”€â”€ é‡ç½®ä¸º None
```

### 1.4 `test_state_schema.py` (7 ä¸ªæµ‹è¯•)
**æµ‹è¯•è‡ªå®šä¹‰çŠ¶æ€ schema**

- å•ä¸ªè‡ªå®šä¹‰å­—æ®µ
- å¤šä¸ªè‡ªå®šä¹‰å­—æ®µ
- ä¸ ToolRuntime é…åˆ
- ä¸ä¸­é—´ä»¶ state_schema é…åˆ
- å­—æ®µç±»å‹éªŒè¯
- Optional å­—æ®µ
- å¤æ‚ç±»å‹å­—æ®µ

### 1.5 `test_create_agent_tool_validation.py` (3 ä¸ªæµ‹è¯•)
**æµ‹è¯•å·¥å…·éªŒè¯**

- å·¥å…·è°ƒç”¨é”™è¯¯æ’é™¤æ³¨å…¥å‚æ•°
- æ•æ„Ÿæ•°æ®ä¸æ³„éœ²åˆ° LLM
- å¤æ‚å·¥å…·ä¸è‡ªå®šä¹‰çŠ¶æ€

### 1.6 `test_responses.py` (14 ä¸ªæµ‹è¯•)
**æµ‹è¯•ç»“æ„åŒ–è¾“å‡ºå“åº”ç±»**

- ToolStrategy åŸºæœ¬åˆ›å»º
- å¤š schema
- OutputToolBinding åˆ›å»ºå’Œè§£æ
- è¾¹ç•Œæƒ…å†µ

### 1.7 `test_return_direct_*.py` (6 ä¸ªæµ‹è¯•)
**æµ‹è¯• return_direct å·¥å…·**

- æ—  return_direct å·¥å…·çš„å›¾ç»“æ„
- æœ‰ return_direct å·¥å…·çš„å›¾ç»“æ„
- æ··åˆå·¥å…·çš„å›¾ç»“æ„
- Spec è§„èŒƒæµ‹è¯•

---

## 2. ä¸­é—´ä»¶æ ¸å¿ƒæµ‹è¯• (Middleware Core)

### 2.1 `test_framework.py` (17 ä¸ªæµ‹è¯•)
**ä¸­é—´ä»¶æ¡†æ¶æ ¸å¿ƒ**

```text
æµ‹è¯•å†…å®¹:
â”œâ”€â”€ Agent åŸºæœ¬åŠŸèƒ½
â”‚   â”œâ”€â”€ invoke (sync/async)
â”‚   â”œâ”€â”€ jump_to æµç¨‹æ§åˆ¶
â”‚   â””â”€â”€ å›¾ç»“æ„å¿«ç…§
â”‚
â”œâ”€â”€ Runtime æ³¨å…¥
â”‚   â”œâ”€â”€ ä¸­é—´ä»¶è®¿é—® runtime
â”‚   â”œâ”€â”€ InjectedState åœ¨å·¥å…·ä¸­ä½¿ç”¨
â”‚   â””â”€â”€ jump_to ä¸´æ—¶æ€§éªŒè¯
â”‚
â”œâ”€â”€ åŒæ­¥/å¼‚æ­¥
â”‚   â”œâ”€â”€ çº¯ async ä¸­é—´ä»¶åœ¨ sync invoke æ—¶æŠ¥é”™
â”‚   â”œâ”€â”€ æ··åˆ sync/async ä¸­é—´ä»¶
â”‚   â””â”€â”€ async invoke æµ‹è¯•
â”‚
â””â”€â”€ ç§æœ‰/å…¬å…±çŠ¶æ€
    â””â”€â”€ PrivateStateAttr ä¸æš´éœ²
```

### 2.2 `test_decorators.py` (30 ä¸ªæµ‹è¯•)
**è£…é¥°å™¨æµ‹è¯•**

| è£…é¥°å™¨ | æµ‹è¯•æ•°é‡ | æµ‹è¯•å†…å®¹ |
|--------|---------|---------|
| `@before_model` | 6 | åŸºæœ¬åŠŸèƒ½ã€can_jump_toã€åŒæ­¥/å¼‚æ­¥ |
| `@after_model` | 6 | åŸºæœ¬åŠŸèƒ½ã€can_jump_toã€åŒæ­¥/å¼‚æ­¥ |
| `@before_agent` | 4 | åŸºæœ¬åŠŸèƒ½ã€åŒæ­¥/å¼‚æ­¥ |
| `@after_agent` | 4 | åŸºæœ¬åŠŸèƒ½ã€åŒæ­¥/å¼‚æ­¥ |
| `@wrap_model_call` | 3 | åŸºæœ¬åŠŸèƒ½ã€åŒæ­¥/å¼‚æ­¥ |
| `@dynamic_prompt` | 7 | åŠ¨æ€æç¤ºè¯ã€çŠ¶æ€è®¿é—®ã€åŒæ­¥/å¼‚æ­¥ |

### 2.3 `test_wrap_model_call.py` (æœªè®¡æ•°)
**wrap_model_call é’©å­è¯¦ç»†æµ‹è¯•**

- åŸºæœ¬ä¼ é€’
- ä¿®æ”¹è¯·æ±‚/å“åº”
- é‡è¯•é€»è¾‘
- ç¼“å­˜
- æ¨¡å‹åˆ‡æ¢
- å¤šä¸­é—´ä»¶ç»„åˆ

### 2.4 `test_wrap_tool_call.py` (19 ä¸ªæµ‹è¯•)
**wrap_tool_call é’©å­è¯¦ç»†æµ‹è¯•**

```text
æµ‹è¯•åœºæ™¯:
â”œâ”€â”€ åŸºæœ¬åŠŸèƒ½
â”‚   â”œâ”€â”€ Passthrough
â”‚   â”œâ”€â”€ æ—¥å¿—è®°å½•
â”‚   â””â”€â”€ ä¿®æ”¹å‚æ•°
â”‚
â”œâ”€â”€ è®¿é—®èƒ½åŠ›
â”‚   â”œâ”€â”€ è®¿é—® state
â”‚   â”œâ”€â”€ è®¿é—® runtime
â”‚   â””â”€â”€ è®¿é—® tool_call_id
â”‚
â”œâ”€â”€ é«˜çº§æ¨¡å¼
â”‚   â”œâ”€â”€ é‡è¯•é€»è¾‘
â”‚   â”œâ”€â”€ çŸ­è·¯
â”‚   â”œâ”€â”€ å“åº”ä¿®æ”¹
â”‚   â”œâ”€â”€ ç¼“å­˜æ¨¡å¼
â”‚   â””â”€â”€ ç›‘æ§æ¨¡å¼
â”‚
â””â”€â”€ ç»„åˆ
    â”œâ”€â”€ å¤šä¸­é—´ä»¶ç»„åˆ
    â”œâ”€â”€ ä¸‰å±‚åµŒå¥—
    â”œâ”€â”€ å¤–å±‚æ‹¦æˆªå†…å±‚
    â””â”€â”€ å†…å±‚çŸ­è·¯
```

### 2.5 `test_composition.py` (æœªè¯¦ç»†åˆ—ä¸¾)
**ä¸­é—´ä»¶ç»„åˆæµ‹è¯•**

### 2.6 `test_tools.py` (8 ä¸ªæµ‹è¯•)
**å·¥å…·ç®¡ç†æµ‹è¯•**

- ModelRequest.tools æ˜¯ BaseTool
- ä¸­é—´ä»¶ä¿®æ”¹å·¥å…·
- æœªçŸ¥å·¥å…·æŠ¥é”™
- æ·»åŠ /åˆ é™¤å·¥å…·
- ç©ºå·¥å…·åˆ—è¡¨
- å·¥å…·è·¨ä¸­é—´ä»¶ä¿æŒ

### 2.7 `test_overrides.py` (æµ‹è¯• override æ–¹æ³•)
**æµ‹è¯• ModelRequest/ToolCallRequest çš„ override æ–¹æ³•**

### 2.8 `test_sync_async_wrappers.py`
**åŒæ­¥/å¼‚æ­¥åŒ…è£…å™¨æµ‹è¯•**

### 2.9 `test_diagram.py`
**å›¾å¯è§†åŒ–æµ‹è¯•**

---

## 3. ä¸­é—´ä»¶å®ç°æµ‹è¯• (Middleware Implementations)

### 3.1 `test_model_call_limit.py` (7 ä¸ªæµ‹è¯•)
**æ¨¡å‹è°ƒç”¨é™åˆ¶**

- thread_limit / run_limit
- è¶…é™è¡Œä¸ºï¼ˆend / errorï¼‰
- è®¡æ•°å‡†ç¡®æ€§

### 3.2 `test_tool_call_limit.py` (17 ä¸ªæµ‹è¯•)
**å·¥å…·è°ƒç”¨é™åˆ¶**

- å…¨å±€/ç‰¹å®šå·¥å…·é™åˆ¶
- thread/run çº§åˆ«é™åˆ¶
- exit_behavior: continue / end / error
- å¹¶è¡Œå·¥å…·è°ƒç”¨å¤„ç†
- é”™è¯¯æ¶ˆæ¯æ ¼å¼

### 3.3 `test_model_retry.py` (æµ‹è¯•æ•°é‡æœªåˆ—å‡º)
**æ¨¡å‹é‡è¯•ä¸­é—´ä»¶**

- æŒ‡æ•°é€€é¿
- ç‰¹å®šå¼‚å¸¸é‡è¯•
- æœ€å¤§é‡è¯•æ¬¡æ•°
- è‡ªå®šä¹‰é‡è¯•æ¡ä»¶

### 3.4 `test_tool_retry.py` (31 ä¸ªæµ‹è¯•)
**å·¥å…·é‡è¯•ä¸­é—´ä»¶**

```text
æµ‹è¯•èŒƒå›´:
â”œâ”€â”€ åˆå§‹åŒ–
â”‚   â”œâ”€â”€ é»˜è®¤å‚æ•°
â”‚   â”œâ”€â”€ è‡ªå®šä¹‰å‚æ•°
â”‚   â”œâ”€â”€ å‚æ•°éªŒè¯
â”‚   â””â”€â”€ å·¥å…·ç­›é€‰
â”‚
â”œâ”€â”€ é‡è¯•é€»è¾‘
â”‚   â”œâ”€â”€ å·¥ä½œå·¥å…·æ— éœ€é‡è¯•
â”‚   â”œâ”€â”€ å¤±è´¥å·¥å…·é‡è¯•
â”‚   â”œâ”€â”€ ç‰¹å®šå¼‚å¸¸é‡è¯•
â”‚   â”œâ”€â”€ è‡ªå®šä¹‰å¼‚å¸¸è¿‡æ»¤
â”‚   â””â”€â”€ é›¶é‡è¯•
â”‚
â”œâ”€â”€ é€€é¿ç­–ç•¥
â”‚   â”œâ”€â”€ æŒ‡æ•°é€€é¿
â”‚   â”œâ”€â”€ å¸¸é‡é€€é¿
â”‚   â”œâ”€â”€ æœ€å¤§å»¶è¿Ÿä¸Šé™
â”‚   â””â”€â”€ Jitter å˜åŒ–
â”‚
â”œâ”€â”€ å¤±è´¥å¤„ç†
â”‚   â”œâ”€â”€ è¿”å›æ¶ˆæ¯ï¼ˆcontinueï¼‰
â”‚   â”œâ”€â”€ æŠ›å‡ºå¼‚å¸¸ï¼ˆerrorï¼‰
â”‚   â””â”€â”€ è‡ªå®šä¹‰æ ¼å¼åŒ–
â”‚
â””â”€â”€ å¼‚æ­¥æ”¯æŒ
    â”œâ”€â”€ å¼‚æ­¥å·¥ä½œå·¥å…·
    â”œâ”€â”€ å¼‚æ­¥å¤±è´¥å·¥å…·
    â”œâ”€â”€ å¼‚æ­¥é‡è¯•æˆåŠŸ
    â””â”€â”€ å¼‚æ­¥é€€é¿
```

### 3.5 `test_model_fallback.py` (æµ‹è¯•æ•°é‡æœªåˆ—å‡º)
**æ¨¡å‹é™çº§ä¸­é—´ä»¶**

- ä¸»æ¨¡å‹å¤±è´¥æ—¶åˆ‡æ¢å¤‡ç”¨æ¨¡å‹

### 3.6 `test_summarization.py` (27 ä¸ªæµ‹è¯•)
**å¯¹è¯æ‘˜è¦ä¸­é—´ä»¶**

```text
æµ‹è¯•å†…å®¹:
â”œâ”€â”€ è§¦å‘æ¡ä»¶
â”‚   â”œâ”€â”€ fraction (ä¸Šä¸‹æ–‡ç™¾åˆ†æ¯”)
â”‚   â”œâ”€â”€ tokens (token æ•°é‡)
â”‚   â””â”€â”€ messages (æ¶ˆæ¯æ•°é‡)
â”‚
â”œâ”€â”€ ä¿ç•™ç­–ç•¥
â”‚   â”œâ”€â”€ keep fraction
â”‚   â”œâ”€â”€ keep tokens
â”‚   â””â”€â”€ keep messages
â”‚
â”œâ”€â”€ å·¥å…·å¯¹å®‰å…¨
â”‚   â””â”€â”€ ä¿æŒ AIMessage + ToolMessage æˆå¯¹
â”‚
â”œâ”€â”€ è¾¹ç•Œæƒ…å†µ
â”‚   â”œâ”€â”€ trim_tokens_to_summarize
â”‚   â”œâ”€â”€ å¤šè§¦å‘å™¨
â”‚   â”œâ”€â”€ Profile æ¨æ–­
â”‚   â””â”€â”€ é›¶/è´Ÿ target tokens
â”‚
â””â”€â”€ å¼‚æ­¥æ”¯æŒ
```

### 3.7 `test_context_editing.py` (æµ‹è¯•æ•°é‡æœªåˆ—å‡º)
**ä¸Šä¸‹æ–‡ç¼–è¾‘ä¸­é—´ä»¶**

- æ¸…é™¤æ—§å·¥å…·ç»“æœ
- Token é™åˆ¶
- å ä½ç¬¦æ’å…¥

### 3.8 `test_human_in_the_loop.py` (æµ‹è¯•æ•°é‡æœªåˆ—å‡º)
**äººå·¥å‚ä¸ä¸­é—´ä»¶**

- å·¥å…·æ‰§è¡Œå‰è¯·æ±‚æ‰¹å‡†
- ä¸­æ–­å’Œæ¢å¤

### 3.9 `test_todo.py` (19 ä¸ªæµ‹è¯•)
**å¾…åŠäº‹é¡¹ä¸­é—´ä»¶**

```text
æµ‹è¯•å†…å®¹:
â”œâ”€â”€ åˆå§‹åŒ–
â”‚   â”œâ”€â”€ é»˜è®¤æç¤ºè¯
â”‚   â””â”€â”€ write_todos å·¥å…·
â”‚
â”œâ”€â”€ ç³»ç»Ÿæç¤ºä¿®æ”¹
â”‚   â”œâ”€â”€ æ— ç³»ç»Ÿæç¤ºæ—¶æ·»åŠ 
â”‚   â”œâ”€â”€ å·²æœ‰ç³»ç»Ÿæç¤ºæ—¶è¿½åŠ 
â”‚   â””â”€â”€ è‡ªå®šä¹‰ç³»ç»Ÿæç¤º
â”‚
â”œâ”€â”€ å·¥å…·æ‰§è¡Œ
â”‚   â”œâ”€â”€ write_todos å·¥å…·æ‰§è¡Œ
â”‚   â””â”€â”€ éªŒè¯é”™è¯¯
â”‚
â””â”€â”€ é›†æˆæµ‹è¯•
    â”œâ”€â”€ Agent åˆ›å»º
    â””â”€â”€ å¼‚æ­¥æ”¯æŒ
```

### 3.10 `test_tool_selection.py` (æµ‹è¯•æ•°é‡æœªåˆ—å‡º)
**LLM å·¥å…·é€‰æ‹©ä¸­é—´ä»¶**

- LLM åŠ¨æ€é€‰æ‹©å·¥å…·
- always_include å·¥å…·

### 3.11 `test_tool_emulator.py` (æµ‹è¯•æ•°é‡æœªåˆ—å‡º)
**å·¥å…·æ¨¡æ‹Ÿä¸­é—´ä»¶**

- ä½¿ç”¨ LLM æ¨¡æ‹Ÿå·¥å…·æ‰§è¡Œ
- ç”¨äºæµ‹è¯•å’Œå¼€å‘

### 3.12 `test_shell_tool.py` (28 ä¸ªæµ‹è¯•)
**Shell å·¥å…·ä¸­é—´ä»¶**

```text
æµ‹è¯•èŒƒå›´:
â”œâ”€â”€ å‘½ä»¤æ‰§è¡Œ
â”‚   â”œâ”€â”€ æ‰§è¡Œå‘½ä»¤å¹¶æŒä¹…åŒ–çŠ¶æ€
â”‚   â”œâ”€â”€ Restart é‡ç½®ç¯å¢ƒ
â”‚   â””â”€â”€ Timeout å¤„ç†
â”‚
â”œâ”€â”€ è¾“å‡ºå¤„ç†
â”‚   â”œâ”€â”€ æˆªæ–­æŒ‡ç¤ºå™¨
â”‚   â”œâ”€â”€ æŒ‰å­—èŠ‚æˆªæ–­
â”‚   â”œâ”€â”€ ç©ºè¾“å‡ºå¤„ç†
â”‚   â””â”€â”€ stderr æ ‡ç­¾
â”‚
â”œâ”€â”€ å®‰å…¨
â”‚   â”œâ”€â”€ Redaction policy
â”‚   â””â”€â”€ Exit code å¤„ç†
â”‚
â”œâ”€â”€ ç”Ÿå‘½å‘¨æœŸ
â”‚   â”œâ”€â”€ Startup å‘½ä»¤
â”‚   â”œâ”€â”€ Shutdown å‘½ä»¤
â”‚   â””â”€â”€ èµ„æºæ¸…ç†
â”‚
â””â”€â”€ çŠ¶æ€ç®¡ç†
    â”œâ”€â”€ Session èµ„æº
    â”œâ”€â”€ ä¸­æ–­åæ¢å¤
    â””â”€â”€ èµ„æºå¤ç”¨
```

### 3.13 `test_shell_execution_policies.py` (æµ‹è¯•æ•°é‡æœªåˆ—å‡º)
**Shell æ‰§è¡Œç­–ç•¥æµ‹è¯•**

- Host Policy (èµ„æºé™åˆ¶ã€prlimit)
- Codex Policy (ä½¿ç”¨ Codex CLI)
- Docker Policy (Docker å®¹å™¨æ‰§è¡Œ)

### 3.14 `test_pii.py` (æµ‹è¯•æ•°é‡æœªåˆ—å‡º)
**PII è„±æ•ä¸­é—´ä»¶**

- æ•æ„Ÿä¿¡æ¯æ£€æµ‹
- è‡ªåŠ¨è„±æ•

### 3.15 `test_file_search.py` (æµ‹è¯•æ•°é‡æœªåˆ—å‡º)
**æ–‡ä»¶æœç´¢ä¸­é—´ä»¶**

### 3.16 `test_structured_output_retry.py` (6 ä¸ªæµ‹è¯•)
**ç»“æ„åŒ–è¾“å‡ºé‡è¯•**

- é¦–æ¬¡å°è¯•æ— æ•ˆ
- è¶…è¿‡æœ€å¤§é‡è¯•
- é¦–æ¬¡æˆåŠŸ
- éªŒè¯é”™è¯¯
- é›¶é‡è¯•
- ä¿æŒæ¶ˆæ¯

---

## 4. è¾…åŠ©æµ‹è¯•

### 4.1 `model.py`
**FakeToolCallingModel - æ¨¡æ‹Ÿ LLM**

```python
class FakeToolCallingModel(BaseChatModel):
    """ç”¨äºæµ‹è¯•çš„å‡æ¨¡å‹ï¼Œå¯é¢„è®¾ tool_calls"""

    # é¢„è®¾çš„å·¥å…·è°ƒç”¨åºåˆ—
    tool_calls: list[list[dict]]
    # é¢„è®¾çš„å“åº”å†…å®¹
    content: str = ""
```

### 4.2 è¾…åŠ©å·¥å…·

| æ–‡ä»¶ | ç”¨é€” |
|-----|------|
| `utils.py` | æµ‹è¯•è¾…åŠ©å‡½æ•° |
| `messages.py` | æ¶ˆæ¯åŒ¹é…å™¨ |
| `any_str.py` | å­—ç¬¦ä¸²åŒ¹é…å™¨ |
| `memory_assert.py` | å†…å­˜æ–­è¨€è¾…åŠ© |
| `conftest.py` | pytest é…ç½®å’Œ fixtures |
| `conftest_checkpointer.py` | Checkpointer fixtures |
| `conftest_store.py` | Store fixtures |

---

## 5. è§„èŒƒæµ‹è¯• (Specifications)

### 5.1 `specifications/responses.json`
**ç»“æ„åŒ–è¾“å‡ºè§„èŒƒæ•°æ®**

### 5.2 `specifications/return_direct.json`
**return_direct è§„èŒƒæ•°æ®**

---

## 6. å¿«ç…§æµ‹è¯• (__snapshots__)

ä½¿ç”¨ Syrupy è¿›è¡Œå¿«ç…§æµ‹è¯•ï¼ŒéªŒè¯ï¼š
- å›¾ç»“æ„
- ä¸­é—´ä»¶å›¾
- è£…é¥°å™¨è¡Œä¸º

---

## æ€»ç»“ï¼šæµ‹è¯•è¦†ç›–ç‡

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              æµ‹è¯•è¦†ç›–å…¨æ™¯å›¾                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ ¸å¿ƒåŠŸèƒ½å±‚
â”œâ”€â”€ âœ… ç»“æ„åŒ–è¾“å‡ºï¼ˆToolStrategy/ProviderStrategyï¼‰
â”œâ”€â”€ âœ… ç³»ç»Ÿæ¶ˆæ¯å¤„ç†ï¼ˆstring/SystemMessage/åŠ¨æ€ç”Ÿæˆï¼‰
â”œâ”€â”€ âœ… è¿è¡Œæ—¶æ³¨å…¥ï¼ˆInjectedState/InjectedStore/ToolRuntimeï¼‰
â”œâ”€â”€ âœ… è‡ªå®šä¹‰çŠ¶æ€ schema
â”œâ”€â”€ âœ… å·¥å…·éªŒè¯å’Œé”™è¯¯å¤„ç†
â””â”€â”€ âœ… return_direct å·¥å…·

ä¸­é—´ä»¶æ ¸å¿ƒå±‚
â”œâ”€â”€ âœ… ç”Ÿå‘½å‘¨æœŸé’©å­ï¼ˆbefore_agent/model, after_agent/modelï¼‰
â”œâ”€â”€ âœ… æ‹¦æˆªå™¨é’©å­ï¼ˆwrap_model_call, wrap_tool_callï¼‰
â”œâ”€â”€ âœ… è£…é¥°å™¨ï¼ˆ7 ç§è£…é¥°å™¨ Ã— åŒæ­¥/å¼‚æ­¥ï¼‰
â”œâ”€â”€ âœ… ä¸­é—´ä»¶ç»„åˆï¼ˆåµŒå¥—ã€é“¾å¼ã€ä¼˜å…ˆçº§ï¼‰
â”œâ”€â”€ âœ… Runtime/State è®¿é—®
â””â”€â”€ âœ… åŒæ­¥/å¼‚æ­¥æ‰§è¡Œè·¯å¾„

ä¸­é—´ä»¶å®ç°å±‚
â”œâ”€â”€ âœ… é™åˆ¶ç±»ï¼ˆModelCallLimit, ToolCallLimitï¼‰
â”œâ”€â”€ âœ… é‡è¯•ç±»ï¼ˆModelRetry, ToolRetry, StructuredOutputRetryï¼‰
â”œâ”€â”€ âœ… é™çº§ç±»ï¼ˆModelFallbackï¼‰
â”œâ”€â”€ âœ… ä¸Šä¸‹æ–‡ç±»ï¼ˆSummarization, ContextEditingï¼‰
â”œâ”€â”€ âœ… äº¤äº’ç±»ï¼ˆHumanInTheLoop, TodoListï¼‰
â”œâ”€â”€ âœ… æ‰§è¡Œç±»ï¼ˆShellTool + 3ç§ç­–ç•¥ï¼‰
â”œâ”€â”€ âœ… é€‰æ‹©ç±»ï¼ˆToolSelection, ToolEmulatorï¼‰
â””â”€â”€ âœ… å®‰å…¨ç±»ï¼ˆPII redaction, FileSearchï¼‰

æ¯ä¸ªåŠŸèƒ½éƒ½æœ‰:
- åŸºæœ¬åŠŸèƒ½æµ‹è¯•
- è¾¹ç•Œæƒ…å†µæµ‹è¯•
- é”™è¯¯å¤„ç†æµ‹è¯•
- åŒæ­¥/å¼‚æ­¥æµ‹è¯•
- é›†æˆæµ‹è¯•
```

**æµ‹è¯•è´¨é‡ç‰¹ç‚¹**ï¼š
1. **å…¨é¢æ€§**: è¦†ç›–æ‰€æœ‰å…¬å¼€ API
2. **æ·±åº¦æ€§**: æµ‹è¯•è¾¹ç•Œæƒ…å†µå’Œé”™è¯¯è·¯å¾„
3. **çœŸå®æ€§**: ä½¿ç”¨å®é™…çš„ä½¿ç”¨åœºæ™¯
4. **å¯ç»´æŠ¤æ€§**: æ¸…æ™°çš„æ–‡æ¡£å­—ç¬¦ä¸²å’Œåˆ†ç±»ç»„ç»‡
5. **å›å½’ä¿æŠ¤**: å¿«ç…§æµ‹è¯•ä¿æŠ¤å›¾ç»“æ„å˜åŒ–
